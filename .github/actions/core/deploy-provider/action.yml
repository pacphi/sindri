name: Deploy Provider
description: Deploy Sindri to any supported provider (unified deployment action)

inputs:
  provider:
    description: Provider to deploy to (docker, fly, devpod-aws, devpod-gcp, devpod-azure, devpod-do, devpod-k8s)
    required: true
  image:
    description: Docker image to use
    required: false
    default: "sindri:latest"
  image-artifact:
    description: Name of image artifact to download
    required: false
    default: ""
  config-path:
    description: Path to sindri.yaml configuration
    required: false
    default: ""
  extension-profile:
    description: Extension profile to deploy with (determines resource requirements)
    required: false
    default: "minimal"
  test-level:
    description: Test level being run (affects resource allocation)
    required: false
    default: "profile"

outputs:
  target-id:
    description: Target identifier (container name, app name, or workspace ID)
    value: ${{ steps.deploy.outputs.target-id }}

runs:
  using: composite
  steps:
    - name: Determine config path
      id: config
      shell: bash
      run: |
        if [[ -n "${{ inputs.config-path }}" ]]; then
          CONFIG="${{ inputs.config-path }}"
        else
          # For extension-level tests, use fullstack config for more resources
          # This ensures we have enough headroom for heavy extensions (guacamole, xfce, etc.)
          if [[ "${{ inputs.test-level }}" == "extension" ]]; then
            PROFILE="fullstack"
            echo "::notice::Using fullstack config for extension-level tests (ensures sufficient resources)"
          else
            PROFILE="${{ inputs.extension-profile }}"
          fi

          # Map provider + profile to example config
          case "${{ inputs.provider }}" in
            docker)
              CONFIG="examples/docker/${PROFILE}.sindri.yaml"
              ;;
            fly)
              CONFIG="examples/fly/${PROFILE}.sindri.yaml"
              ;;
            devpod-aws)
              CONFIG="examples/devpod/aws/${PROFILE}.sindri.yaml"
              ;;
            devpod-gcp)
              CONFIG="examples/devpod/gcp/${PROFILE}.sindri.yaml"
              ;;
            devpod-azure)
              CONFIG="examples/devpod/azure/${PROFILE}.sindri.yaml"
              ;;
            devpod-do)
              CONFIG="examples/devpod/digitalocean/${PROFILE}.sindri.yaml"
              ;;
            devpod-k8s|kubernetes)
              CONFIG="examples/devpod/kubernetes/${PROFILE}.sindri.yaml"
              ;;
            *)
              echo "::error::Unknown provider: ${{ inputs.provider }}"
              exit 1
              ;;
          esac

          # Fallback to minimal if profile-specific config doesn't exist
          if [[ ! -f "$CONFIG" ]]; then
            echo "::warning::Profile config $CONFIG not found, falling back to minimal"
            case "${{ inputs.provider }}" in
              docker) CONFIG="examples/docker/minimal.sindri.yaml" ;;
              fly) CONFIG="examples/fly/minimal.sindri.yaml" ;;
              devpod-aws) CONFIG="examples/devpod/aws/minimal.sindri.yaml" ;;
              devpod-gcp) CONFIG="examples/devpod/gcp/minimal.sindri.yaml" ;;
              devpod-azure) CONFIG="examples/devpod/azure/minimal.sindri.yaml" ;;
              devpod-do) CONFIG="examples/devpod/digitalocean/minimal.sindri.yaml" ;;
              devpod-k8s|kubernetes) CONFIG="examples/devpod/kubernetes/minimal.sindri.yaml" ;;
            esac
          fi
        fi

        echo "config=$CONFIG" >> $GITHUB_OUTPUT
        echo "::notice title=Config::Using $CONFIG (test-level: ${{ inputs.test-level }}, profile: ${{ inputs.extension-profile }})"

    - name: Download image artifact (if specified)
      if: inputs.image-artifact != ''
      uses: actions/download-artifact@v6
      with:
        name: ${{ inputs.image-artifact }}

    - name: Load Docker image from artifact
      if: inputs.image-artifact != ''
      shell: bash
      run: |
        if [[ -f "sindri-image.tar.gz" ]]; then
          echo "Loading Docker image from artifact..."
          gunzip -c sindri-image.tar.gz | docker load
          echo "✓ Image loaded: ${{ inputs.image }}"
        fi

    - name: Install flyctl CLI
      if: inputs.provider == 'fly'
      shell: bash
      run: |
        echo "Installing flyctl CLI..."
        curl -L https://fly.io/install.sh | sh
        echo "$HOME/.fly/bin" >> $GITHUB_PATH
        export PATH="$HOME/.fly/bin:$PATH"
        flyctl version
        echo "✓ flyctl installed"

    - name: Setup kind cluster for devpod-k8s
      id: kind-setup
      if: inputs.provider == 'devpod-k8s'
      shell: bash
      run: |
        echo "Setting up kind cluster with local registry for kubernetes testing..."

        CLUSTER_NAME="sindri-ci"
        REG_NAME="local-registry-${CLUSTER_NAME}"
        REG_PORT="5001"

        # Install kind if not present (use version compatible with registry config)
        KIND_VERSION="v0.27.0"
        CURRENT_KIND_VERSION=$(kind version 2>/dev/null | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' || echo "none")
        if [[ "$CURRENT_KIND_VERSION" != "$KIND_VERSION" ]]; then
          echo "Installing kind ${KIND_VERSION} (current: ${CURRENT_KIND_VERSION})..."
          curl -Lo ./kind "https://github.com/kubernetes-sigs/kind/releases/download/${KIND_VERSION}/kind-linux-amd64"
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
        fi
        kind version

        # Create local registry
        if [ "$(docker inspect -f '{{.State.Running}}' "${REG_NAME}" 2>/dev/null || true)" != 'true' ]; then
          echo "Creating local registry: ${REG_NAME} on port ${REG_PORT}"
          docker run -d --restart=always -p "127.0.0.1:${REG_PORT}:5000" --network bridge --name "${REG_NAME}" registry:2
        fi

        # Create kind config with registry support
        cat > /tmp/kind-config.yaml << 'KINDEOF'
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        containerdConfigPatches:
        - |-
          [plugins."io.containerd.grpc.v1.cri".registry]
            config_path = "/etc/containerd/certs.d"
        nodes:
        - role: control-plane
        KINDEOF
        sed -i 's/^        //' /tmp/kind-config.yaml

        # Create kind cluster
        echo "Creating kind cluster: ${CLUSTER_NAME}"
        kind delete cluster --name "$CLUSTER_NAME" 2>/dev/null || true
        kind create cluster --name "$CLUSTER_NAME" --config /tmp/kind-config.yaml --wait 120s

        # Connect registry to kind network
        if [ "$(docker inspect -f='{{json .NetworkSettings.Networks.kind}}' "${REG_NAME}")" = 'null' ]; then
          docker network connect "kind" "${REG_NAME}" || true
        fi

        # Configure containerd to use the local registry
        REGISTRY_DIR="/etc/containerd/certs.d/localhost:${REG_PORT}"
        for node in $(kind get nodes --name "$CLUSTER_NAME"); do
          echo "Configuring registry on node: ${node}"
          docker exec "${node}" mkdir -p "${REGISTRY_DIR}"
          docker exec "${node}" bash -c "echo '[host.\"http://${REG_NAME}:5000\"]' > ${REGISTRY_DIR}/hosts.toml && echo '  capabilities = [\"pull\", \"resolve\", \"push\"]' >> ${REGISTRY_DIR}/hosts.toml"
        done

        # Tag and push image to local registry
        LOCAL_IMAGE="localhost:${REG_PORT}/sindri:latest"
        echo "Pushing image to local registry: ${LOCAL_IMAGE}"
        docker tag "${{ inputs.image }}" "${LOCAL_IMAGE}"
        docker push "${LOCAL_IMAGE}"

        # Set up kubeconfig
        mkdir -p "$HOME/.kube"
        kind get kubeconfig --name "$CLUSTER_NAME" > "$HOME/.kube/config"
        chmod 600 "$HOME/.kube/config"

        # Wait for cluster ready
        kubectl wait --for=condition=Ready nodes --all --timeout=120s

        echo "registry-url=localhost:${REG_PORT}" >> $GITHUB_OUTPUT
        echo "✓ Kind cluster ready with local registry at localhost:${REG_PORT}"

    - name: Install DevPod CLI
      if: startsWith(inputs.provider, 'devpod-')
      shell: bash
      run: |
        echo "Installing DevPod CLI..."
        curl -L -o devpod "https://github.com/loft-sh/devpod/releases/latest/download/devpod-linux-amd64"
        chmod +x devpod
        sudo mv devpod /usr/local/bin/devpod
        devpod version
        echo "✓ DevPod installed"

    - name: Deploy
      id: deploy
      shell: bash
      run: |
        PROVIDER="${{ inputs.provider }}"
        RUN_ID="${{ github.run_id }}"
        RUN_NUMBER="${{ github.run_number }}"
        CONFIG="${{ steps.config.outputs.config }}"

        echo "Deploying to $PROVIDER..."

        case "$PROVIDER" in
          docker)
            # Get container name from config (needed for pre-cleanup)
            TARGET_ID=$(yq '.name' "$CONFIG" 2>/dev/null || echo "sindri-test")

            # PRE-CLEANUP: Remove stale resources from previous runs
            echo "Pre-cleanup: Ensuring clean slate for Docker"
            docker rm -f "$TARGET_ID" 2>/dev/null || true
            docker volume ls -q --filter "name=${TARGET_ID}_home" | xargs -r docker volume rm 2>/dev/null || true
            if [[ -f docker-compose.yml ]]; then
              docker compose -f docker-compose.yml down -v 2>/dev/null || true
            fi

            # Tag pre-built image as sindri:latest (what docker-adapter expects)
            if docker image inspect "${{ inputs.image }}" >/dev/null 2>&1; then
              echo "Tagging pre-built image as sindri:latest"
              docker tag "${{ inputs.image }}" sindri:latest
            fi

            # Deploy using docker-adapter with --ci-mode (forces autoInstall=false for clean tests)
            ./deploy/adapters/docker-adapter.sh deploy --skip-build --ci-mode "$CONFIG"

            # Fix permissions on volume
            docker exec --user root "$TARGET_ID" chown -R developer:developer /alt/home/developer 2>/dev/null || true

            # Verify container is ready
            docker exec "$TARGET_ID" bash -c 'echo "Container ready"'

            echo "✓ Deployed to Docker: $TARGET_ID"
            ;;

          fly)
            APP_NAME="sindri-ci-${RUN_ID}-${RUN_NUMBER}"

            # Deploy using fly adapter (CI mode, config as positional arg)
            # Pass --app-name to override the name from sindri.yaml with CI-specific name
            ./deploy/adapters/fly-adapter.sh deploy --ci-mode --app-name "$APP_NAME" "$CONFIG"

            TARGET_ID="$APP_NAME"
            echo "✓ Deployed to Fly.io: $TARGET_ID"
            ;;

          devpod-*)
            BACKEND="${PROVIDER#devpod-}"
            WORKSPACE_ID="sindri-${RUN_ID}"

            # Build extra flags for specific providers
            EXTRA_FLAGS=""
            if [[ "$PROVIDER" == "devpod-k8s" ]]; then
              # For k8s, use the image from local registry (pushed in kind-setup step)
              REGISTRY_URL="${{ steps.kind-setup.outputs.registry-url }}"
              EXTRA_FLAGS="--skip-build --image ${REGISTRY_URL}/sindri:latest"
            fi

            # Deploy using devpod adapter with --ci-mode (forces autoInstall=false)
            ./deploy/adapters/devpod-adapter.sh deploy --ci-mode $EXTRA_FLAGS "$CONFIG"

            TARGET_ID="$WORKSPACE_ID"
            echo "✓ Deployed to DevPod ($BACKEND): $TARGET_ID"
            ;;

          *)
            echo "::error::Unsupported provider: $PROVIDER"
            exit 1
            ;;
        esac

        echo "target-id=$TARGET_ID" >> $GITHUB_OUTPUT
        echo "::notice title=Deployed::Target ID: $TARGET_ID"
