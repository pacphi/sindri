name: Deploy DevPod Workspace
description: Deploys a DevPod workspace to the configured provider

inputs:
  workspace-id:
    description: Unique identifier for the workspace
    required: true
  provider-id:
    description: Provider ID to use for deployment
    required: true
  source:
    description: Source repository or path for the workspace
    required: false
    default: "."
  devcontainer-path:
    description: Path to devcontainer.json file
    required: false
    default: ".devcontainer/devcontainer.json"
  ide:
    description: IDE to use (vscode, openvscode, none)
    required: false
    default: "none"
  prebuild-repository:
    description: Container registry for prebuild images
    required: false
    default: ""
  dotfiles-url:
    description: URL to dotfiles repository
    required: false
    default: ""
  dotfiles-script:
    description: Script to run for dotfiles installation
    required: false
    default: ""
  env-vars:
    description: JSON object with environment variables
    required: false
    default: "{}"
  git-credentials:
    description: Inject git credentials into workspace
    required: false
    default: "true"
  docker-credentials:
    description: Inject docker credentials into workspace
    required: false
    default: "true"
  image:
    description: Pre-built container image to use (required for Kubernetes provider)
    required: false
    default: "sindri:latest"
  force-image:
    description: Force use of image instead of dockerFile in devcontainer.json
    required: false
    default: "false"
  wait-for-ready:
    description: Wait for workspace to be ready
    required: false
    default: "true"
  timeout-seconds:
    description: Timeout for workspace readiness
    required: false
    default: "600"

outputs:
  workspace-status:
    description: Workspace deployment status
    value: ${{ steps.deploy.outputs.status }}
  workspace-url:
    description: URL to access the workspace (if applicable)
    value: ${{ steps.deploy.outputs.url }}
  provider-name:
    description: Provider name used for the workspace
    value: ${{ steps.deploy.outputs.provider-name }}
  ssh-command:
    description: SSH command to connect to workspace
    value: ${{ steps.connect.outputs.ssh-command }}

runs:
  using: composite
  steps:
    - name: Prepare devcontainer configuration
      shell: bash
      run: |
        echo "::group::Preparing devcontainer configuration"

        # Ensure devcontainer directory exists
        mkdir -p .devcontainer

        DEVCONTAINER_PATH="${{ inputs.devcontainer-path }}"
        FORCE_IMAGE="${{ inputs.force-image }}"
        IMAGE="${{ inputs.image }}"
        PROVIDER_ID="${{ inputs.provider-id }}"

        # Check if this is a Kubernetes provider (requires pre-built image)
        IS_K8S_PROVIDER="false"
        if [[ "$PROVIDER_ID" == *"k8s"* ]] || [[ "$PROVIDER_ID" == *"kubernetes"* ]]; then
          IS_K8S_PROVIDER="true"
          echo "Kubernetes provider detected - will use pre-built image"
        fi

        # Determine if we need to generate a new devcontainer.json
        GENERATE_NEW="false"

        # Case 1: No devcontainer.json exists at all (common in CI where .devcontainer/ is gitignored)
        if [[ ! -f "$DEVCONTAINER_PATH" ]]; then
          GENERATE_NEW="true"
          echo "No devcontainer.json found at $DEVCONTAINER_PATH - will generate one"
        fi

        # Case 2: Kubernetes provider with existing devcontainer.json using dockerFile
        # (K8s can't build from Dockerfile, needs pre-built image)
        if [[ "$IS_K8S_PROVIDER" == "true" ]] && [[ -f "$DEVCONTAINER_PATH" ]]; then
          if grep -q '"dockerFile"' "$DEVCONTAINER_PATH" || grep -q '"build"' "$DEVCONTAINER_PATH"; then
            GENERATE_NEW="true"
            echo "Existing devcontainer.json uses dockerFile/build - Kubernetes requires image"
            # Backup original
            cp "$DEVCONTAINER_PATH" "${DEVCONTAINER_PATH}.original"
          fi
        fi

        # Case 3: Force image mode enabled
        if [[ "$FORCE_IMAGE" == "true" ]] && [[ -f "$DEVCONTAINER_PATH" ]]; then
          if grep -q '"dockerFile"' "$DEVCONTAINER_PATH" || grep -q '"build"' "$DEVCONTAINER_PATH"; then
            GENERATE_NEW="true"
            echo "Force image mode - replacing dockerFile/build with image reference"
            cp "$DEVCONTAINER_PATH" "${DEVCONTAINER_PATH}.original"
          fi
        fi

        # Generate CI-compatible devcontainer.json if needed
        if [[ "$GENERATE_NEW" == "true" ]]; then
          echo "Generating CI-compatible devcontainer.json with image: $IMAGE"

          # Extract name from sindri.yaml or use default
          if [[ -f "sindri.yaml" ]]; then
            NAME=$(yq -r '.name // "sindri-workspace"' sindri.yaml)
            PROFILE=$(yq -r '.extensions.profile // "minimal"' sindri.yaml)
          else
            NAME="sindri-workspace"
            PROFILE="minimal"
          fi

          # Generate devcontainer.json with image reference (not dockerFile)
          # Use jq to construct valid JSON
          # IMPORTANT: HOME and MISE_* env vars are critical for extension-manager to work
          jq -n \
            --arg name "$NAME" \
            --arg image "$IMAGE" \
            --arg profile "$PROFILE" \
            '{
              name: $name,
              image: $image,
              workspaceFolder: "/alt/home/developer/workspace",
              workspaceMount: "source=${localWorkspaceFolder},target=/alt/home/developer/workspace,type=bind",
              containerEnv: {
                HOME: "/alt/home/developer",
                ALT_HOME: "/alt/home/developer",
                WORKSPACE: "/alt/home/developer/workspace",
                MISE_DATA_DIR: "/alt/home/developer/.local/share/mise",
                MISE_CONFIG_DIR: "/alt/home/developer/.config/mise",
                MISE_CACHE_DIR: "/alt/home/developer/.cache/mise",
                MISE_STATE_DIR: "/alt/home/developer/.local/state/mise",
                CI_MODE: "true"
              },
              customizations: {
                vscode: {
                  extensions: [
                    "ms-vscode.vscode-typescript-next",
                    "dbaeumer.vscode-eslint",
                    "esbenp.prettier-vscode"
                  ],
                  settings: {
                    "terminal.integrated.defaultProfile.linux": "bash"
                  }
                }
              },
              postCreateCommand: "/docker/cli/extension-manager install-profile \($profile)",
              remoteUser: "developer",
              containerUser: "developer"
            }' > "$DEVCONTAINER_PATH"

          echo "Generated devcontainer.json:"
          cat "$DEVCONTAINER_PATH"
        else
          echo "Using existing devcontainer.json at $DEVCONTAINER_PATH"
          if [[ -f "$DEVCONTAINER_PATH" ]]; then
            cat "$DEVCONTAINER_PATH"
          fi
        fi

        echo "::endgroup::"

    - name: Deploy workspace
      id: deploy
      shell: bash
      run: |
        echo "::group::Deploying DevPod workspace"

        WORKSPACE_ID="${{ inputs.workspace-id }}"
        PROVIDER_ID="${{ inputs.provider-id }}"
        SOURCE="${{ inputs.source }}"
        IDE="${{ inputs.ide }}"

        # Build devpod up command
        CMD="devpod up"
        CMD="$CMD --id $WORKSPACE_ID"
        CMD="$CMD --provider $PROVIDER_ID"
        CMD="$CMD --ide $IDE"

        # Add optional parameters
        if [[ -f "${{ inputs.devcontainer-path }}" ]]; then
          CMD="$CMD --devcontainer-path ${{ inputs.devcontainer-path }}"
        fi

        if [[ -n "${{ inputs.prebuild-repository }}" ]]; then
          CMD="$CMD --prebuild-repository ${{ inputs.prebuild-repository }}"
        fi

        if [[ -n "${{ inputs.dotfiles-url }}" ]]; then
          CMD="$CMD --dotfiles ${{ inputs.dotfiles-url }}"
          if [[ -n "${{ inputs.dotfiles-script }}" ]]; then
            CMD="$CMD --dotfiles-script ${{ inputs.dotfiles-script }}"
          fi
        fi

        if [[ "${{ inputs.git-credentials }}" == "false" ]]; then
          CMD="$CMD --no-inject-git-credentials"
        fi

        if [[ "${{ inputs.docker-credentials }}" == "false" ]]; then
          CMD="$CMD --no-inject-docker-credentials"
        fi

        # Add environment variables
        ENV_VARS='${{ inputs.env-vars }}'
        if [[ "$ENV_VARS" != "{}" ]]; then
          echo "$ENV_VARS" | jq -r 'to_entries[] | "--env \(.key)=\(.value)"' | \
          while read -r env; do
            CMD="$CMD $env"
          done
        fi

        # Add source at the end
        CMD="$CMD $SOURCE"

        # Execute deployment
        echo "Running: $CMD"
        eval "$CMD"

        # Get workspace status (DevPod uses lowercase 'state' in JSON output)
        STATUS=$(devpod status "$WORKSPACE_ID" --output json | jq -r '.state' || echo "unknown")

        # Get provider name (DevPod uses lowercase 'provider' in JSON output)
        PROVIDER_NAME=$(devpod status "$WORKSPACE_ID" --output json | jq -r '.provider' || echo "")

        echo "status=$STATUS" >> $GITHUB_OUTPUT
        echo "provider-name=$PROVIDER_NAME" >> $GITHUB_OUTPUT

        echo "::endgroup::"

    - name: Wait for workspace ready
      if: inputs.wait-for-ready == 'true'
      shell: bash
      run: |
        echo "::group::Waiting for workspace to be ready"

        WORKSPACE_ID="${{ inputs.workspace-id }}"
        TIMEOUT="${{ inputs.timeout-seconds }}"
        START_TIME=$(date +%s)

        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))

          if [[ $ELAPSED -gt $TIMEOUT ]]; then
            echo "❌ Timeout waiting for workspace to be ready"
            exit 1
          fi

          STATUS=$(devpod status "$WORKSPACE_ID" --output json | jq -r '.state' || echo "unknown")
          # Normalize to lowercase for comparison
          STATUS_LOWER=$(echo "$STATUS" | tr '[:upper:]' '[:lower:]')
          echo "Status: $STATUS (elapsed: ${ELAPSED}s)"

          # DevPod state values may vary in case - compare case-insensitively
          if [[ "$STATUS_LOWER" == "running" ]]; then
            echo "✅ Workspace is ready"
            break
          elif [[ "$STATUS_LOWER" == "error" ]]; then
            echo "❌ Workspace deployment failed"
            devpod logs "$WORKSPACE_ID" || true
            exit 1
          fi

          sleep 10
        done

        echo "::endgroup::"

    - name: Get connection information
      id: connect
      shell: bash
      run: |
        echo "::group::Getting connection information"

        WORKSPACE_ID="${{ inputs.workspace-id }}"

        # Get SSH command
        SSH_CMD=$(devpod ssh "$WORKSPACE_ID" --print-command 2>/dev/null || echo "")

        if [[ -n "$SSH_CMD" ]]; then
          echo "SSH Command: $SSH_CMD"
          echo "ssh-command=$SSH_CMD" >> $GITHUB_OUTPUT
        fi

        # Get workspace info
        devpod list --output json | jq ".[] | select(.id == \"$WORKSPACE_ID\")" || true

        echo "::endgroup::"
