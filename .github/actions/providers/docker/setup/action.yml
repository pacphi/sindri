name: Setup Docker Provider
description: Sets up Docker environment for Sindri deployment

inputs:
  install-compose:
    description: Whether to install Docker Compose
    required: false
    default: 'true'
  compose-version:
    description: Docker Compose version to install
    required: false
    default: 'latest'
  buildx-version:
    description: Docker Buildx version to use
    required: false
    default: 'latest'
  registry-auth:
    description: JSON object with registry authentication details
    required: false
    default: ''

outputs:
  docker-version:
    description: Installed Docker version
    value: ${{ steps.versions.outputs.docker }}
  compose-version:
    description: Installed Docker Compose version
    value: ${{ steps.versions.outputs.compose }}
  buildx-version:
    description: Installed Buildx version
    value: ${{ steps.versions.outputs.buildx }}

runs:
  using: composite
  steps:
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        version: ${{ inputs.buildx-version }}
        install: true

    - name: Install Docker Compose
      if: inputs.install-compose == 'true'
      shell: bash
      run: |
        echo "::group::Installing Docker Compose"

        if [[ "${{ inputs.compose-version }}" == "latest" ]]; then
          COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | jq -r .tag_name)
        else
          COMPOSE_VERSION="${{ inputs.compose-version }}"
        fi

        # Download and install Docker Compose
        sudo curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" \
          -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose

        # Verify installation
        docker-compose --version

        echo "::endgroup::"

    - name: Configure registry authentication
      if: inputs.registry-auth != ''
      shell: bash
      run: |
        echo "::group::Configuring registry authentication"

        # Parse registry auth JSON
        AUTH='${{ inputs.registry-auth }}'

        # Login to each registry
        echo "$AUTH" | jq -r 'to_entries[] | "\(.key) \(.value.username) \(.value.password)"' | \
        while read -r registry username password; do
          echo "Logging into $registry"
          echo "$password" | docker login "$registry" -u "$username" --password-stdin
        done

        echo "::endgroup::"

    - name: Get versions
      id: versions
      shell: bash
      run: |
        # Get Docker version
        DOCKER_VERSION=$(docker --version | awk '{print $3}' | sed 's/,$//')
        echo "docker=$DOCKER_VERSION" >> $GITHUB_OUTPUT

        # Get Docker Compose version
        if command -v docker-compose &> /dev/null; then
          COMPOSE_VERSION=$(docker-compose --version | awk '{print $4}' | sed 's/,$//')
          echo "compose=$COMPOSE_VERSION" >> $GITHUB_OUTPUT
        fi

        # Get Buildx version
        BUILDX_VERSION=$(docker buildx version | awk '{print $2}')
        echo "buildx=$BUILDX_VERSION" >> $GITHUB_OUTPUT

        echo "Docker: $DOCKER_VERSION"
        echo "Compose: ${COMPOSE_VERSION:-not installed}"
        echo "Buildx: $BUILDX_VERSION"
