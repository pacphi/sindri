name: Setup Docker Provider
description: Sets up Docker environment for Sindri deployment

inputs:
  install-compose:
    description: Whether to install Docker Compose
    required: false
    default: "true"
  compose-version:
    description: Docker Compose version to install
    required: false
    default: "latest"
  buildx-version:
    description: Docker Buildx version to use
    required: false
    default: "latest"
  registry-auth:
    description: JSON object with registry authentication details
    required: false
    default: ""

outputs:
  docker-version:
    description: Installed Docker version
    value: ${{ steps.versions.outputs.docker }}
  compose-version:
    description: Installed Docker Compose version
    value: ${{ steps.versions.outputs.compose }}
  buildx-version:
    description: Installed Buildx version
    value: ${{ steps.versions.outputs.buildx }}

runs:
  using: composite
  steps:
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        version: ${{ inputs.buildx-version }}
        install: true

    - name: Verify Docker Compose
      if: inputs.install-compose == 'true'
      shell: bash
      run: |
        echo "::group::Verifying Docker Compose"

        # Docker Compose V2 is included as a plugin in modern Docker
        # Verify it's available
        docker compose version

        echo "::endgroup::"

    - name: Configure registry authentication
      if: inputs.registry-auth != ''
      shell: bash
      run: |
        echo "::group::Configuring registry authentication"

        # Parse registry auth JSON
        AUTH='${{ inputs.registry-auth }}'

        # Login to each registry
        echo "$AUTH" | jq -r 'to_entries[] | "\(.key) \(.value.username) \(.value.password)"' | \
        while read -r registry username password; do
          echo "Logging into $registry"
          echo "$password" | docker login "$registry" -u "$username" --password-stdin
        done

        echo "::endgroup::"

    - name: Get versions
      id: versions
      shell: bash
      run: |
        # Get Docker version
        DOCKER_VERSION=$(docker --version | awk '{print $3}' | sed 's/,$//')
        echo "docker=$DOCKER_VERSION" >> $GITHUB_OUTPUT

        # Get Docker Compose version (V2 plugin)
        if docker compose version &> /dev/null; then
          COMPOSE_VERSION=$(docker compose version --short)
          echo "compose=$COMPOSE_VERSION" >> $GITHUB_OUTPUT
        fi

        # Get Buildx version
        BUILDX_VERSION=$(docker buildx version | awk '{print $2}')
        echo "buildx=$BUILDX_VERSION" >> $GITHUB_OUTPUT

        echo "Docker: $DOCKER_VERSION"
        echo "Compose: ${COMPOSE_VERSION:-not installed}"
        echo "Buildx: $BUILDX_VERSION"
