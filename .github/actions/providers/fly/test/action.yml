name: Test Fly.io Deployment
description: Runs tests on Fly.io deployed Sindri instance

inputs:
  app-name:
    description: Fly.io app name
    required: true
  fly-api-token:
    description: Fly.io API token
    required: true
  test-commands:
    description: JSON array of test commands to run
    required: false
    default: '["sindri --version", "extension-manager list"]'
  test-extension:
    description: Specific extension to test
    required: false
    default: ''
  test-scripts:
    description: Path to test scripts directory
    required: false
    default: ''
  run-integration-tests:
    description: Run integration tests
    required: false
    default: 'true'
  test-persistence:
    description: Test volume persistence
    required: false
    default: 'true'
  collect-logs:
    description: Collect logs on failure
    required: false
    default: 'true'

outputs:
  test-results:
    description: JSON object with test results
    value: ${{ steps.run-tests.outputs.results }}
  all-passed:
    description: Whether all tests passed
    value: ${{ steps.run-tests.outputs.all-passed }}
  logs-url:
    description: URL to view logs in Fly.io dashboard
    value: ${{ steps.logs.outputs.url }}

runs:
  using: composite
  steps:
    - name: Validate environment
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "::group::Validating Fly.io environment"

        APP_NAME="${{ inputs.app-name }}"

        # Check app status
        STATUS=$(flyctl status -a "$APP_NAME" --json | jq -r '.Machines[0].state' || echo "unknown")
        if [[ "$STATUS" != "started" ]]; then
          echo "❌ App is not running (status: $STATUS)"
          exit 1
        fi

        # Basic connectivity test
        flyctl ssh console -a "$APP_NAME" --command "pwd"
        flyctl ssh console -a "$APP_NAME" --command "whoami"
        flyctl ssh console -a "$APP_NAME" --command "ls -la /workspace"

        echo "✅ Environment validation passed"
        echo "::endgroup::"

    - name: Run test commands
      id: run-tests
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "::group::Running test commands"

        APP_NAME="${{ inputs.app-name }}"
        COMMANDS='${{ inputs.test-commands }}'
        RESULTS='{}'
        ALL_PASSED="true"

        # Run each test command
        for cmd in $(echo "$COMMANDS" | jq -r '.[]'); do
          echo "Testing: $cmd"

          set +e
          OUTPUT=$(flyctl ssh console -a "$APP_NAME" --command "$cmd" 2>&1)
          EXIT_CODE=$?
          set -e

          if [[ $EXIT_CODE -eq 0 ]]; then
            STATUS="passed"
            echo "  ✅ Passed"
          else
            STATUS="failed"
            ALL_PASSED="false"
            echo "  ❌ Failed (exit code: $EXIT_CODE)"
            echo "  Output: $OUTPUT"
          fi

          # Store result
          RESULTS=$(echo "$RESULTS" | jq \
            --arg cmd "$cmd" \
            --arg status "$STATUS" \
            --arg exit_code "$EXIT_CODE" \
            --arg output "$OUTPUT" \
            '.[$cmd] = {status: $status, exit_code: ($exit_code | tonumber), output: $output}')
        done

        echo "results=$RESULTS" >> $GITHUB_OUTPUT
        echo "all-passed=$ALL_PASSED" >> $GITHUB_OUTPUT

        echo "::endgroup::"

    - name: Test specific extension
      if: inputs.test-extension != ''
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "::group::Testing extension: ${{ inputs.test-extension }}"

        APP_NAME="${{ inputs.app-name }}"
        EXTENSION="${{ inputs.test-extension }}"

        # Install extension
        echo "Installing extension..."
        flyctl ssh console -a "$APP_NAME" --command "extension-manager install $EXTENSION"

        # Validate extension
        echo "Validating extension..."
        flyctl ssh console -a "$APP_NAME" --command "extension-manager validate $EXTENSION"

        # Test idempotency
        echo "Testing idempotency..."
        flyctl ssh console -a "$APP_NAME" --command "extension-manager install $EXTENSION"
        flyctl ssh console -a "$APP_NAME" --command "extension-manager validate $EXTENSION"

        # Run extension-specific tests if available
        TEST_SCRIPT=".github/scripts/test-${EXTENSION}.sh"
        if [[ -f "$TEST_SCRIPT" ]]; then
          echo "Running extension-specific tests..."
          flyctl ssh console -a "$APP_NAME" --command "bash -s" < "$TEST_SCRIPT"
        fi

        echo "::endgroup::"

    - name: Test persistence
      if: inputs.test-persistence == 'true'
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "::group::Testing volume persistence"

        APP_NAME="${{ inputs.app-name }}"
        TEST_FILE="/workspace/persistence-test-$(date +%s).txt"
        TEST_DATA="Test data: $(date)"

        # Create test file
        echo "Creating test file..."
        flyctl ssh console -a "$APP_NAME" --command "echo '$TEST_DATA' > $TEST_FILE"

        # Get machine ID
        MACHINE_ID=$(flyctl machine list -a "$APP_NAME" --json | jq -r '.[0].id')

        # Restart machine
        echo "Restarting machine..."
        flyctl machine restart "$MACHINE_ID" -a "$APP_NAME"

        # Wait for machine to come back
        sleep 30

        # Verify file persists
        echo "Verifying persistence..."
        RETRIEVED_DATA=$(flyctl ssh console -a "$APP_NAME" --command "cat $TEST_FILE")

        if [[ "$RETRIEVED_DATA" == "$TEST_DATA" ]]; then
          echo "✅ Persistence test passed"
        else
          echo "❌ Persistence test failed"
          echo "Expected: $TEST_DATA"
          echo "Got: $RETRIEVED_DATA"
          exit 1
        fi

        # Cleanup
        flyctl ssh console -a "$APP_NAME" --command "rm -f $TEST_FILE"

        echo "::endgroup::"

    - name: Run integration tests
      if: inputs.run-integration-tests == 'true'
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "::group::Running integration tests"

        APP_NAME="${{ inputs.app-name }}"

        # Test CLI functionality
        echo "Testing Sindri CLI..."
        flyctl ssh console -a "$APP_NAME" --command "sindri config validate || true"
        flyctl ssh console -a "$APP_NAME" --command "sindri --help"

        # Test extension manager
        echo "Testing extension manager..."
        flyctl ssh console -a "$APP_NAME" --command "extension-manager list"
        flyctl ssh console -a "$APP_NAME" --command "extension-manager list-profiles"
        flyctl ssh console -a "$APP_NAME" --command "extension-manager validate-all"

        # Test secrets management
        echo "Testing secrets management..."
        flyctl ssh console -a "$APP_NAME" --command "test -f ~/.secrets/age.key && echo 'Age key exists' || echo 'Age key missing'"

        echo "::endgroup::"

    - name: Collect logs
      id: logs
      if: failure() && inputs.collect-logs == 'true'
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "::group::Collecting logs"

        APP_NAME="${{ inputs.app-name }}"

        # Get recent logs
        flyctl logs -a "$APP_NAME" -n 100 > fly-logs.txt || true

        # Get machine status
        flyctl status -a "$APP_NAME" --json > fly-status.json || true

        # Generate logs URL
        LOGS_URL="https://fly.io/apps/$APP_NAME/logs"
        echo "url=$LOGS_URL" >> $GITHUB_OUTPUT

        echo "View logs at: $LOGS_URL"

        echo "::endgroup::"

    - name: Upload logs
      if: failure() && inputs.collect-logs == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: fly-logs-${{ inputs.app-name }}-${{ github.run_id }}
        path: |
          fly-logs.txt
          fly-status.json
        retention-days: 7