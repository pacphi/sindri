name: Setup Fly.io Self-Service Deployment
description: Configures Fly.io self-service deployment with resource tiers and generates sindri.yaml

inputs:
  app-name:
    description: Application name
    required: true
  region:
    description: Fly.io region
    required: false
    default: "sjc"
  vm-preset:
    description: VM resource preset (small, medium, large, xlarge)
    required: false
    default: "medium"
  volume-size:
    description: Persistent volume size in GB
    required: false
    default: "30"
  extension-profile:
    description: Extension profile to install
    required: false
    default: "fullstack"
  custom-extensions:
    description: Custom extensions (comma-separated, only if profile=custom)
    required: false
    default: ""
  fly-api-token:
    description: Fly.io API token
    required: true

outputs:
  app-name:
    description: Application name
    value: ${{ steps.config.outputs.app_name }}
  region:
    description: Fly.io region
    value: ${{ steps.config.outputs.region }}
  volume-size:
    description: Volume size in GB
    value: ${{ steps.config.outputs.volume_size }}
  vm-memory:
    description: VM memory in MB
    value: ${{ steps.resources.outputs.vm_memory }}
  cpu-kind:
    description: CPU kind (shared or performance)
    value: ${{ steps.resources.outputs.cpu_kind }}
  cpu-count:
    description: Number of CPUs
    value: ${{ steps.resources.outputs.cpu_count }}
  extension-profile:
    description: Extension profile
    value: ${{ steps.config.outputs.extension_profile }}
  custom-extensions:
    description: Custom extensions list
    value: ${{ steps.config.outputs.custom_extensions }}

runs:
  using: composite
  steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Fly CLI
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: Authenticate with Fly.io
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "$FLY_API_TOKEN" | flyctl auth token

    - name: Install utilities
      shell: bash
      run: |
        # Install yq for YAML processing
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Map VM preset to resources
      id: resources
      shell: bash
      run: |
        case "${{ inputs.vm-preset }}" in
          small)
            echo "vm_memory=2048" >> $GITHUB_OUTPUT
            echo "cpu_kind=shared" >> $GITHUB_OUTPUT
            echo "cpu_count=1" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Small tier: 2GB RAM, 1 shared CPU"
            ;;
          medium)
            echo "vm_memory=8192" >> $GITHUB_OUTPUT
            echo "cpu_kind=shared" >> $GITHUB_OUTPUT
            echo "cpu_count=4" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Medium tier: 8GB RAM, 4 shared CPUs"
            ;;
          large)
            echo "vm_memory=16384" >> $GITHUB_OUTPUT
            echo "cpu_kind=performance" >> $GITHUB_OUTPUT
            echo "cpu_count=4" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Large tier: 16GB RAM, 4 performance CPUs"
            ;;
          xlarge)
            echo "vm_memory=32768" >> $GITHUB_OUTPUT
            echo "cpu_kind=performance" >> $GITHUB_OUTPUT
            echo "cpu_count=8" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ XLarge tier: 32GB RAM, 8 performance CPUs"
            ;;
          *)
            echo "âŒ Invalid VM preset: ${{ inputs.vm-preset }}"
            echo "Valid presets: small, medium, large, xlarge"
            exit 1
            ;;
        esac

    - name: Configure deployment
      id: config
      shell: bash
      run: |
        echo "app_name=${{ inputs.app-name }}" >> $GITHUB_OUTPUT
        echo "region=${{ inputs.region }}" >> $GITHUB_OUTPUT
        echo "volume_size=${{ inputs.volume-size }}" >> $GITHUB_OUTPUT
        echo "extension_profile=${{ inputs.extension-profile }}" >> $GITHUB_OUTPUT
        echo "custom_extensions=${{ inputs.custom-extensions }}" >> $GITHUB_OUTPUT

        # Log configuration
        echo "## ðŸš€ Deployment Configuration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **App Name**: ${{ inputs.app-name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: ${{ inputs.region }}" >> $GITHUB_STEP_SUMMARY
        echo "- **VM Preset**: ${{ inputs.vm-preset }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Volume Size**: ${{ inputs.volume-size }}GB" >> $GITHUB_STEP_SUMMARY
        echo "- **Extension Profile**: ${{ inputs.extension-profile }}" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ inputs.custom-extensions }}" ]; then
          echo "- **Custom Extensions**: ${{ inputs.custom-extensions }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Generate sindri.yaml
      shell: bash
      run: |
        # Determine extensions based on profile or custom list
        if [ "${{ inputs.extension-profile }}" = "custom" ]; then
          extensions="${{ inputs.custom-extensions }}"
        else
          profile="${{ inputs.extension-profile }}"
        fi

        # Calculate memory in GB (convert from MB)
        memory_gb=$((${{ steps.resources.outputs.vm_memory }} / 1024))

        # Generate sindri.yaml
        cat > sindri.yaml << EOYAML
        version: 1.0
        name: ${{ inputs.app-name }}

        deployment:
          provider: fly
          resources:
            memory: ${memory_gb}GB
            cpus: ${{ steps.resources.outputs.cpu_count }}

          volumes:
            workspace:
              path: /workspace
              size: ${{ inputs.volume-size }}GB

        extensions:
          profile: ${{ inputs.extension-profile }}

        providers:
          fly:
            region: ${{ inputs.region }}
            autoStopMachines: true
            autoStartMachines: true
            cpuKind: ${{ steps.resources.outputs.cpu_kind }}
            sshPort: 10022
            organization: personal
            highAvailability: false
        EOYAML

        echo "âœ… Generated sindri.yaml"
        cat sindri.yaml
