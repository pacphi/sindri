name: Install Extension
description: Installs an extension on any provider

inputs:
  extension:
    description: Extension name to install
    required: true
  provider:
    description: Provider type (docker, fly, devpod, kubernetes, ssh)
    required: true
  target:
    description: Target identifier (container name, app name, workspace ID)
    required: true
  fly-api-token:
    description: Fly.io API token (required for Fly provider)
    required: false
    default: ''
  validate-after-install:
    description: Run validation after installation
    required: false
    default: 'true'

outputs:
  install-status:
    description: Installation status
    value: ${{ steps.install.outputs.status }}
  validation-result:
    description: Validation result if performed
    value: ${{ steps.validate.outputs.result }}

runs:
  using: composite
  steps:
    - name: Install extension
      id: install
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "::group::Installing extension: ${{ inputs.extension }}"

        PROVIDER="${{ inputs.provider }}"
        TARGET="${{ inputs.target }}"
        EXTENSION="${{ inputs.extension }}"

        case "$PROVIDER" in
          docker)
            echo "Installing via Docker..."
            docker exec "$TARGET" extension-manager install "$EXTENSION"
            ;;

          fly)
            echo "Installing via Fly.io..."
            flyctl ssh console -a "$TARGET" --command "extension-manager install $EXTENSION"
            ;;

          devpod*|kubernetes|ssh)
            echo "Installing via DevPod..."
            devpod exec "$TARGET" -- extension-manager install "$EXTENSION"
            ;;

          *)
            echo "âŒ Unknown provider: $PROVIDER"
            exit 1
            ;;
        esac

        echo "status=success" >> $GITHUB_OUTPUT
        echo "::endgroup::"

    - name: Validate extension
      id: validate
      if: inputs.validate-after-install == 'true'
      shell: bash
      env:
        FLY_API_TOKEN: ${{ inputs.fly-api-token }}
      run: |
        echo "::group::Validating extension: ${{ inputs.extension }}"

        PROVIDER="${{ inputs.provider }}"
        TARGET="${{ inputs.target }}"
        EXTENSION="${{ inputs.extension }}"

        case "$PROVIDER" in
          docker)
            docker exec "$TARGET" extension-manager validate "$EXTENSION"
            ;;

          fly)
            flyctl ssh console -a "$TARGET" --command "extension-manager validate $EXTENSION"
            ;;

          devpod*|kubernetes|ssh)
            devpod exec "$TARGET" -- extension-manager validate "$EXTENSION"
            ;;
        esac

        echo "result=valid" >> $GITHUB_OUTPUT
        echo "::endgroup::"