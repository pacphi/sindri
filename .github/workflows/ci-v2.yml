name: CI v2

# v2 Bash/Docker CI Pipeline
# Triggers on changes to v2 directory and related configurations

on:
  push:
    branches: [main, develop]
    paths:
      - 'v2/**'
      - '.github/workflows/ci-v2.yml'
      - '.github/actions/v2/**'
      - '.github/actions/shared/**'
      - 'package.json'
  pull_request:
    branches: [main, develop]
    paths:
      - 'v2/**'
      - '.github/workflows/ci-v2.yml'
      - '.github/actions/v2/**'
      - '.github/actions/shared/**'
      - 'package.json'
  workflow_dispatch:
    inputs:
      providers:
        description: |
          Providers to test (comma-separated or 'all').
          Options: docker, fly, devpod-aws, devpod-gcp, devpod-azure, devpod-do, devpod-k8s
        required: false
        default: "docker,fly,devpod-k8s"
        type: string
      test-level:
        description: Test level to run
        required: false
        default: "profile"
        type: choice
        options:
          - quick
          - extension
          - profile
          - all
      extension-profile:
        description: Extension profile to test (affects resource requirements)
        required: false
        default: "minimal"
        type: choice
        options:
          - minimal
          - mobile
          - fullstack
          - ai-dev
          - systems
          - devops
          - anthropic-dev
          - enterprise
          - visionflow-core
          - visionflow-data-scientist
          - visionflow-creative
          - visionflow-full
      extension:
        description: Extension to test (when test-level is 'extension')
        required: false
        default: "nodejs"
        type: string
      skip-cleanup:
        description: Skip resource cleanup for debugging
        required: false
        default: false
        type: boolean

concurrency:
  group: ci-v2-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1

jobs:
  # NOTE: Validation is handled by dedicated workflows:
  # - validate-shell.yml (shellcheck)
  # - validate-markdown.yml (markdownlint)
  # - validate-yaml.yml (YAML/schema validation)

  # ============================================
  # Build Job
  # ============================================

  build:
    name: Build v2 Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export v2 image
        id: build
        run: |
          IMAGE_TAG="sindri-v2:ci-${{ github.sha }}"

          docker buildx build \
            --file v2/Dockerfile \
            --tag "$IMAGE_TAG" \
            --load \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            v2

          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          DIGEST=$(docker inspect --format='{{.Id}}' "$IMAGE_TAG")
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Save image as artifact
        run: |
          docker save sindri-v2:ci-${{ github.sha }} | gzip > sindri-v2-image.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v6
        with:
          name: sindri-v2-image-${{ github.sha }}
          path: sindri-v2-image.tar.gz
          retention-days: 1

  # ============================================
  # Test Matrix Generation
  # ============================================

  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    outputs:
      providers: ${{ steps.matrix.outputs.providers }}
    steps:
      - uses: actions/checkout@v6

      - name: Generate matrices
        id: matrix
        run: |
          # Determine which providers to test based on trigger type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            INPUT_PROVIDERS="${{ github.event.inputs.providers }}"
            if [[ "$INPUT_PROVIDERS" == "all" ]]; then
              PROVIDERS='["docker", "fly", "devpod-aws", "devpod-gcp", "devpod-azure", "devpod-do", "devpod-k8s"]'
            else
              PROVIDERS=$(echo "$INPUT_PROVIDERS" | jq -Rc 'split(",") | map(ltrimstr(" ") | rtrimstr(" "))')
            fi
          else
            # Push and PR events all test the same provider set
            PROVIDERS='["docker", "fly", "devpod-k8s"]'
          fi

          # Skip fly provider for Dependabot PRs (no access to FLY_API_TOKEN secret)
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            PROVIDERS=$(echo "$PROVIDERS" | jq -c 'map(select(. != "fly"))')
            echo "::notice title=Dependabot Detected::Skipping fly provider (no secret access)"
          fi

          echo "providers=$PROVIDERS" >> $GITHUB_OUTPUT
          echo "::notice title=Test Providers::$PROVIDERS"

  # ============================================
  # Unified Provider Testing
  # ============================================

  test-providers:
    name: Test v2 on ${{ matrix.provider }}
    needs: [build, generate-matrix]
    if: needs.generate-matrix.outputs.providers != '[]'
    strategy:
      fail-fast: false
      matrix:
        provider: ${{ fromJson(needs.generate-matrix.outputs.providers) }}
    uses: ./.github/workflows/test-provider.yml
    with:
      provider: ${{ matrix.provider }}
      test-level: ${{ github.event.inputs.test-level || 'profile' }}
      extension-profile: ${{ github.event.inputs.extension-profile || 'minimal' }}
      extension: ${{ github.event.inputs.extension || 'nodejs' }}
      skip-cleanup: ${{ github.event.inputs.skip-cleanup == 'true' }}
      image: sindri-v2:ci-${{ github.sha }}
      image-artifact: sindri-v2-image-${{ github.sha }}
    secrets: inherit

  # ============================================
  # CI Status Checks
  # ============================================

  ci-required:
    name: CI v2 Required Checks
    runs-on: ubuntu-latest
    needs:
      - build
    if: ${{ always() }}
    steps:
      - name: Check required jobs
        run: |
          # Check if any required job failed
          # NOTE: Validation is handled by dedicated workflows:
          # - validate-shell.yml, validate-markdown.yml, validate-yaml.yml
          BUILD="${{ needs.build.result }}"

          if [[ "$BUILD" != "success" ]]; then
            echo "❌ Required CI v2 checks failed"
            echo "Results:"
            echo "  build: $BUILD"
            exit 1
          fi

          echo "✅ Required CI v2 checks passed"

  ci-status:
    name: CI v2 Status
    runs-on: ubuntu-latest
    needs:
      - ci-required
      - test-providers
    if: ${{ always() }}
    steps:
      - name: Check overall status
        run: |
          REQUIRED="${{ needs.ci-required.result }}"
          TEST_PROVIDERS="${{ needs.test-providers.result }}"

          # Required checks must pass
          if [[ "$REQUIRED" != "success" ]]; then
            echo "❌ CI v2 failed - required checks did not pass"
            exit 1
          fi

          # Provider tests should pass if they ran
          if [[ "$TEST_PROVIDERS" != "skipped" ]] && [[ "$TEST_PROVIDERS" != "success" ]]; then
            echo "❌ CI v2 failed - provider tests failed"
            echo "  test-providers: $TEST_PROVIDERS"
            exit 1
          fi

          echo "✅ CI v2 passed"
          echo "Results:"
          echo "  ci-required: $REQUIRED"
          echo "  test-providers: $TEST_PROVIDERS"

      - name: Generate summary
        if: always()
        run: |
          echo "# CI v2 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Unified Provider Testing (v2)" >> $GITHUB_STEP_SUMMARY
          echo "Each selected provider receives **complete test coverage**:" >> $GITHUB_STEP_SUMMARY
          echo "- CLI Tests (sindri, extension-manager commands)" >> $GITHUB_STEP_SUMMARY
          echo "- Extension Tests (validation, installation)" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests (end-to-end workflows)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Required Checks | ${{ needs.ci-required.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Providers | ${{ needs.test-providers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v2 (Bash/Docker)" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
