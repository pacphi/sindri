name: CI v3

# v3 Rust CI Pipeline
# Triggers on changes to v3 directory and related configurations

on:
  push:
    branches: [main, develop, feature/v3]
    paths:
      - 'v3/**'
      - '.github/workflows/ci-v3.yml'
      - '.github/actions/v3/**'
      - '.github/actions/shared/**'
  pull_request:
    branches: [main, develop, feature/v3]
    paths:
      - 'v3/**'
      - '.github/workflows/ci-v3.yml'
      - '.github/actions/v3/**'
      - '.github/actions/shared/**'
  workflow_dispatch:
    inputs:
      test-extensions:
        description: 'Run extension tests'
        required: false
        default: true
        type: boolean
      run-audit:
        description: 'Run security audit'
        required: false
        default: true
        type: boolean

concurrency:
  group: ci-v3-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================
  # Rust Validation Jobs
  # ============================================

  rust-format:
    name: Rust Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check Rust formatting
        run: |
          cd v3
          cargo fmt --all -- --check

  rust-clippy:
    name: Rust Clippy Lints
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Cargo dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            v3/target/
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('v3/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-clippy-
            ${{ runner.os }}-cargo-

      - name: Run Clippy
        run: |
          cd v3
          cargo clippy --workspace --all-targets --all-features -- -D warnings

  rust-test:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            v3/target/
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('v3/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-
            ${{ runner.os }}-cargo-

      - name: Run tests
        run: |
          cd v3
          cargo test --workspace --all-features

      - name: Generate test report
        if: always()
        run: |
          cd v3
          cargo test --workspace --all-features -- --nocapture > test-results.txt 2>&1 || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-v3
          path: v3/test-results.txt
          retention-days: 7

  rust-build:
    name: Rust Build (Release)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            v3/target/
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('v3/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-
            ${{ runner.os }}-cargo-

      - name: Build release binaries
        run: |
          cd v3
          cargo build --release --workspace

      - name: Check binary size
        run: |
          echo "## Binary Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Binary | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY

          if [[ -f v3/target/release/sindri ]]; then
            SIZE=$(du -h v3/target/release/sindri | cut -f1)
            echo "| sindri | $SIZE |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload binaries
        uses: actions/upload-artifact@v6
        with:
          name: sindri-v3-binaries-${{ github.sha }}
          path: |
            v3/target/release/sindri
          retention-days: 1

  # NOTE: YAML/schema validation is handled by the dedicated validate-yaml.yml workflow

  # ============================================
  # Security Audit
  # ============================================

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.run-audit == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo audit
        run: |
          cd v3
          cargo audit --deny warnings || echo "::warning::Security vulnerabilities found"

  # ============================================
  # Documentation Build
  # ============================================

  docs-build:
    name: Documentation Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            v3/target/
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('v3/**/Cargo.lock') }}

      - name: Build documentation
        run: |
          cd v3
          cargo doc --workspace --no-deps --all-features

      - name: Check for broken links in docs
        run: |
          cd v3
          cargo doc --workspace --no-deps --all-features 2>&1 | tee doc-build.log

          if grep -i "warning.*intra-doc link" doc-build.log; then
            echo "::warning::Broken intra-doc links found"
          fi

  # ============================================
  # Extension Tests (v3)
  # ============================================

  test-extensions:
    name: Test v3 Extensions
    runs-on: ubuntu-latest
    if: github.event.inputs.test-extensions == 'true' || github.event_name != 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v6

      - name: Check if v3 extensions exist
        id: check
        run: |
          if [[ -d v3/extensions ]] && [[ -n "$(ls -A v3/extensions 2>/dev/null)" ]]; then
            echo "extensions_exist=true" >> $GITHUB_OUTPUT
          else
            echo "extensions_exist=false" >> $GITHUB_OUTPUT
            echo "::notice::No v3 extensions directory found or it's empty"
          fi

      - name: Validate v3 extensions
        if: steps.check.outputs.extensions_exist == 'true'
        run: |
          echo "## v3 Extensions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          count=0
          for ext_dir in v3/extensions/*/; do
            if [[ -f "$ext_dir/extension.yaml" ]]; then
              ext_name=$(basename "$ext_dir")
              echo "- $ext_name" >> $GITHUB_STEP_SUMMARY
              ((count++)) || true
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total**: $count extension(s)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # CI Status Checks
  # ============================================

  ci-required:
    name: CI v3 Required Checks
    runs-on: ubuntu-latest
    needs:
      - rust-format
      - rust-clippy
      - rust-test
      - rust-build
    if: ${{ always() }}
    steps:
      - name: Check required jobs
        run: |
          # Check if any required job failed
          # NOTE: YAML/schema validation is handled by the dedicated validate-yaml.yml workflow
          FORMAT="${{ needs.rust-format.result }}"
          CLIPPY="${{ needs.rust-clippy.result }}"
          TEST="${{ needs.rust-test.result }}"
          BUILD="${{ needs.rust-build.result }}"

          if [[ "$FORMAT" != "success" ]] || \
             [[ "$CLIPPY" != "success" ]] || \
             [[ "$TEST" != "success" ]] || \
             [[ "$BUILD" != "success" ]]; then
            echo "❌ Required CI v3 checks failed"
            echo "Results:"
            echo "  rust-format: $FORMAT"
            echo "  rust-clippy: $CLIPPY"
            echo "  rust-test: $TEST"
            echo "  rust-build: $BUILD"
            exit 1
          fi

          echo "✅ Required CI v3 checks passed"

  ci-status:
    name: CI v3 Status
    runs-on: ubuntu-latest
    needs:
      - ci-required
      - security-audit
      - docs-build
      - test-extensions
    if: ${{ always() }}
    steps:
      - name: Check overall status
        run: |
          REQUIRED="${{ needs.ci-required.result }}"
          AUDIT="${{ needs.security-audit.result }}"
          DOCS="${{ needs.docs-build.result }}"
          EXTENSIONS="${{ needs.test-extensions.result }}"

          # Required checks must pass
          if [[ "$REQUIRED" != "success" ]]; then
            echo "❌ CI v3 failed - required checks did not pass"
            exit 1
          fi

          # Audit, docs, and extensions are optional/informational
          if [[ "$AUDIT" == "failure" ]]; then
            echo "⚠️ Security audit found issues (non-blocking)"
          fi

          echo "✅ CI v3 passed"
          echo "Results:"
          echo "  ci-required: $REQUIRED"
          echo "  security-audit: $AUDIT"
          echo "  docs-build: $DOCS"
          echo "  test-extensions: $EXTENSIONS"

      - name: Generate summary
        if: always()
        run: |
          echo "# CI v3 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Rust Workspace Checks" >> $GITHUB_STEP_SUMMARY
          echo "- Format check (rustfmt)" >> $GITHUB_STEP_SUMMARY
          echo "- Linting (clippy)" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests (cargo test)" >> $GITHUB_STEP_SUMMARY
          echo "- Release build (cargo build --release)" >> $GITHUB_STEP_SUMMARY
          echo "- YAML validation (extensions, schemas)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Required Checks | ${{ needs.ci-required.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation Build | ${{ needs.docs-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Extension Tests | ${{ needs.test-extensions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v3 (Rust)" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
