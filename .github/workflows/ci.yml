name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/ISSUE_TEMPLATE/**"
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  schedule:
    - cron: "0 2 * * *" # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      providers:
        description: Providers to test (comma-separated or 'all')
        required: false
        default: "docker,fly"
        type: string
      test-suite:
        description: Test suite to run
        required: false
        default: "integration"
        type: choice
        options:
          - smoke
          - integration
          - full
      skip-cleanup:
        description: Skip resource cleanup for debugging
        required: false
        default: false
        type: boolean

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1

jobs:
  # Shell script validation
  shellcheck:
    name: Shell Script Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck on all shell scripts
        run: |
          find . -name "*.sh" -type f ! -path "./node_modules/*" | while read -r script; do
            echo "Checking: $script"
            shellcheck "$script" || exit 1
          done

  # Markdown validation
  markdownlint:
    name: Markdown Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: markdownlint '**/*.md' --ignore node_modules

  # YAML validation (uses comprehensive new workflow)
  validate-yaml:
    name: Validate YAML
    uses: ./.github/workflows/validate-yaml.yml
    secrets: inherit

  # Build Docker image
  build:
    name: Build Image
    runs-on: ubuntu-latest
    needs: [shellcheck, markdownlint, validate-yaml]
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export image
        id: build
        uses: ./.github/actions/core/build-image
        with:
          image-tag: sindri:ci-${{ github.sha }}
          cache-key-prefix: sindri-ci

      - name: Save image as artifact
        run: |
          docker save sindri:ci-${{ github.sha }} | gzip > sindri-image.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: sindri-image-${{ github.sha }}
          path: sindri-image.tar.gz
          retention-days: 1

  # Test CLI functionality
  test-cli:
    name: Test CLI
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v5

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: sindri-image-${{ github.sha }}

      - name: Load Docker image
        run: |
          gunzip -c sindri-image.tar.gz | docker load

      - name: Test CLI commands
        uses: ./.github/actions/core/test-cli
        with:
          test-in-container: true
          image: sindri:ci-${{ github.sha }}
          test-commands: |
            [
              "sindri --version",
              "sindri config validate --help",
              "extension-manager list",
              "extension-manager list-profiles",
              "extension-manager validate nodejs"
            ]

  # Generate provider test matrix
  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    needs: [shellcheck, markdownlint, validate-yaml]
    outputs:
      providers: ${{ steps.matrix.outputs.providers }}
      extensions: ${{ steps.matrix.outputs.extensions }}
    steps:
      - uses: actions/checkout@v5

      - name: Generate matrices
        id: matrix
        run: |
          # Determine which providers to test
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            INPUT_PROVIDERS="${{ github.event.inputs.providers }}"
            if [[ "$INPUT_PROVIDERS" == "all" ]]; then
              PROVIDERS='["docker", "fly", "devpod-aws", "devpod-gcp", "devpod-azure", "devpod-do", "kubernetes"]'
            else
              # Convert comma-separated to JSON array
              PROVIDERS=$(echo "$INPUT_PROVIDERS" | jq -R 'split(",") | map(ltrimstr(" ") | rtrimstr(" "))')
            fi
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            # Full test suite for scheduled runs
            PROVIDERS='["docker", "fly", "devpod-aws", "kubernetes"]'
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Main branch: test primary providers
            PROVIDERS='["docker", "fly"]'
          else
            # PRs and other branches: minimal testing
            PROVIDERS='["docker"]'
          fi

          # Generate extension matrix
          EXTENSIONS=$(find docker/lib/extensions -mindepth 1 -maxdepth 1 -type d \
            -exec basename {} \; | head -5 | jq -R . | jq -s .)

          echo "providers=$PROVIDERS" >> $GITHUB_OUTPUT
          echo "extensions=$EXTENSIONS" >> $GITHUB_OUTPUT

          echo "Testing providers: $PROVIDERS"
          echo "Testing extensions: $EXTENSIONS"

  # Test providers in parallel
  test-providers:
    name: Test ${{ matrix.provider }}
    needs: [build, generate-matrix]
    if: needs.generate-matrix.outputs.providers != '[]'
    strategy:
      fail-fast: false
      matrix:
        provider: ${{ fromJson(needs.generate-matrix.outputs.providers) }}
    uses: ./.github/workflows/test-provider.yml
    with:
      provider: ${{ matrix.provider }}
      test-suite: ${{ github.event.inputs.test-suite || 'integration' }}
      skip-cleanup: ${{ github.event.inputs.skip-cleanup == 'true' }}
    secrets: inherit

  # Test extensions
  test-extensions:
    name: Test Extensions
    needs: [build, generate-matrix]
    if: needs.generate-matrix.outputs.extensions != '[]'
    uses: ./.github/workflows/test-extensions.yml
    with:
      extensions: ${{ needs.generate-matrix.outputs.extensions }}
      provider: docker
    secrets: inherit

  # Final status check - only depends on jobs that always run
  ci-required:
    name: CI Required Checks
    runs-on: ubuntu-latest
    needs:
      - shellcheck
      - markdownlint
      - validate-yaml
      - build
      - test-cli
    if: ${{ always() }}
    steps:
      - name: Check required jobs
        run: |
          # Check if any required job failed
          SHELLCHECK="${{ needs.shellcheck.result }}"
          MARKDOWNLINT="${{ needs.markdownlint.result }}"
          VALIDATE_YAML="${{ needs.validate-yaml.result }}"
          BUILD="${{ needs.build.result }}"
          TEST_CLI="${{ needs.test-cli.result }}"

          if [[ "$SHELLCHECK" != "success" ]] || \
             [[ "$MARKDOWNLINT" != "success" ]] || \
             [[ "$VALIDATE_YAML" != "success" ]] || \
             [[ "$BUILD" != "success" ]] || \
             [[ "$TEST_CLI" != "success" ]]; then
            echo "❌ Required CI checks failed"
            echo "Results:"
            echo "  shellcheck: $SHELLCHECK"
            echo "  markdownlint: $MARKDOWNLINT"
            echo "  validate-yaml: $VALIDATE_YAML"
            echo "  build: $BUILD"
            echo "  test-cli: $TEST_CLI"
            exit 1
          fi

          echo "✅ Required CI checks passed"

  # Overall CI status - includes optional jobs
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs:
      - ci-required
      - test-providers
      - test-extensions
    if: ${{ always() }}
    steps:
      - name: Check overall status
        run: |
          # Check results of all jobs
          REQUIRED="${{ needs.ci-required.result }}"
          TEST_PROVIDERS="${{ needs.test-providers.result }}"
          TEST_EXTENSIONS="${{ needs.test-extensions.result }}"

          # Required checks must pass
          if [[ "$REQUIRED" != "success" ]]; then
            echo "❌ CI failed - required checks did not pass"
            echo "Results:"
            echo "  ci-required: $REQUIRED"
            echo "  test-providers: $TEST_PROVIDERS"
            echo "  test-extensions: $TEST_EXTENSIONS"
            exit 1
          fi

          # Optional jobs should pass if they ran
          if ([[ "$TEST_PROVIDERS" != "skipped" ]] && [[ "$TEST_PROVIDERS" != "success" ]]) || \
             ([[ "$TEST_EXTENSIONS" != "skipped" ]] && [[ "$TEST_EXTENSIONS" != "success" ]]); then
            echo "❌ CI failed - optional checks failed"
            echo "Results:"
            echo "  ci-required: $REQUIRED"
            echo "  test-providers: $TEST_PROVIDERS"
            echo "  test-extensions: $TEST_EXTENSIONS"
            exit 1
          fi

          echo "✅ CI passed"
          echo "Results:"
          echo "  ci-required: $REQUIRED"
          echo "  test-providers: $TEST_PROVIDERS"
          echo "  test-extensions: $TEST_EXTENSIONS"

      - name: Generate summary
        if: always()
        run: |
          echo "# CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Required Checks | ${{ needs.ci-required.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Providers | ${{ needs.test-providers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Extensions | ${{ needs.test-extensions.result }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
