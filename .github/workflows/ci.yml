name: CI

# Unified CI workflow that runs all tests (CLI, extensions, integration) on selected providers
# This ensures consistent test coverage across all deployment targets.

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/ISSUE_TEMPLATE/**"
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      providers:
        description: |
          Providers to test (comma-separated or 'all').
          Options: docker, fly, devpod-aws, devpod-gcp, devpod-azure, devpod-do, devpod-k8s
        required: false
        default: "docker,fly,devpod-k8s"
        type: string
      test-level:
        description: Test level to run
        required: false
        default: "profile"
        type: choice
        options:
          - quick
          - extension
          - profile
          - all
      extension-profile:
        description: Extension profile to test (affects resource requirements)
        required: false
        default: "minimal"
        type: choice
        options:
          - minimal
          - mobile
          - fullstack
          - ai-dev
          - systems
          - devops
          - anthropic-dev
          - enterprise
          - visionflow-core
          - visionflow-data-scientist
          - visionflow-creative
          - visionflow-full
      extension:
        description: Extension to test (when test-level is 'extension')
        required: false
        default: "nodejs"
        type: string
      skip-cleanup:
        description: Skip resource cleanup for debugging
        required: false
        default: false
        type: boolean

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1

jobs:
  # ============================================
  # Validation Jobs
  # ============================================

  shellcheck:
    name: Shell Script Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck on all shell scripts
        env:
          SHELLCHECK_OPTS: --severity=warning
        run: |
          find . -name "*.sh" -type f ! -path "./node_modules/*" | while read -r script; do
            # Skip zsh scripts (shellcheck only supports sh/bash/dash/ksh)
            if head -1 "$script" | grep -q "#!/bin/zsh"; then
              echo "Skipping zsh script: $script"
              continue
            fi
            echo "Checking: $script"
            shellcheck "$script" || exit 1
          done

  markdownlint:
    name: Markdown Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: markdownlint '**/*.md' --ignore node_modules

  validate-yaml:
    name: Validate YAML
    uses: ./.github/workflows/validate-yaml.yml
    secrets: inherit

  # ============================================
  # Build Job
  # ============================================

  build:
    name: Build Image
    runs-on: ubuntu-latest
    needs: [shellcheck, markdownlint, validate-yaml]
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export image
        id: build
        uses: ./.github/actions/core/build-image
        with:
          image-tag: sindri:ci-${{ github.sha }}
          cache-key-prefix: sindri-ci
          # Disable buildx cache to avoid layer corruption
          # See: https://github.com/docker/buildx/issues/637
          no-cache: true

      - name: Save image as artifact
        run: |
          docker save sindri:ci-${{ github.sha }} | gzip > sindri-image.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v6
        with:
          name: sindri-image-${{ github.sha }}
          path: sindri-image.tar.gz
          retention-days: 1

  # ============================================
  # Test Matrix Generation
  # ============================================

  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    needs: [shellcheck, markdownlint, validate-yaml]
    outputs:
      providers: ${{ steps.matrix.outputs.providers }}
    steps:
      - uses: actions/checkout@v6

      - name: Generate matrices
        id: matrix
        run: |
          # Determine which providers to test based on trigger type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            INPUT_PROVIDERS="${{ github.event.inputs.providers }}"
            if [[ "$INPUT_PROVIDERS" == "all" ]]; then
              PROVIDERS='["docker", "fly", "devpod-aws", "devpod-gcp", "devpod-azure", "devpod-do", "devpod-k8s"]'
            else
              PROVIDERS=$(echo "$INPUT_PROVIDERS" | jq -Rc 'split(",") | map(ltrimstr(" ") | rtrimstr(" "))')
            fi
          else
            # Push and PR events all test the same provider set
            PROVIDERS='["docker", "fly", "devpod-k8s"]'
          fi

          # Skip fly provider for Dependabot PRs (no access to FLY_API_TOKEN secret)
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            PROVIDERS=$(echo "$PROVIDERS" | jq -c 'map(select(. != "fly"))')
            echo "::notice title=Dependabot Detected::Skipping fly provider (no secret access)"
          fi

          echo "providers=$PROVIDERS" >> $GITHUB_OUTPUT
          echo "::notice title=Test Providers::$PROVIDERS"

  # ============================================
  # Unified Provider Testing
  # ============================================
  # Each provider runs CLI tests, extension tests, and integration tests
  # This ensures consistent test coverage across all deployment targets

  test-providers:
    name: Test ${{ matrix.provider }}
    needs: [build, generate-matrix]
    if: needs.generate-matrix.outputs.providers != '[]'
    strategy:
      fail-fast: false
      matrix:
        provider: ${{ fromJson(needs.generate-matrix.outputs.providers) }}
    uses: ./.github/workflows/test-provider.yml
    with:
      provider: ${{ matrix.provider }}
      test-level: ${{ github.event.inputs.test-level || 'profile' }}
      extension-profile: ${{ github.event.inputs.extension-profile || 'minimal' }}
      extension: ${{ github.event.inputs.extension || 'nodejs' }}
      skip-cleanup: ${{ github.event.inputs.skip-cleanup == 'true' }}
      image: sindri:ci-${{ github.sha }}
      image-artifact: sindri-image-${{ github.sha }}
    secrets: inherit

  # ============================================
  # CI Status Checks
  # ============================================

  ci-required:
    name: CI Required Checks
    runs-on: ubuntu-latest
    needs:
      - shellcheck
      - markdownlint
      - validate-yaml
      - build
    if: ${{ always() }}
    steps:
      - name: Check required jobs
        run: |
          # Check if any required job failed
          SHELLCHECK="${{ needs.shellcheck.result }}"
          MARKDOWNLINT="${{ needs.markdownlint.result }}"
          VALIDATE_YAML="${{ needs.validate-yaml.result }}"
          BUILD="${{ needs.build.result }}"

          if [[ "$SHELLCHECK" != "success" ]] || \
             [[ "$MARKDOWNLINT" != "success" ]] || \
             [[ "$VALIDATE_YAML" != "success" ]] || \
             [[ "$BUILD" != "success" ]]; then
            echo "❌ Required CI checks failed"
            echo "Results:"
            echo "  shellcheck: $SHELLCHECK"
            echo "  markdownlint: $MARKDOWNLINT"
            echo "  validate-yaml: $VALIDATE_YAML"
            echo "  build: $BUILD"
            exit 1
          fi

          echo "✅ Required CI checks passed"

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs:
      - ci-required
      - test-providers
    if: ${{ always() }}
    steps:
      - name: Check overall status
        run: |
          REQUIRED="${{ needs.ci-required.result }}"
          TEST_PROVIDERS="${{ needs.test-providers.result }}"

          # Required checks must pass
          if [[ "$REQUIRED" != "success" ]]; then
            echo "❌ CI failed - required checks did not pass"
            exit 1
          fi

          # Provider tests should pass if they ran
          if [[ "$TEST_PROVIDERS" != "skipped" ]] && [[ "$TEST_PROVIDERS" != "success" ]]; then
            echo "❌ CI failed - provider tests failed"
            echo "  test-providers: $TEST_PROVIDERS"
            exit 1
          fi

          echo "✅ CI passed"
          echo "Results:"
          echo "  ci-required: $REQUIRED"
          echo "  test-providers: $TEST_PROVIDERS"

      - name: Generate summary
        if: always()
        run: |
          echo "# CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Unified Provider Testing" >> $GITHUB_STEP_SUMMARY
          echo "Each selected provider receives **complete test coverage**:" >> $GITHUB_STEP_SUMMARY
          echo "- CLI Tests (sindri, extension-manager commands)" >> $GITHUB_STEP_SUMMARY
          echo "- Extension Tests (validation, installation)" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests (end-to-end workflows)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Required Checks | ${{ needs.ci-required.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Providers | ${{ needs.test-providers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
