name: CI

# Unified CI workflow that runs all tests (CLI, extensions, integration) on selected providers
# This ensures consistent test coverage across all deployment targets.

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/ISSUE_TEMPLATE/**"
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      providers:
        description: Providers to test (comma-separated or 'all')
        required: false
        default: "docker,fly"
        type: string
      test-suite:
        description: Test suite to run
        required: false
        default: "integration"
        type: choice
        options:
          - smoke
          - integration
          - full
      extension-profile:
        description: Extension profile to test
        required: false
        default: "minimal"
        type: string
      extensions-to-test:
        description: Specific extensions to test (JSON array)
        required: false
        default: '["nodejs", "python"]'
        type: string
      skip-cleanup:
        description: Skip resource cleanup for debugging
        required: false
        default: false
        type: boolean

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1

jobs:
  # ============================================
  # Validation Jobs
  # ============================================

  shellcheck:
    name: Shell Script Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck on all shell scripts
        env:
          SHELLCHECK_OPTS: --severity=warning
        run: |
          find . -name "*.sh" -type f ! -path "./node_modules/*" | while read -r script; do
            echo "Checking: $script"
            shellcheck "$script" || exit 1
          done

  markdownlint:
    name: Markdown Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: markdownlint '**/*.md' --ignore node_modules

  validate-yaml:
    name: Validate YAML
    uses: ./.github/workflows/validate-yaml.yml
    secrets: inherit

  # ============================================
  # Build Job
  # ============================================

  build:
    name: Build Image
    runs-on: ubuntu-latest
    needs: [shellcheck, markdownlint, validate-yaml]
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export image
        id: build
        uses: ./.github/actions/core/build-image
        with:
          image-tag: sindri:ci-${{ github.sha }}
          cache-key-prefix: sindri-ci

      - name: Save image as artifact
        run: |
          docker save sindri:ci-${{ github.sha }} | gzip > sindri-image.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v5
        with:
          name: sindri-image-${{ github.sha }}
          path: sindri-image.tar.gz
          retention-days: 1

  # ============================================
  # Test Matrix Generation
  # ============================================

  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    needs: [shellcheck, markdownlint, validate-yaml]
    outputs:
      providers: ${{ steps.matrix.outputs.providers }}
      extensions: ${{ steps.matrix.outputs.extensions }}
    steps:
      - uses: actions/checkout@v5

      - name: Generate matrices
        id: matrix
        run: |
          # Determine which providers to test based on trigger type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            INPUT_PROVIDERS="${{ github.event.inputs.providers }}"
            if [[ "$INPUT_PROVIDERS" == "all" ]]; then
              # All supported providers including DigitalOcean
              PROVIDERS='["docker", "fly", "devpod-aws", "devpod-gcp", "devpod-azure", "devpod-do", "devpod-k8s"]'
            else
              # Convert comma-separated to JSON array
              PROVIDERS=$(echo "$INPUT_PROVIDERS" | jq -Rc 'split(",") | map(ltrimstr(" ") | rtrimstr(" "))')
            fi
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Main branch: test primary providers
            PROVIDERS='["docker", "fly"]'
          else
            # PRs and other branches: minimal testing
            PROVIDERS='["docker"]'
          fi

          # Generate extension list
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Use provided extensions or default
            EXTENSIONS='${{ github.event.inputs.extensions-to-test }}'
            if [[ -z "$EXTENSIONS" || "$EXTENSIONS" == "" ]]; then
              EXTENSIONS='["nodejs", "python"]'
            fi
          else
            # Default: use quick matrix from config
            EXTENSIONS=$(yq -o=json -I=0 '.test_matrices.quick.extensions' .github/test-configs/extensions.yaml 2>/dev/null)
          fi

          # Fallback if yq fails
          if [[ -z "$EXTENSIONS" || "$EXTENSIONS" == "null" ]]; then
            EXTENSIONS='["nodejs", "python"]'
          fi

          echo "providers=$PROVIDERS" >> $GITHUB_OUTPUT
          echo "extensions=$EXTENSIONS" >> $GITHUB_OUTPUT

          echo "::notice title=Test Providers::$PROVIDERS"
          echo "::notice title=Test Extensions::$EXTENSIONS"

  # ============================================
  # Unified Provider Testing
  # ============================================
  # Each provider runs CLI tests, extension tests, and integration tests
  # This ensures consistent test coverage across all deployment targets

  test-providers:
    name: Test ${{ matrix.provider }}
    needs: [build, generate-matrix]
    if: needs.generate-matrix.outputs.providers != '[]'
    strategy:
      fail-fast: false
      matrix:
        provider: ${{ fromJson(needs.generate-matrix.outputs.providers) }}
    uses: ./.github/workflows/test-provider.yml
    with:
      provider: ${{ matrix.provider }}
      test-suite: ${{ github.event.inputs.test-suite || 'integration' }}
      extension-profile: ${{ github.event.inputs.extension-profile || 'minimal' }}
      extensions-to-test: ${{ needs.generate-matrix.outputs.extensions }}
      skip-cleanup: ${{ github.event.inputs.skip-cleanup == 'true' }}
      image: sindri:ci-${{ github.sha }}
      image-artifact: sindri-image-${{ github.sha }}
    secrets: inherit

  # ============================================
  # CI Status Checks
  # ============================================

  ci-required:
    name: CI Required Checks
    runs-on: ubuntu-latest
    needs:
      - shellcheck
      - markdownlint
      - validate-yaml
      - build
    if: ${{ always() }}
    steps:
      - name: Check required jobs
        run: |
          # Check if any required job failed
          SHELLCHECK="${{ needs.shellcheck.result }}"
          MARKDOWNLINT="${{ needs.markdownlint.result }}"
          VALIDATE_YAML="${{ needs.validate-yaml.result }}"
          BUILD="${{ needs.build.result }}"

          if [[ "$SHELLCHECK" != "success" ]] || \
             [[ "$MARKDOWNLINT" != "success" ]] || \
             [[ "$VALIDATE_YAML" != "success" ]] || \
             [[ "$BUILD" != "success" ]]; then
            echo "❌ Required CI checks failed"
            echo "Results:"
            echo "  shellcheck: $SHELLCHECK"
            echo "  markdownlint: $MARKDOWNLINT"
            echo "  validate-yaml: $VALIDATE_YAML"
            echo "  build: $BUILD"
            exit 1
          fi

          echo "✅ Required CI checks passed"

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs:
      - ci-required
      - test-providers
    if: ${{ always() }}
    steps:
      - name: Check overall status
        run: |
          REQUIRED="${{ needs.ci-required.result }}"
          TEST_PROVIDERS="${{ needs.test-providers.result }}"

          # Required checks must pass
          if [[ "$REQUIRED" != "success" ]]; then
            echo "❌ CI failed - required checks did not pass"
            exit 1
          fi

          # Provider tests should pass if they ran
          if [[ "$TEST_PROVIDERS" != "skipped" ]] && [[ "$TEST_PROVIDERS" != "success" ]]; then
            echo "❌ CI failed - provider tests failed"
            echo "  test-providers: $TEST_PROVIDERS"
            exit 1
          fi

          echo "✅ CI passed"
          echo "Results:"
          echo "  ci-required: $REQUIRED"
          echo "  test-providers: $TEST_PROVIDERS"

      - name: Generate summary
        if: always()
        run: |
          echo "# CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Unified Provider Testing" >> $GITHUB_STEP_SUMMARY
          echo "Each selected provider receives **complete test coverage**:" >> $GITHUB_STEP_SUMMARY
          echo "- CLI Tests (sindri, extension-manager commands)" >> $GITHUB_STEP_SUMMARY
          echo "- Extension Tests (validation, installation)" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests (end-to-end workflows)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Required Checks | ${{ needs.ci-required.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Providers | ${{ needs.test-providers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
