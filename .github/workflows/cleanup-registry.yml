name: Cleanup Container Registry

# Automated cleanup of old CI images from GitHub Container Registry
# Runs daily and can be triggered manually

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run - show what would be deleted without actually deleting'
        required: false
        default: false
        type: boolean
      retention-days:
        description: 'Days to retain CI images'
        required: false
        default: '7'
        type: string

permissions:
  packages: write
  contents: read

jobs:
  cleanup-ci-images:
    name: Cleanup Old CI Images
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old CI images
        uses: actions/github-script@v8
        with:
          script: |
            const retentionDays = parseInt('${{ github.event.inputs.retention-days || '7' }}');
            const dryRun = '${{ github.event.inputs.dry-run }}' === 'true';
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - retentionDays);

            console.log(`Retention period: ${retentionDays} days`);
            console.log(`Cutoff date: ${cutoffDate.toISOString()}`);
            console.log(`Dry run: ${dryRun}`);
            console.log('');

            // Get organization or user
            const owner = context.repo.owner;
            const packageName = context.repo.repo;

            console.log(`Repository: ${owner}/${packageName}`);
            console.log('');

            let deletedCount = 0;
            let keptCount = 0;
            let page = 1;
            const perPage = 100;

            while (true) {
              let packages;
              try {
                // Get package versions
                const response = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                  package_type: 'container',
                  package_name: packageName,
                  org: owner,
                  page: page,
                  per_page: perPage,
                });
                packages = response.data;
              } catch (error) {
                console.log(`Failed to fetch packages: ${error.message}`);
                break;
              }

              if (packages.length === 0) {
                break;
              }

              console.log(`Processing page ${page} (${packages.length} versions)...`);

              for (const pkg of packages) {
                const tags = pkg.metadata?.container?.tags || [];
                const createdAt = new Date(pkg.created_at);
                const age = Math.floor((Date.now() - createdAt) / (1000 * 60 * 60 * 24));

                // Check if this is a CI image (ci-* or ci-branch-*)
                const isCIImage = tags.some(t => t.startsWith('ci-') && !t.startsWith('ci-passed-'));
                const isCIPassed = tags.some(t => t.startsWith('ci-passed-'));
                const isRelease = tags.some(t => t.match(/^v?\d+\.\d+\.\d+/));

                // Skip release images and ci-passed images
                if (isRelease || isCIPassed) {
                  keptCount++;
                  continue;
                }

                // Delete old CI images
                if (isCIImage && createdAt < cutoffDate) {
                  const tagList = tags.join(', ');
                  console.log(`  [DELETE] ID ${pkg.id}: ${tagList} (${age}d old, created: ${createdAt.toISOString()})`);

                  if (!dryRun) {
                    try {
                      await github.rest.packages.deletePackageVersionForOrg({
                        package_type: 'container',
                        package_name: packageName,
                        org: owner,
                        package_version_id: pkg.id,
                      });
                      deletedCount++;
                    } catch (error) {
                      console.log(`    Failed to delete: ${error.message}`);
                    }
                  } else {
                    deletedCount++;
                  }
                } else {
                  keptCount++;
                }
              }

              page++;
            }

            console.log('');
            console.log('Summary:');
            console.log(`  Deleted: ${deletedCount} images`);
            console.log(`  Kept: ${keptCount} images`);
            if (dryRun) {
              console.log('  Mode: DRY RUN (no actual deletions)');
            }

  cleanup-untagged-images:
    name: Cleanup Untagged Images
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup untagged images
        uses: actions/github-script@v8
        with:
          script: |
            const dryRun = '${{ github.event.inputs.dry-run }}' === 'true';
            const owner = context.repo.owner;
            const packageName = context.repo.repo;

            console.log('Cleaning up untagged images...');
            console.log('');

            let deletedCount = 0;
            let page = 1;
            const perPage = 100;

            while (true) {
              let packages;
              try {
                const response = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                  package_type: 'container',
                  package_name: packageName,
                  org: owner,
                  page: page,
                  per_page: perPage,
                });
                packages = response.data;
              } catch (error) {
                console.log(`Failed to fetch packages: ${error.message}`);
                break;
              }

              if (packages.length === 0) {
                break;
              }

              for (const pkg of packages) {
                const tags = pkg.metadata?.container?.tags || [];

                // Delete if no tags
                if (tags.length === 0) {
                  console.log(`  [DELETE] Untagged image ID ${pkg.id}`);

                  if (!dryRun) {
                    try {
                      await github.rest.packages.deletePackageVersionForOrg({
                        package_type: 'container',
                        package_name: packageName,
                        org: owner,
                        package_version_id: pkg.id,
                      });
                      deletedCount++;
                    } catch (error) {
                      console.log(`    Failed to delete: ${error.message}`);
                    }
                  } else {
                    deletedCount++;
                  }
                }
              }

              page++;
            }

            console.log('');
            console.log(`Deleted ${deletedCount} untagged images`);
            if (dryRun) {
              console.log('Mode: DRY RUN (no actual deletions)');
            }
