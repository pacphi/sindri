---
# .github/workflows/deploy-sindri.yml
# Reusable workflow for deploying Sindri configurations
name: Deploy Sindri

on:
  workflow_call:
    inputs:
      config-path:
        description: Path to sindri.yaml configuration file
        required: true
        type: string
    outputs:
      deployment-id:
        description: Deployment identifier
        value: ${{ jobs.deploy.outputs.deployment-id }}
      app-url:
        description: Application URL (if applicable)
        value: ${{ jobs.deploy.outputs.app-url }}

  workflow_dispatch:
    inputs:
      config-path:
        description: Path to sindri.yaml configuration file
        required: true
        type: string

jobs:
  deploy:
    name: Deploy from ${{ inputs.config-path }}
    runs-on: ubuntu-latest
    outputs:
      deployment-id: ${{ steps.deploy.outputs.deployment-id }}
      app-url: ${{ steps.deploy.outputs.app-url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yq
        run: pip install yq

      - name: Parse configuration
        id: parse
        run: |
          CONFIG="${{ inputs.config-path }}"

          if [[ ! -f "$CONFIG" ]]; then
            echo "Error: Config file not found: $CONFIG"
            exit 1
          fi

          NAME=$(yq '.name' "$CONFIG")
          PROVIDER=$(yq '.deployment.provider' "$CONFIG")
          PROFILE=$(yq '.extensions.profile // "minimal"' "$CONFIG")

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "provider=$PROVIDER" >> $GITHUB_OUTPUT
          echo "profile=$PROFILE" >> $GITHUB_OUTPUT

          echo "Deployment: $NAME (provider: $PROVIDER, profile: $PROFILE)"

      - name: Setup Fly.io CLI
        if: steps.parse.outputs.provider == 'fly'
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Validate configuration
        run: |
          ./cli/sindri config validate --config "${{ inputs.config-path }}"

      - name: Deploy
        id: deploy
        run: |
          CONFIG="${{ inputs.config-path }}"
          PROVIDER="${{ steps.parse.outputs.provider }}"
          NAME="${{ steps.parse.outputs.name }}"

          case "$PROVIDER" in
            fly)
              # Deploy to Fly.io
              ./cli/sindri deploy --config "$CONFIG" --provider fly

              # Get app URL
              APP_URL="https://${NAME}.fly.dev"
              echo "deployment-id=$NAME" >> $GITHUB_OUTPUT
              echo "app-url=$APP_URL" >> $GITHUB_OUTPUT
              ;;
            docker*)
              # Deploy locally (for testing)
              ./cli/sindri deploy --config "$CONFIG" --provider docker

              echo "deployment-id=$NAME" >> $GITHUB_OUTPUT
              echo "app-url=" >> $GITHUB_OUTPUT
              ;;
            devpod)
              # Deploy DevPod workspace
              ./cli/sindri deploy --config "$CONFIG" --provider devpod

              echo "deployment-id=$NAME" >> $GITHUB_OUTPUT
              echo "app-url=" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "Unknown provider: $PROVIDER"
              exit 1
              ;;
          esac
        env:
          # All secrets available - CLI uses only what's needed per provider
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Name | ${{ steps.parse.outputs.name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | ${{ steps.parse.outputs.provider }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Profile | ${{ steps.parse.outputs.profile }} |" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ steps.deploy.outputs.app-url }}" ]]; then
            echo "| URL | ${{ steps.deploy.outputs.app-url }} |" >> $GITHUB_STEP_SUMMARY
          fi
