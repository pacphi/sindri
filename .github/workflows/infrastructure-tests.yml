name: Infrastructure Tests

"on":
  workflow_call:

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  TEST_APP_NAME: sindri-infra-test

jobs:
  infrastructure:
    name: Infrastructure Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5

      - name: Install Fly CLI
        run: |
          curl -L https://fly.io/install.sh | sh
          echo "$HOME/.fly/bin" >> $GITHUB_PATH

      - name: Deploy test VM
        run: |
          APP_NAME="${TEST_APP_NAME}-${{ github.run_id }}"

          # Create app
          flyctl apps create "$APP_NAME" --org personal || true

          # Deploy with minimal resources
          flyctl deploy \
            --app "$APP_NAME" \
            --vm-size shared-cpu-1x \
            --vm-memory 1024 \
            --strategy immediate

      - name: Test SSH connectivity
        run: |
          APP_NAME="${TEST_APP_NAME}-${{ github.run_id }}"

          # Test SSH via hallpass
          flyctl ssh console -a "$APP_NAME" --command "echo 'SSH test successful'"

      - name: Test volume mount
        run: |
          APP_NAME="${TEST_APP_NAME}-${{ github.run_id }}"

          # Verify volume is mounted
          flyctl ssh console -a "$APP_NAME" --command "df -h /workspace"
          flyctl ssh console -a "$APP_NAME" --command "ls -la /workspace/"

      - name: Test persistence
        run: |
          APP_NAME="${TEST_APP_NAME}-${{ github.run_id }}"

          # Create test file
          flyctl ssh console -a "$APP_NAME" --command "echo 'test data' > /workspace/test-persistence.txt"

          # Restart machine
          MACHINE_ID=$(flyctl machine list -a "$APP_NAME" --json | jq -r '.[0].id')
          flyctl machine restart "$MACHINE_ID" -a "$APP_NAME"

          # Wait for restart
          sleep 30

          # Verify file persists
          flyctl ssh console -a "$APP_NAME" --command "cat /workspace/test-persistence.txt"

      - name: Test extension system
        run: |
          APP_NAME="${TEST_APP_NAME}-${{ github.run_id }}"

          # Test extension manager
          flyctl ssh console -a "$APP_NAME" --command "extension-manager list"
          flyctl ssh console -a "$APP_NAME" --command "extension-manager status nodejs"

      - name: Test secrets management
        run: |
          APP_NAME="${TEST_APP_NAME}-${{ github.run_id }}"

          # Set a test secret
          flyctl secrets set TEST_SECRET="test_value" -a "$APP_NAME"

          # Wait for secret propagation
          sleep 10

          # Verify SOPS encryption
          flyctl ssh console -a "$APP_NAME" --command "test -f ~/.secrets/secrets.enc.yaml"

      - name: Cleanup
        if: always()
        run: |
          APP_NAME="${TEST_APP_NAME}-${{ github.run_id }}"
          flyctl apps destroy "$APP_NAME" --yes || true
