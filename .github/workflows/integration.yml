name: Integration Tests

"on":
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Saturday at 2:00 AM UTC
    - cron: "0 2 * * 6"
  workflow_dispatch:

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  REGISTRY_IMAGE: registry.fly.io/sindri-registry

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Phase 1: Quick validation checks
  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v5

      - name: Validate shell scripts
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          find . -name "*.sh" -type f | xargs shellcheck -S error || exit 1

      - name: Validate YAML files
        run: |
          pip install yamllint
          # Exclude node_modules from validation
          find . -path ./node_modules -prune -o \( -name "*.yaml" -o -name "*.yml" \) -type f -print | xargs yamllint -c .yamllint.yml

      - name: Check extension manager syntax
        run: |
          bash -n cli/extension-manager

  # Phase 2: Manifest and extension validation
  manifest-validation:
    name: Manifest Validation
    needs: quick-checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v5

      - name: Validate extension manifests
        run: |
          for ext in docker/lib/extensions/*/extension.yaml; do
            if [[ -f "$ext" ]]; then
              echo "Validating $ext"
              # Check required fields
              yq e '.metadata.name' "$ext" > /dev/null || exit 1
              yq e '.metadata.version' "$ext" > /dev/null || exit 1
              yq e '.providers' "$ext" > /dev/null || exit 1
            fi
          done

      - name: Validate registry
        run: |
          yq e '.extensions' docker/lib/registry.yaml > /dev/null || exit 1

      - name: Validate profiles
        run: |
          yq e '.profiles' docker/lib/profiles.yaml > /dev/null || exit 1

  # Phase 3: Dependency chain tests
  dependency-chain-tests:
    name: Dependency Chain Tests
    needs: manifest-validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: true
      max-parallel: 3
      matrix:
        test:
          - name: nodejs-devtools
            deps: nodejs
          - name: openskills
            deps: nodejs
          - name: playwright
            deps: nodejs
    steps:
      - uses: actions/checkout@v5

      - name: Test ${{ matrix.test.name }} dependency chain
        run: |
          echo "Testing dependency resolution for ${{ matrix.test.name }}"
          echo "Expected dependencies: ${{ matrix.test.deps }}"
          # Add actual dependency resolution test here

  # Phase 4: Infrastructure tests
  infrastructure-tests:
    name: Infrastructure Tests
    needs: dependency-chain-tests
    uses: ./.github/workflows/infrastructure-tests.yml
    secrets: inherit

  # Phase 5: Individual extension tests
  per-extension-tests:
    name: Extension Tests
    needs: infrastructure-tests
    uses: ./.github/workflows/per-extension-tests.yml
    secrets: inherit
    strategy:
      fail-fast: false
      max-parallel: 3

  # Phase 6: Extension combination tests
  extension-combinations:
    name: Extension Combinations
    needs: per-extension-tests
    uses: ./.github/workflows/extension-combinations.yml
    secrets: inherit
    strategy:
      fail-fast: false
      max-parallel: 3

  # Final summary
  test-summary:
    name: Test Summary
    needs: [extension-combinations]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check overall status
        run: |
          if [[ "${{ needs.extension-combinations.result }}" == "success" ]]; then
            echo "✅ All tests passed successfully!"
          else
            echo "❌ Some tests failed. Check the logs above."
            exit 1
          fi
