name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      provider:
        description: Deployment provider
        required: true
        type: choice
        options:
          - docker
          - fly
          - devpod-aws
          - devpod-gcp
          - devpod-azure
          - devpod-do
          - kubernetes
          - ssh
      environment:
        description: Deployment environment
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      app-name:
        description: Application name (leave empty for auto-generated)
        required: false
        type: string
      extension-profile:
        description: Extension profile to install
        required: false
        default: minimal
        type: choice
        options:
          - minimal
          - fullstack
          - ai-dev
          - anthropic-dev
          - systems
          - enterprise
          - devops
          - mobile
          - visionflow-core
          - visionflow-data-scientist
          - visionflow-creative
          - visionflow-full
      vm-size:
        description: VM/Instance size (provider-specific)
        required: false
        default: medium
        type: choice
        options:
          - small
          - medium
          - large
          - xlarge
      region:
        description: Deployment region (provider-specific)
        required: false
        type: string
      auto-cleanup:
        description: Auto-cleanup after hours (0 = no cleanup)
        required: false
        default: "24"
        type: string
      run-tests:
        description: Run tests after deployment
        required: false
        default: true
        type: boolean
      notify-slack:
        description: Send Slack notification on completion
        required: false
        default: false
        type: boolean

env:
  DEPLOYMENT_ID: ${{ github.event.inputs.provider }}-${{ github.event.inputs.environment }}-${{ github.run_id }}

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    outputs:
      app-name: ${{ steps.validate.outputs.app-name }}
      vm-size: ${{ steps.validate.outputs.vm-size }}
      region: ${{ steps.validate.outputs.region }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate and process inputs
        id: validate
        run: |
          # Generate app name if not provided
          if [[ -z "${{ github.event.inputs.app-name }}" ]]; then
            APP_NAME="sindri-${{ github.event.inputs.environment }}-${{ github.run_number }}"
          else
            APP_NAME="${{ github.event.inputs.app-name }}"
          fi

          # Map size to provider-specific values
          case "${{ github.event.inputs.vm-size }}" in
            small)
              case "${{ github.event.inputs.provider }}" in
                fly) VM_SIZE="shared-cpu-1x" ;;
                devpod-aws) VM_SIZE="t3.small" ;;
                devpod-gcp) VM_SIZE="e2-small" ;;
                devpod-azure) VM_SIZE="Standard_B1s" ;;
                devpod-do) VM_SIZE="s-1vcpu-1gb" ;;
                *) VM_SIZE="small" ;;
              esac
              ;;
            medium)
              case "${{ github.event.inputs.provider }}" in
                fly) VM_SIZE="shared-cpu-2x" ;;
                devpod-aws) VM_SIZE="t3.medium" ;;
                devpod-gcp) VM_SIZE="e2-medium" ;;
                devpod-azure) VM_SIZE="Standard_B2s" ;;
                devpod-do) VM_SIZE="s-2vcpu-4gb" ;;
                *) VM_SIZE="medium" ;;
              esac
              ;;
            large)
              case "${{ github.event.inputs.provider }}" in
                fly) VM_SIZE="dedicated-cpu-2x" ;;
                devpod-aws) VM_SIZE="t3.large" ;;
                devpod-gcp) VM_SIZE="e2-standard-4" ;;
                devpod-azure) VM_SIZE="Standard_D2s_v3" ;;
                devpod-do) VM_SIZE="s-4vcpu-8gb" ;;
                *) VM_SIZE="large" ;;
              esac
              ;;
            xlarge)
              case "${{ github.event.inputs.provider }}" in
                fly) VM_SIZE="dedicated-cpu-4x" ;;
                devpod-aws) VM_SIZE="t3.xlarge" ;;
                devpod-gcp) VM_SIZE="e2-standard-8" ;;
                devpod-azure) VM_SIZE="Standard_D4s_v3" ;;
                devpod-do) VM_SIZE="s-8vcpu-16gb" ;;
                *) VM_SIZE="xlarge" ;;
              esac
              ;;
          esac

          # Set default region if not provided
          if [[ -z "${{ github.event.inputs.region }}" ]]; then
            case "${{ github.event.inputs.provider }}" in
              fly) REGION="sjc" ;;
              devpod-aws) REGION="us-west-2" ;;
              devpod-gcp) REGION="us-central1-a" ;;
              devpod-azure) REGION="eastus" ;;
              devpod-do) REGION="nyc3" ;;
              *) REGION="default" ;;
            esac
          else
            REGION="${{ github.event.inputs.region }}"
          fi

          echo "app-name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "vm-size=$VM_SIZE" >> $GITHUB_OUTPUT
          echo "region=$REGION" >> $GITHUB_OUTPUT

          echo "::notice title=Deployment Configuration::App: $APP_NAME, Size: $VM_SIZE, Region: $REGION"

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: validate-inputs
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build image
        id: build
        uses: ./.github/actions/core/build-image
        with:
          image-tag: sindri:${{ env.DEPLOYMENT_ID }}
          cache-key-prefix: sindri-deploy

  deploy:
    name: Deploy to ${{ github.event.inputs.provider }}
    runs-on: ubuntu-latest
    needs: [validate-inputs, build-image]
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
      deployment-status: ${{ steps.deploy.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Generate sindri.yaml
        run: |
          cat > sindri.yaml << EOF
          name: ${{ needs.validate-inputs.outputs.app-name }}
          deployment:
            provider: ${{ github.event.inputs.provider }}
            environment: ${{ github.event.inputs.environment }}
            resources:
              memory: 2GB
              cpus: 2
              disk: 20GB
          extensions:
            profile: ${{ github.event.inputs.extension-profile }}
          EOF

      # Docker deployment
      - name: Deploy to Docker
        if: github.event.inputs.provider == 'docker'
        id: deploy-docker
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          ./cli/sindri deploy --provider docker
          echo "url=http://localhost:8080" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT

      # Fly.io deployment
      - name: Setup Fly.io
        if: github.event.inputs.provider == 'fly'
        uses: ./.github/actions/providers/fly/setup
        with:
          app-name: ${{ needs.validate-inputs.outputs.app-name }}
          fly-api-token: ${{ secrets.FLY_API_TOKEN }}
          region: ${{ needs.validate-inputs.outputs.region }}

      - name: Deploy to Fly.io
        if: github.event.inputs.provider == 'fly'
        id: deploy-fly
        uses: ./.github/actions/providers/fly/deploy
        with:
          app-name: ${{ needs.validate-inputs.outputs.app-name }}
          fly-api-token: ${{ secrets.FLY_API_TOKEN }}
          vm-size: ${{ needs.validate-inputs.outputs.vm-size }}
          extension-profile: ${{ github.event.inputs.extension-profile }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      # DevPod deployments
      - name: Setup DevPod provider
        if: >-
          startsWith(github.event.inputs.provider, 'devpod') ||
          github.event.inputs.provider == 'kubernetes' ||
          github.event.inputs.provider == 'ssh'
        uses: ./.github/actions/providers/devpod/setup
        with:
          provider-type: ${{ github.event.inputs.provider }}
          provider-name: ${{ github.event.inputs.provider }}-${{ github.event.inputs.environment }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Deploy DevPod workspace
        if: >-
          startsWith(github.event.inputs.provider, 'devpod') ||
          github.event.inputs.provider == 'kubernetes' ||
          github.event.inputs.provider == 'ssh'
        id: deploy-devpod
        uses: ./.github/actions/providers/devpod/deploy
        with:
          workspace-id: ${{ needs.validate-inputs.outputs.app-name }}
          provider-id: ${{ github.event.inputs.provider }}-${{ github.event.inputs.environment }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Consolidate deployment outputs
      - name: Set deployment outputs
        id: deploy
        run: |
          if [[ "${{ github.event.inputs.provider }}" == "docker" ]]; then
            echo "url=${{ steps.deploy-docker.outputs.url }}" >> $GITHUB_OUTPUT
            echo "status=${{ steps.deploy-docker.outputs.status }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.provider }}" == "fly" ]]; then
            echo "url=${{ steps.deploy-fly.outputs.app-url }}" >> $GITHUB_OUTPUT
            echo "status=${{ steps.deploy-fly.outputs.status }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ steps.deploy-devpod.outputs.workspace-url }}" >> $GITHUB_OUTPUT
            echo "status=${{ steps.deploy-devpod.outputs.workspace-status }}" >> $GITHUB_OUTPUT
          fi

  test-deployment:
    name: Test Deployment
    needs: [validate-inputs, deploy]
    if: github.event.inputs.run-tests == 'true'
    uses: ./.github/workflows/test-provider.yml
    with:
      provider: ${{ github.event.inputs.provider }}
      test-level: quick
      skip-cleanup: true
    secrets: inherit

  schedule-cleanup:
    name: Schedule Cleanup
    runs-on: ubuntu-latest
    needs: [validate-inputs, deploy]
    if: github.event.inputs.auto-cleanup != '0'
    steps:
      - name: Schedule cleanup job
        run: |
          echo "Cleanup scheduled for ${{ github.event.inputs.auto-cleanup }} hours from now"

          # Create cleanup schedule (would use GitHub API or external scheduler in production)
          cat > cleanup-config.json << EOF
          {
            "app_name": "${{ needs.validate-inputs.outputs.app-name }}",
            "provider": "${{ github.event.inputs.provider }}",
            "cleanup_at": "$(date -d "+${{ github.event.inputs.auto-cleanup }} hours" --iso-8601=seconds)",
            "deployment_id": "${{ env.DEPLOYMENT_ID }}"
          }
          EOF

          # Upload cleanup config as artifact
          echo "Cleanup configuration saved"

      - name: Upload cleanup config
        uses: actions/upload-artifact@v6
        with:
          name: cleanup-config-${{ env.DEPLOYMENT_ID }}
          path: cleanup-config.json
          retention-days: 7

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [validate-inputs, deploy]
    if: always() && github.event.inputs.notify-slack == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Prepare notification
        id: notification
        run: |
          STATUS="${{ needs.deploy.outputs.deployment-status }}"
          MESSAGE=$(.github/scripts/generate-slack-notification.sh \
            "$STATUS" \
            "${{ needs.validate-inputs.outputs.app-name }}" \
            "${{ github.event.inputs.provider }}" \
            "${{ github.event.inputs.environment }}" \
            "${{ needs.deploy.outputs.deployment-url }}" \
            "${{ github.actor }}" \
            "${{ github.run_id }}")

          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '${{ steps.notification.outputs.message }}'

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate-inputs, deploy]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸš€ Manual Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Application** | ${{ needs.validate-inputs.outputs.app-name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Provider** | ${{ github.event.inputs.provider }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Profile** | ${{ github.event.inputs.extension-profile }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Size** | ${{ needs.validate-inputs.outputs.vm-size }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ needs.validate-inputs.outputs.region }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.deploy.outputs.deployment-status }}" == "success" ]]; then
            echo "âœ… **Deployment Successful**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Access URL:** ${{ needs.deploy.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment Failed**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Auto-Cleanup" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event.inputs.auto-cleanup }}" != "0" ]]; then
            echo "â° Resources will be cleaned up after **${{ github.event.inputs.auto-cleanup }} hours**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No auto-cleanup scheduled. Remember to clean up resources manually." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Deployment ID: ${{ env.DEPLOYMENT_ID }}_" >> $GITHUB_STEP_SUMMARY
