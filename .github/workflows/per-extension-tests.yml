name: Per-Extension Tests

"on":
  workflow_call:

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  TEST_APP_PREFIX: sindri-test

jobs:
  generate-matrix:
    name: Generate Extension Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v5

      - name: Generate extension matrix
        id: set-matrix
        run: |
          # Get all extensions from registry
          extensions=$(
            find docker/lib/extensions -mindepth 1 -maxdepth 1 \
              -type d -exec basename {} \; | sort
          )

          # Create JSON matrix
          matrix_json='{"extension":['
          first=true
          for ext in $extensions; do
            if [[ "$first" != "true" ]]; then
              matrix_json+=","
            fi
            matrix_json+="\"$ext\""
            first=false
          done
          matrix_json+=']}'

          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix_json"

  test-extension:
    name: Test ${{ matrix.extension }}
    needs: generate-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: ${{fromJson(needs.generate-matrix.outputs.matrix)}}

    steps:
      - uses: actions/checkout@v5

      - name: Set up Fly.io environment
        uses: ./.github/actions/setup-fly-env
        with:
          app-name: >-
            ${{ env.TEST_APP_PREFIX }}-${{ matrix.extension }}-
            ${{ github.run_id }}
          fly-api-token: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy Fly.io VM
        uses: ./.github/actions/deploy-fly-vm
        with:
          app-name: >-
            ${{ env.TEST_APP_PREFIX }}-${{ matrix.extension }}-
            ${{ github.run_id }}
          extension: ${{ matrix.extension }}

      - name: Install extension
        uses: ./.github/actions/install-extension
        with:
          extension: ${{ matrix.extension }}
          app-name: >-
            ${{ env.TEST_APP_PREFIX }}-${{ matrix.extension }}-
            ${{ github.run_id }}

      - name: Validate extension
        uses: ./.github/actions/validate-extension
        with:
          extension: ${{ matrix.extension }}
          app-name: >-
            ${{ env.TEST_APP_PREFIX }}-${{ matrix.extension }}-
            ${{ github.run_id }}

      - name: Test extension functionality
        run: |
          APP_NAME="${{ env.TEST_APP_PREFIX }}-\
          ${{ matrix.extension }}-${{ github.run_id }}"

          # Run extension-specific tests
          TEST_SCRIPT=".github/scripts/test-${{ matrix.extension }}.sh"
          if [[ -f "$TEST_SCRIPT" ]]; then
            bash "$TEST_SCRIPT" "$APP_NAME"
          else
            echo "Running generic extension test for \
            ${{ matrix.extension }}"
            flyctl ssh console -a "$APP_NAME" \
              --command "extension-manager validate \
              ${{ matrix.extension }}"
          fi

      - name: Test idempotency
        run: |
          APP_NAME="${{ env.TEST_APP_PREFIX }}-${{ matrix.extension }}-${{ github.run_id }}"

          # Re-run installation to test idempotency
          flyctl ssh console -a "$APP_NAME" --command "extension-manager install ${{ matrix.extension }}"
          flyctl ssh console -a "$APP_NAME" --command "extension-manager validate ${{ matrix.extension }}"

      - name: Cleanup Fly.io resources
        if: always()
        uses: ./.github/actions/cleanup-fly-vm
        with:
          app-name: ${{ env.TEST_APP_PREFIX }}-${{ matrix.extension }}-${{ github.run_id }}
