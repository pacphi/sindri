name: Self-Service Deploy (Fly.io)

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "App name (e.g., my-sindri-dev)"
        required: true
        type: string
      region:
        description: "Fly.io region"
        required: false
        default: "sjc"
        type: choice
        options:
          # North America
          - sjc # San Jose, California (US)
          - lax # Los Angeles, California (US)
          - dfw # Dallas, Texas (US)
          - ord # Chicago, Illinois (US)
          - iad # Ashburn, Virginia (US)
          - ewr # Secaucus, New Jersey (US)
          - yyz # Toronto, Canada
          # Europe
          - lhr # London, United Kingdom
          - ams # Amsterdam, Netherlands
          - cdg # Paris, France
          - fra # Frankfurt, Germany
          - arn # Stockholm, Sweden
          # Asia Pacific
          - nrt # Tokyo, Japan
          - sin # Singapore
          - syd # Sydney, Australia
          - bom # Mumbai, India
          # South America
          - gru # SÃ£o Paulo, Brazil
          # Africa
          - jnb # Johannesburg, South Africa
      vm_preset:
        description: "VM resource preset"
        required: false
        default: "medium"
        type: choice
        options:
          - small # 2GB RAM, 1 shared CPU
          - medium # 8GB RAM, 4 shared CPUs (default)
          - large # 16GB RAM, 4 performance CPUs
          - xlarge # 32GB RAM, 8 performance CPUs
      volume_size:
        description: "Persistent volume size (GB)"
        required: false
        default: "30"
        type: string
      extension_profile:
        description: "Extension profile to install"
        required: false
        default: "fullstack"
        type: choice
        options:
          - minimal # Base system only
          - fullstack # Web development (nodejs, python, docker, cloud-tools)
          - ai-dev # AI development (nodejs, python, ai-tools, monitoring)
          - systems # Systems programming (rust, golang, docker)
          - enterprise # Enterprise stack (nodejs, jvm, docker, infra-tools)
          - devops # DevOps tools (docker, k8s, terraform)
          - cloud-native # Cloud-native development
          - custom # Specify custom extensions below
      custom_extensions:
        description: "Custom extensions (comma-separated, only if profile=custom)"
        required: false
        default: ""
        type: string
      skip_cleanup:
        description: "Keep VM running (persistent mode)"
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  setup-config:
    name: Setup Deployment Configuration
    runs-on: ubuntu-latest
    outputs:
      app_name: ${{ steps.setup.outputs.app-name }}
      region: ${{ steps.setup.outputs.region }}
      volume_size: ${{ steps.setup.outputs.volume-size }}
      vm_memory: ${{ steps.setup.outputs.vm-memory }}
      cpu_kind: ${{ steps.setup.outputs.cpu-kind }}
      cpu_count: ${{ steps.setup.outputs.cpu-count }}
      extension_profile: ${{ steps.setup.outputs.extension-profile }}
      custom_extensions: ${{ steps.setup.outputs.custom-extensions }}

    steps:
      - name: Setup Fly.io self-service deployment
        id: setup
        uses: ./.github/actions/setup-fly-self-service
        with:
          app-name: ${{ github.event.inputs.app_name }}
          region: ${{ github.event.inputs.region }}
          vm-preset: ${{ github.event.inputs.vm_preset }}
          volume-size: ${{ github.event.inputs.volume_size }}
          extension-profile: ${{ github.event.inputs.extension_profile }}
          custom-extensions: ${{ github.event.inputs.custom_extensions }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}

  deploy:
    name: Deploy Sindri to Fly.io
    needs: setup-config
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Fly.io environment
        uses: ./.github/actions/setup-fly-env
        with:
          app-name: ${{ needs.setup-config.outputs.app_name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}

      - name: Create Fly.io app
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          echo "Creating Fly.io app: ${{ needs.setup-config.outputs.app_name }}"
          flyctl apps create ${{ needs.setup-config.outputs.app_name }} --org personal || echo "App may already exist"

      - name: Create persistent volume
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          echo "Creating volume for persistent storage..."
          if ! flyctl volumes list -a ${{ needs.setup-config.outputs.app_name }} | grep -q "workspace"; then
            flyctl volumes create workspace \
              -s ${{ needs.setup-config.outputs.volume_size }} \
              -r ${{ needs.setup-config.outputs.region }} \
              -a ${{ needs.setup-config.outputs.app_name }}
          else
            echo "Volume already exists"
          fi

      - name: Deploy using fly-adapter
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          echo "Deploying to Fly.io using provider adapter..."
          # The setup action already generated sindri.yaml
          ./deploy/adapters/fly-adapter.sh sindri.yaml

      - name: Wait for deployment to be ready
        uses: ./.github/actions/wait-fly-deployment
        with:
          app-name: ${{ needs.setup-config.outputs.app_name }}
          fly-api-token: ${{ secrets.FLYIO_AUTH_TOKEN }}
          timeout-seconds: "420"
          expected-status: "started"

      - name: Install extension profile
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          app_name="${{ needs.setup-config.outputs.app_name }}"
          profile="${{ needs.setup-config.outputs.extension_profile }}"

          echo "Installing extension profile: $profile"

          if [ "$profile" = "custom" ]; then
            # Install custom extensions
            extensions="${{ needs.setup-config.outputs.custom_extensions }}"
            echo "Installing custom extensions: $extensions"

            IFS=',' read -ra EXT_ARRAY <<< "$extensions"
            for ext in "${EXT_ARRAY[@]}"; do
              ext=$(echo "$ext" | xargs)  # Trim whitespace
              echo "Installing extension: $ext"
              flyctl ssh console -a "$app_name" --command "extension-manager install $ext"
            done
          else
            # Install profile
            echo "Installing profile: $profile"
            flyctl ssh console -a "$app_name" --command "extension-manager install-profile $profile"
          fi

      - name: Verify deployment
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          app_name="${{ needs.setup-config.outputs.app_name }}"

          echo "## âœ… Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify workspace structure
          if flyctl ssh console -a "$app_name" --command "test -d /workspace/projects && test -d /workspace/config"; then
            echo "âœ… Workspace structure present" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Workspace structure missing" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Verify extension manager
          if flyctl ssh console -a "$app_name" --command "which extension-manager"; then
            echo "âœ… Extension manager available" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Extension manager not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Output connection details
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          app_name="${{ needs.setup-config.outputs.app_name }}"

          echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”Œ Connection Options" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Option 1: Connect via flyctl (Recommended)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "flyctl ssh console -a ${app_name}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Option 2: Direct SSH Access" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# First time only: Configure SSH access" >> $GITHUB_STEP_SUMMARY
          echo "flyctl ssh issue --agent -a ${app_name}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# After setup, connect directly:" >> $GITHUB_STEP_SUMMARY
          echo "ssh developer@${app_name}.fly.dev -p 10022" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ Management Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Check status" >> $GITHUB_STEP_SUMMARY
          echo "flyctl status -a ${app_name}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "flyctl logs -a ${app_name} -n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Suspend VM (save costs when not in use)" >> $GITHUB_STEP_SUMMARY
          echo "flyctl machine stop \$(flyctl machine list -a ${app_name} -q)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Resume VM" >> $GITHUB_STEP_SUMMARY
          echo "flyctl machine start \$(flyctl machine list -a ${app_name} -q)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.skip_cleanup }}" = "true" ]; then
            echo "âš ï¸ **Persistent Mode**: VM will remain running. Remember to suspend or destroy when done to save costs." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup resources
        if: always() && github.event.inputs.skip_cleanup == 'false'
        uses: ./.github/actions/cleanup-fly-vm
        with:
          app-name: ${{ needs.setup-config.outputs.app_name }}
