name: Self-Service Teardown (Fly.io)

"on":
  workflow_dispatch:
    inputs:
      app_name:
        description: "App name to teardown (e.g., my-sindri-dev)"
        required: true
        type: string
      confirmation:
        description: "Type the app name again to confirm deletion"
        required: true
        type: string
      keep_volumes:
        description: "Keep persistent volumes (preserve data)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  validate:
    name: Validate Teardown Request
    runs-on: ubuntu-latest
    outputs:
      app_exists: ${{ steps.check-app.outputs.exists }}
      machine_count: ${{ steps.check-app.outputs.machine_count }}
      volume_count: ${{ steps.check-app.outputs.volume_count }}
      org: ${{ steps.check-app.outputs.org }}

    steps:
      - name: Validate confirmation matches app name
        run: |
          echo "### ðŸ” Validating Teardown Request" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.app_name }}" != "${{ github.event.inputs.confirmation }}" ]; then
            echo "âŒ **App name confirmation does not match**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Expected: \`${{ github.event.inputs.app_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Got: \`${{ github.event.inputs.confirmation }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please re-run the workflow and ensure both fields match exactly." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… **App name confirmed:** \`${{ github.event.inputs.app_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Install Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Check app exists and gather info
        id: check-app
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"

          echo "### ðŸ“Š Resource Inventory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App:** \`$APP_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if app exists
          if ! flyctl apps list --json | \
            jq -e --arg name "$APP_NAME" \
            '.[] | select(.Name == $name)' > /dev/null 2>&1; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âŒ **App does not exist**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The app \`$APP_NAME\` was not found in your Fly.io organization." >> $GITHUB_STEP_SUMMARY
            echo "It may have already been deleted." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "exists=true" >> $GITHUB_OUTPUT

          # Get app info
          APP_INFO=$(flyctl apps list --json | jq --arg name "$APP_NAME" '.[] | select(.Name == $name)')
          ORG=$(echo "$APP_INFO" | jq -r '.Organization.Slug')
          echo "org=$ORG" >> $GITHUB_OUTPUT
          echo "**Organization:** \`$ORG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count machines
          MACHINE_COUNT=$(flyctl machines list --app "$APP_NAME" --json 2>/dev/null | jq '. | length' || echo "0")
          echo "machine_count=$MACHINE_COUNT" >> $GITHUB_OUTPUT
          echo "**Machines:** $MACHINE_COUNT" >> $GITHUB_STEP_SUMMARY

          if [ "$MACHINE_COUNT" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Machine Details</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            flyctl machines list --app "$APP_NAME" 2>/dev/null || echo "Unable to list machines"
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count volumes
          VOLUME_COUNT=$(flyctl volumes list --app "$APP_NAME" --json 2>/dev/null | jq '. | length' || echo "0")
          echo "volume_count=$VOLUME_COUNT" >> $GITHUB_OUTPUT
          echo "**Volumes:** $VOLUME_COUNT" >> $GITHUB_STEP_SUMMARY

          if [ "$VOLUME_COUNT" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Volume Details</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            flyctl volumes list --app "$APP_NAME" 2>/dev/null || echo "Unable to list volumes"
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Display teardown plan
        run: |
          echo "### ðŸ—‘ï¸ Teardown Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "The following resources will be **permanently deleted**:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Machines:** \
          ${{ steps.check-app.outputs.machine_count }} machine(s) \
          will be stopped and destroyed" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.keep_volumes }}" == "true" ]; then
            echo "- âš ï¸ **Volumes:** \
            ${{ steps.check-app.outputs.volume_count }} volume(s) \
            will be **PRESERVED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **Volumes:** \
            ${{ steps.check-app.outputs.volume_count }} volume(s) \
            will be destroyed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- âœ… **App:** \`${{ github.event.inputs.app_name }}\` will be destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Estimate cost savings
          MACHINE_COUNT=${{ steps.check-app.outputs.machine_count }}
          VOLUME_COUNT=${{ steps.check-app.outputs.volume_count }}

          if [ $MACHINE_COUNT -gt 0 ]; then
            echo "### ðŸ’° Estimated Monthly Savings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tearing down this VM will save approximately:" >> $GITHUB_STEP_SUMMARY
            echo "- **Compute:** ~\$3-20/month (depending on machine size and usage)" >> $GITHUB_STEP_SUMMARY

            if [ "${{ github.event.inputs.keep_volumes }}" != "true" ] && [ $VOLUME_COUNT -gt 0 ]; then
              echo "- **Storage:** ~\$3-5/month (20-30GB persistent volume)" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ *VMs auto-suspend when idle, so only delete \
            if you're sure you won't need it.*" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

  teardown:
    name: Teardown Fly.io Resources
    needs: validate
    if: needs.validate.outputs.app_exists == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Install Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Stop and destroy machines
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          echo "### ðŸ›‘ Stopping and Destroying Machines" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          APP_NAME="${{ github.event.inputs.app_name }}"

          # Get list of machines
          MACHINES=$(flyctl machines list --app "$APP_NAME" --json 2>/dev/null || echo "[]")
          MACHINE_IDS=$(echo "$MACHINES" | jq -r '.[].id' 2>/dev/null || true)

          if [ -z "$MACHINE_IDS" ]; then
            echo "â„¹ï¸ No machines found to destroy" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "Found machines to destroy:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            for MACHINE_ID in $MACHINE_IDS; do
              echo "**Destroying machine:** \`$MACHINE_ID\`" >> $GITHUB_STEP_SUMMARY

              # Stop machine first
              flyctl machine stop "$MACHINE_ID" --app "$APP_NAME" --force || true

              # Destroy machine
              if flyctl machine destroy "$MACHINE_ID" --app "$APP_NAME" --force; then
                echo "- âœ… Machine \`$MACHINE_ID\` destroyed" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âš ï¸ Failed to destroy machine \`$MACHINE_ID\` (may already be deleted)" >> $GITHUB_STEP_SUMMARY
              fi
            done

            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Destroy volumes
        if: github.event.inputs.keep_volumes != 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          echo "### ðŸ’¾ Destroying Volumes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          APP_NAME="${{ github.event.inputs.app_name }}"

          # Get list of volumes
          VOLUMES=$(flyctl volumes list --app "$APP_NAME" --json 2>/dev/null || echo "[]")
          VOLUME_IDS=$(echo "$VOLUMES" | jq -r '.[].id' 2>/dev/null || true)

          if [ -z "$VOLUME_IDS" ]; then
            echo "â„¹ï¸ No volumes found to destroy" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "Found volumes to destroy:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            for VOLUME_ID in $VOLUME_IDS; do
              echo "**Destroying volume:** \`$VOLUME_ID\`" >> $GITHUB_STEP_SUMMARY

              if flyctl volumes destroy "$VOLUME_ID" --app "$APP_NAME" --yes; then
                echo "- âœ… Volume \`$VOLUME_ID\` destroyed" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âš ï¸ Failed to destroy volume \`$VOLUME_ID\` (may already be deleted)" >> $GITHUB_STEP_SUMMARY
              fi
            done

            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Skip volume deletion
        if: github.event.inputs.keep_volumes == 'true'
        run: |
          echo "### ðŸ’¾ Preserving Volumes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **Volumes preserved as requested**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** Preserved volumes will continue to \
          incur storage costs (~\$3-5/month)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To manually delete volumes later:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "flyctl volumes list --app ${{ github.event.inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "flyctl volumes destroy <volume-id> --yes" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Destroy app
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          echo "### ðŸ—‘ï¸ Destroying App" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          APP_NAME="${{ github.event.inputs.app_name }}"

          if flyctl apps destroy "$APP_NAME" --yes; then
            echo "âœ… **App \`$APP_NAME\` destroyed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Failed to destroy app** (it may have already been deleted)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify teardown
        env:
          FLY_API_TOKEN: ${{ secrets.FLYIO_AUTH_TOKEN }}
        run: |
          echo "### âœ… Teardown Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          APP_NAME="${{ github.event.inputs.app_name }}"

          # Verify app no longer exists
          if flyctl apps list --json | \
            jq -e --arg name "$APP_NAME" \
            '.[] | select(.Name == $name)' > /dev/null 2>&1; then
            echo "âš ï¸ **Warning:** App still exists in Fly.io" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some resources may not have been fully deleted. Please check manually:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "flyctl status --app $APP_NAME" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **App successfully removed from Fly.io**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All resources have been cleaned up." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Teardown summary
        if: always()
        run: |
          echo "### ðŸ“‹ Teardown Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App Name:** \`${{ github.event.inputs.app_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [\#${{ github.run_number }}]\
          (${{ github.server_url }}/${{ github.repository }}/actions/runs/\
          ${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Actions Taken:**" >> $GITHUB_STEP_SUMMARY
          echo "- Machines: ${{ needs.validate.outputs.machine_count }} destroyed" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.keep_volumes }}" == "true" ]; then
            echo "- Volumes: ${{ needs.validate.outputs.volume_count }} preserved" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Volumes: ${{ needs.validate.outputs.volume_count }} destroyed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- App: Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Need to deploy again?** Use the \
          [Self-Service Deploy (Fly.io)](${{ github.server_url }}/\
          ${{ github.repository }}/actions/workflows/\
          self-service-deploy-fly.yml) workflow" >> $GITHUB_STEP_SUMMARY
