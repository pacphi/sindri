---
# .github/workflows/test-extensions.yml
# Test individual extensions from the registry
# Supports single extension, comma-separated list, or 'all' for all non-protected extensions
name: Test Extensions

on:
  workflow_call:
    inputs:
      extensions:
        description: Single extension, comma-separated list, or 'all'
        required: true
        type: string
      skip-cleanup:
        description: Skip cleanup for debugging
        required: false
        default: false
        type: boolean

  workflow_dispatch:
    inputs:
      extensions:
        description: |
          Extensions to test: single name (nodejs), comma-separated (nodejs,python), or 'all'
        required: true
        type: string
        default: nodejs
      skip-cleanup:
        description: Skip cleanup for debugging
        required: false
        type: boolean
        default: false

jobs:
  generate-matrix:
    name: Generate Extension Matrix
    runs-on: ubuntu-latest
    outputs:
      extensions: ${{ steps.matrix.outputs.extensions }}
      count: ${{ steps.matrix.outputs.count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Generate extension matrix
        id: matrix
        run: |
          INPUT="${{ inputs.extensions }}"

          if [[ "$INPUT" == "all" ]]; then
            # Get all non-protected extensions from registry
            EXTENSIONS=$(yq '.extensions | to_entries | .[] | select(.value.protected != true) | .key' \
              docker/lib/registry.yaml | jq -R . | jq -sc .)
          elif [[ "$INPUT" == *","* ]]; then
            # Multiple extensions - parse comma-separated list
            EXTENSIONS=$(echo "$INPUT" | jq -Rc 'split(",") | map(ltrimstr(" ") | rtrimstr(" "))')
          else
            # Single extension
            EXTENSIONS="[\"$INPUT\"]"
          fi

          COUNT=$(echo "$EXTENSIONS" | jq '. | length')
          echo "extensions=$EXTENSIONS" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "::notice title=Extensions to Test::$COUNT extension(s): $EXTENSIONS"

  build-image:
    name: Build Test Image
    runs-on: ubuntu-latest
    needs: generate-matrix
    if: needs.generate-matrix.outputs.count > 0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: sindri:test
          outputs: type=docker,dest=/tmp/sindri-image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: sindri-test-image
          path: /tmp/sindri-image.tar
          retention-days: 1

  test-extension:
    name: Test ${{ matrix.extension }}
    needs: [generate-matrix, build-image]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        extension: ${{ fromJson(needs.generate-matrix.outputs.extensions) }}
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: sindri-test-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/sindri-image.tar

      - name: Start container
        run: |
          docker run -d --name sindri-test \
            -e CI_MODE=true \
            sindri:test

      - name: Wait for container ready
        run: |
          echo "Waiting for container to be ready..."
          sleep 5
          docker exec sindri-test bash -c "echo 'Container ready'"

      - name: Run extension test
        id: test
        run: |
          echo "Testing extension: ${{ matrix.extension }}"
          docker exec sindri-test \
            /docker/scripts/sindri-test.sh --level extension --extension ${{ matrix.extension }}

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Container logs ==="
          docker logs sindri-test || true
          echo "=== Extension manager logs ==="
          docker exec sindri-test cat /alt/home/developer/workspace/.system/logs/*.log 2>/dev/null || true

      - name: Cleanup
        if: always() && inputs.skip-cleanup != true
        run: docker rm -f sindri-test || true

  summary:
    name: Test Summary
    needs: [generate-matrix, test-extension]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## Extension Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested **${{ needs.generate-matrix.outputs.count }}** extension(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Extensions | \`${{ inputs.extensions }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | Docker (local) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job results above for details." >> $GITHUB_STEP_SUMMARY
