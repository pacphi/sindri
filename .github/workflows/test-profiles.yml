---
# .github/workflows/test-profiles.yml
# Test sindri.yaml configuration files from examples directory
# Tests profile-based deployments across different providers
name: Test Profiles

on:
  workflow_call:
    inputs:
      config-path:
        description: Path to sindri.yaml file (or directory to test all)
        required: true
        type: string
      test-level:
        description: Test level to run
        required: false
        type: string
        default: quick
      skip-cleanup:
        description: Skip cleanup for debugging
        required: false
        type: boolean
        default: false

  workflow_dispatch:
    inputs:
      config-path:
        description: Config file or directory
        required: true
        type: choice
        options:
          # Individual examples - Fly.io
          - examples/fly/minimal.sindri.yaml
          - examples/fly/fullstack.sindri.yaml
          - examples/fly/production.sindri.yaml
          - examples/fly/anthropic-dev.sindri.yaml
          - examples/fly/systems.sindri.yaml
          - examples/fly/mobile.sindri.yaml
          - examples/fly/data-science-high-mem.sindri.yaml
          - examples/fly/gpu-ml-training.sindri.yaml
          - examples/fly/regions/ord.sindri.yaml
          - examples/fly/regions/ams.sindri.yaml
          - examples/fly/regions/iad.sindri.yaml
          # Individual examples - Docker
          - examples/docker/minimal.sindri.yaml
          - examples/docker/fullstack.sindri.yaml
          - examples/docker/ai-dev.sindri.yaml
          - examples/docker/anthropic-dev.sindri.yaml
          - examples/docker/systems.sindri.yaml
          - examples/docker/devops.sindri.yaml
          - examples/docker/data-science.sindri.yaml
          - examples/docker/enterprise.sindri.yaml
          - examples/docker/mobile.sindri.yaml
          - examples/docker/gpu-ai-dev.sindri.yaml
          # Individual examples - DevPod AWS
          - examples/devpod/aws/minimal.sindri.yaml
          - examples/devpod/aws/fullstack.sindri.yaml
          - examples/devpod/aws/ai-dev-gpu.sindri.yaml
          - examples/devpod/aws/regions/us-east-1.sindri.yaml
          - examples/devpod/aws/regions/eu-west-1.sindri.yaml
          # Individual examples - DevPod GCP
          - examples/devpod/gcp/minimal.sindri.yaml
          - examples/devpod/gcp/fullstack.sindri.yaml
          - examples/devpod/gcp/ai-dev.sindri.yaml
          - examples/devpod/gcp/gpu-inference.sindri.yaml
          - examples/devpod/gcp/regions/europe-west1.sindri.yaml
          # Individual examples - DevPod Azure
          - examples/devpod/azure/minimal.sindri.yaml
          - examples/devpod/azure/data-science.sindri.yaml
          - examples/devpod/azure/regions/westeurope.sindri.yaml
          # Individual examples - DevPod DigitalOcean
          - examples/devpod/digitalocean/minimal.sindri.yaml
          - examples/devpod/digitalocean/regions/sfo3.sindri.yaml
          # Individual examples - DevPod Kubernetes
          - examples/devpod/kubernetes/minimal.sindri.yaml
          - examples/devpod/kubernetes/devops.sindri.yaml
          - examples/devpod/kubernetes/systems.sindri.yaml
          - examples/devpod/kubernetes/gpu-workload.sindri.yaml
          # Individual examples - Profiles
          - examples/profiles/minimal.sindri.yaml
          - examples/profiles/fullstack.sindri.yaml
          - examples/profiles/ai-dev.sindri.yaml
          - examples/profiles/anthropic-dev.sindri.yaml
          - examples/profiles/systems.sindri.yaml
          - examples/profiles/devops.sindri.yaml
          - examples/profiles/data-science.sindri.yaml
          - examples/profiles/enterprise.sindri.yaml
          - examples/profiles/mobile.sindri.yaml
          # Individual examples - Custom Extensions
          - examples/custom/python-ml.sindri.yaml
          - examples/custom/rust-wasm.sindri.yaml
          - examples/custom/cloud-native.sindri.yaml
          - examples/custom/polyglot-backend.sindri.yaml
          - examples/custom/frontend-only.sindri.yaml
          - examples/custom/minimal-golang.sindri.yaml
          - examples/custom/security-focused.sindri.yaml
          # Individual examples - Local Kubernetes (kind/k3d)
          - examples/k8s/kind-minimal.sindri.yaml
          - examples/k8s/k3d-with-registry.sindri.yaml
          # Directories (test all in directory)
          - examples/fly/
          - examples/docker/
          - examples/devpod/aws/
          - examples/devpod/gcp/
          - examples/devpod/azure/
          - examples/devpod/digitalocean/
          - examples/devpod/kubernetes/
          - examples/devpod/
          - examples/profiles/
          - examples/custom/
          - examples/k8s/
          - examples/ # All examples
      test-level:
        description: Test level to run
        required: true
        type: choice
        default: quick
        options:
          - quick
          - profile
          - all
      skip-cleanup:
        description: Skip cleanup for debugging
        required: false
        type: boolean
        default: false

jobs:
  discover-configs:
    name: Discover Test Configurations
    runs-on: ubuntu-latest
    outputs:
      configs: ${{ steps.discover.outputs.configs }}
      count: ${{ steps.discover.outputs.count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Discover sindri.yaml files
        id: discover
        run: |
          CONFIG_PATH="${{ inputs.config-path }}"

          if [[ -f "$CONFIG_PATH" ]]; then
            # Single file
            CONFIGS=$(echo "[\"$CONFIG_PATH\"]")
          elif [[ -d "$CONFIG_PATH" ]]; then
            # Directory - find all sindri.yaml files (use -c for compact single-line JSON)
            CONFIGS=$(find "$CONFIG_PATH" -name "*.sindri.yaml" -type f | \
              jq -R . | jq -sc .)
          else
            echo "Error: $CONFIG_PATH is not a file or directory"
            exit 1
          fi

          COUNT=$(echo "$CONFIGS" | jq '. | length')

          echo "configs=$CONFIGS" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT configuration(s) to test"

  test-config:
    name: Test ${{ matrix.config }}
    needs: discover-configs
    if: needs.discover-configs.outputs.count > 0
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        config: ${{ fromJson(needs.discover-configs.outputs.configs) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yq
        run: pip install yq

      - name: Parse sindri.yaml
        id: parse
        run: |
          CONFIG="${{ matrix.config }}"

          # Extract key values
          NAME=$(yq '.name' "$CONFIG")
          PROVIDER=$(yq '.deployment.provider' "$CONFIG")
          PROFILE=$(yq '.extensions.profile // "minimal"' "$CONFIG")

          # Determine provider type for DevPod
          if [[ "$PROVIDER" == "devpod" ]]; then
            DEVPOD_TYPE=$(yq '.providers.devpod.type' "$CONFIG")
            PROVIDER_FULL="devpod-$DEVPOD_TYPE"
          else
            PROVIDER_FULL="$PROVIDER"
          fi

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "provider=$PROVIDER" >> $GITHUB_OUTPUT
          echo "provider-full=$PROVIDER_FULL" >> $GITHUB_OUTPUT
          echo "profile=$PROFILE" >> $GITHUB_OUTPUT
          echo "config-path=$CONFIG" >> $GITHUB_OUTPUT

          echo "Testing: $NAME (provider: $PROVIDER_FULL, profile: $PROFILE)"

      - name: Setup Fly.io CLI
        if: steps.parse.outputs.provider == 'fly'
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Validate configuration
        run: |
          ./cli/sindri config validate --config "${{ matrix.config }}"

      - name: Deploy
        id: deploy
        run: |
          ./cli/sindri deploy --config "${{ matrix.config }}"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Run tests
        run: |
          ./cli/sindri test --config "${{ matrix.config }}" --level "${{ inputs.test-level }}"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Teardown
        if: always() && inputs.skip-cleanup != true
        run: |
          ./cli/sindri destroy --config "${{ matrix.config }}" --force
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

  summary:
    name: Test Summary
    needs: [discover-configs, test-config]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## Profile Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested ${{ needs.discover-configs.outputs.count }} configuration(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Config | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

          # Note: In a real implementation, we'd collect status from each job
          echo "See individual job results above for details." >> $GITHUB_STEP_SUMMARY
