name: Test Provider

# Simplified provider testing workflow
# All tests run INSIDE the container via /docker/scripts/sindri-test.sh
# Supports three test levels: quick, extension, profile

on:
  workflow_call:
    inputs:
      provider:
        description: Provider to test (docker, fly, devpod-aws, devpod-gcp, devpod-azure, devpod-do, devpod-k8s)
        required: true
        type: string
      test-level:
        description: Test level (quick, extension, profile, all)
        required: false
        default: profile
        type: string
      extension-profile:
        description: Extension profile to test
        required: false
        default: minimal
        type: string
      extension:
        description: Extension to test (for extension-level tests)
        required: false
        default: nodejs
        type: string
      skip-cleanup:
        description: Skip resource cleanup for debugging
        required: false
        default: false
        type: boolean
      timeout-minutes:
        description: Maximum time for the test
        required: false
        default: 30
        type: number
      image:
        description: Docker image to use
        required: false
        default: "sindri:latest"
        type: string
      image-artifact:
        description: Name of image artifact to download
        required: false
        default: ""
        type: string

    secrets:
      FLY_API_TOKEN:
        required: false
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false
      GCP_SERVICE_ACCOUNT_KEY:
        required: false
      AZURE_CLIENT_ID:
        required: false
      AZURE_CLIENT_SECRET:
        required: false
      AZURE_TENANT_ID:
        required: false
      DIGITALOCEAN_TOKEN:
        required: false
      KUBECONFIG:
        required: false

    outputs:
      test-status:
        description: Overall test status
        value: ${{ jobs.test.outputs.status }}
      target-id:
        description: Deployment target ID
        value: ${{ jobs.test.outputs.target-id }}

jobs:
  test:
    name: Test ${{ inputs.provider }}
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    outputs:
      status: ${{ steps.run-tests.outputs.status }}
      target-id: ${{ steps.deploy.outputs.target-id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup credentials
        run: |
          chmod +x .github/scripts/providers/setup-credentials.sh
          source .github/scripts/providers/setup-credentials.sh "${{ inputs.provider }}"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Deploy to provider
        id: deploy
        uses: ./.github/actions/core/deploy-provider
        with:
          provider: ${{ inputs.provider }}
          image: ${{ inputs.image }}
          image-artifact: ${{ inputs.image-artifact }}
          extension-profile: ${{ inputs.extension-profile }}
          test-level: ${{ inputs.test-level }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Run tests
        id: run-tests
        run: |
          TARGET_ID="${{ steps.deploy.outputs.target-id }}"

          echo ""
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║  STAGE 4: Running tests inside container                     ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Test Configuration:"
          echo "  Provider:   ${{ inputs.provider }}"
          echo "  Target ID:  $TARGET_ID"
          echo "  Test Level: ${{ inputs.test-level }}"
          echo "  Profile:    ${{ inputs.extension-profile }}"
          echo "  Extension:  ${{ inputs.extension }}"
          echo ""
          echo "This stage executes sindri-test.sh INSIDE the deployed container."
          echo "The test script will:"
          echo "  1. Run CLI validation tests (sindri, extension-manager)"
          echo "  2. Install extensions from the '${{ inputs.extension-profile }}' profile"
          echo "  3. Activate mise environment for installed tools"
          echo "  4. Validate all installed extensions work correctly"
          echo "  5. Clean up by removing installed extensions"
          echo ""
          echo "────────────────────────────────────────────────────────────────"

          # Single remote call executes entire test suite
          chmod +x .github/scripts/providers/run-on-provider.sh

          set +e
          OUTPUT=$(.github/scripts/providers/run-on-provider.sh \
            "${{ inputs.provider }}" \
            "$TARGET_ID" \
            "/docker/scripts/sindri-test.sh --level ${{ inputs.test-level }} --profile ${{ inputs.extension-profile }} --extension ${{ inputs.extension }}")
          EXIT_CODE=$?
          set -e

          echo "$OUTPUT"

          echo ""
          echo "────────────────────────────────────────────────────────────────"

          # Set outputs
          if [[ $EXIT_CODE -eq 0 ]]; then
            echo ""
            echo "✅ Tests passed"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "::notice title=Tests Passed::All tests passed for ${{ inputs.provider }}"
          else
            echo ""
            echo "❌ Tests failed"
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "::error title=Tests Failed::Tests failed for ${{ inputs.provider }}"
            exit 1
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Cleanup
        if: always() && inputs.skip-cleanup != true
        uses: ./.github/actions/core/cleanup-provider
        with:
          provider: ${{ inputs.provider }}
          target-id: ${{ steps.deploy.outputs.target-id }}
          force: true

      - name: Generate summary
        if: always()
        run: |
          echo "## Provider Test Summary: ${{ inputs.provider }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Attribute | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | ${{ inputs.provider }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Level | ${{ inputs.test-level }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Profile | ${{ inputs.extension-profile }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Extension | ${{ inputs.extension }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ steps.run-tests.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target ID | ${{ steps.deploy.outputs.target-id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.run-tests.outputs.status }}" == "success" ]]; then
            echo "✅ **All tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Tests failed**" >> $GITHUB_STEP_SUMMARY
          fi
