---
# .github/workflows/v2-test-extensions.yml
# Test individual v2 extensions from the registry
# Supports single extension, comma-separated list, or 'all' for all non-protected extensions
name: "v2: Test Extensions"

on:
  workflow_call:
    inputs:
      extensions:
        description: Single extension, comma-separated list, or 'all'
        required: true
        type: string
      skip-cleanup:
        description: Skip cleanup for debugging
        required: false
        default: false
        type: boolean

  workflow_dispatch:
    inputs:
      extensions:
        description: |
          Extensions to test: single name (nodejs), comma-separated (nodejs,python), or 'all'
        required: true
        type: string
        default: nodejs
      skip-cleanup:
        description: Skip cleanup for debugging
        required: false
        type: boolean
        default: false

jobs:
  generate-matrix:
    name: Generate Extension Matrix
    runs-on: ubuntu-latest
    outputs:
      extensions: ${{ steps.matrix.outputs.extensions }}
      count: ${{ steps.matrix.outputs.count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Generate extension matrix
        id: matrix
        run: |
          INPUT="${{ inputs.extensions }}"

          # Extensions that require too much memory for standard CI runners (>4GB)
          # These should be tested manually or on larger runners
          SKIP_IN_CI="ai-toolkit jvm haskell xfce-ubuntu guacamole"

          if [[ "$INPUT" == "all" ]]; then
            # Get all non-protected extensions from registry
            ALL_EXTENSIONS=$(yq '.extensions | to_entries | .[] | select(.value.protected != true) | .key' \
              v2/docker/lib/registry.yaml)

            # Filter out high-memory extensions
            FILTERED=""
            for ext in $ALL_EXTENSIONS; do
              if ! echo "$SKIP_IN_CI" | grep -qw "$ext"; then
                FILTERED="$FILTERED $ext"
              else
                echo "::warning title=Skipped::$ext requires >4GB memory, skipping in CI"
              fi
            done

            EXTENSIONS=$(echo $FILTERED | tr ' ' '\n' | grep -v '^$' | jq -R . | jq -sc .)
          elif [[ "$INPUT" == *","* ]]; then
            # Multiple extensions - parse comma-separated list
            EXTENSIONS=$(echo "$INPUT" | jq -Rc 'split(",") | map(ltrimstr(" ") | rtrimstr(" "))')
          else
            # Single extension
            EXTENSIONS="[\"$INPUT\"]"
          fi

          COUNT=$(echo "$EXTENSIONS" | jq '. | length')
          echo "extensions=$EXTENSIONS" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "::notice title=Extensions to Test::$COUNT extension(s): $EXTENSIONS"

  build-image:
    name: Build Test Image
    runs-on: ubuntu-latest
    needs: generate-matrix
    if: needs.generate-matrix.outputs.count > 0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: sindri:test
          outputs: type=docker,dest=/tmp/sindri-image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload image artifact
        uses: actions/upload-artifact@v6
        with:
          name: sindri-test-image
          path: /tmp/sindri-image.tar
          retention-days: 1

  test-extension:
    name: Test ${{ matrix.extension }}
    needs: [generate-matrix, build-image]
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      fail-fast: false
      max-parallel: 2 # Reduced from 4 to limit concurrent memory usage
      matrix:
        extension: ${{ fromJson(needs.generate-matrix.outputs.extensions) }}
    steps:
      - name: Checkout for extension info
        uses: actions/checkout@v6
        with:
          sparse-checkout: v2/docker/lib/extensions

      - name: Download image artifact
        uses: actions/download-artifact@v7
        with:
          name: sindri-test-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/sindri-image.tar

      - name: Determine resource requirements
        id: resources
        run: |
          EXT="${{ matrix.extension }}"
          EXT_YAML="v2/docker/lib/extensions/$EXT/extension.yaml"

          # Default values
          MEMORY="4g"
          SWAP="6g"
          NODE_HEAP="512"

          if [[ -f "$EXT_YAML" ]]; then
            # Get memory requirement in MB from extension
            REQ_MEM=$(yq '.requirements.memory // 256' "$EXT_YAML")

            # Check for nodejs dependency (adds ~256MB)
            HAS_NODEJS_DEP=$(yq '.metadata.dependencies[]? | select(. == "nodejs")' "$EXT_YAML")
            if [[ -n "$HAS_NODEJS_DEP" ]]; then
              REQ_MEM=$((REQ_MEM + 256))
            fi

            # Scale container memory based on requirements
            if [[ $REQ_MEM -ge 2048 ]]; then
              MEMORY="6g"
              SWAP="8g"
              NODE_HEAP="1024"
            elif [[ $REQ_MEM -ge 1024 ]]; then
              MEMORY="5g"
              SWAP="7g"
              NODE_HEAP="768"
            elif [[ $REQ_MEM -ge 512 ]]; then
              MEMORY="4g"
              SWAP="6g"
              NODE_HEAP="512"
            fi

            echo "Extension $EXT requires ${REQ_MEM}MB memory"
          fi

          echo "memory=$MEMORY" >> $GITHUB_OUTPUT
          echo "swap=$SWAP" >> $GITHUB_OUTPUT
          echo "node_heap=$NODE_HEAP" >> $GITHUB_OUTPUT

      - name: Start container
        run: |
          docker run -d --name sindri-test \
            -e CI_MODE=true \
            -e NODE_OPTIONS="--max-old-space-size=${{ steps.resources.outputs.node_heap }}" \
            -e npm_config_maxsockets=5 \
            --memory=${{ steps.resources.outputs.memory }} \
            --memory-swap=${{ steps.resources.outputs.swap }} \
            sindri:test

      - name: Wait for container ready
        run: |
          echo "Waiting for container to be ready..."
          sleep 5
          docker exec sindri-test bash -c "echo 'Container ready'"

      - name: Run extension test
        id: test
        run: |
          echo "Testing extension: ${{ matrix.extension }}"
          docker exec sindri-test \
            /v2/docker/scripts/sindri-test.sh --level extension --extension ${{ matrix.extension }}

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Container resource stats ==="
          docker stats sindri-test --no-stream || true

          echo ""
          echo "=== Container inspect (State) ==="
          docker inspect sindri-test --format='{{.State.Status}} - OOMKilled: {{.State.OOMKilled}} - ExitCode: {{.State.ExitCode}}' || true

          echo ""
          echo "=== Container logs (last 100 lines) ==="
          docker logs --tail 100 sindri-test 2>&1 || true

          echo ""
          echo "=== Extension manager logs ==="
          docker exec sindri-test cat /alt/home/developer/workspace/.system/logs/*.log 2>/dev/null || true

          echo ""
          echo "=== dmesg OOM messages (if any) ==="
          dmesg | grep -i "oom\|killed" | tail -20 || true

      - name: Cleanup
        if: always() && inputs.skip-cleanup != true
        run: docker rm -f sindri-test || true

  summary:
    name: Test Summary
    needs: [generate-matrix, test-extension]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## Extension Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested **${{ needs.generate-matrix.outputs.count }}** extension(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Extensions | \`${{ inputs.extensions }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | Docker (local) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job results above for details." >> $GITHUB_STEP_SUMMARY
