# Packer VM Image Build Workflow (v3)
# This workflow builds Sindri v3 VM images across multiple cloud providers
name: "v3: Build Sindri VM Images"

on:
  workflow_dispatch:
    inputs:
      clouds:
        description: "Target clouds (comma-separated: aws,azure,gcp,oci,alibaba)"
        required: true
        default: "aws"
        type: string
      sindri_version:
        description: "Sindri version to install"
        required: true
        default: "latest"
        type: string
      profile:
        description: "Extension profile to install (optional - leave empty for base image only)"
        required: false
        default: ""
        type: string
      extensions:
        description: "Additional extensions (comma-separated)"
        required: false
        default: ""
        type: string
      cis_hardening:
        description: "Enable CIS security hardening"
        required: false
        default: false
        type: boolean
      dry_run:
        description: "Dry run (validate only)"
        required: false
        default: false
        type: boolean

env:
  PACKER_VERSION: "1.10.0"
  CARGO_TERM_COLOR: always

jobs:
  validate:
    name: Validate Packer Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: v3 -> target

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Build sindri CLI
        working-directory: v3
        run: cargo build -p sindri --release

      - name: Validate AWS template
        if: contains(github.event.inputs.clouds, 'aws')
        run: |
          ./v3/target/release/sindri packer validate --cloud aws \
            --sindri-version ${{ github.event.inputs.sindri_version || 'latest' }}

      - name: Validate Azure template
        if: contains(github.event.inputs.clouds, 'azure')
        run: |
          ./v3/target/release/sindri packer validate --cloud azure \
            --sindri-version ${{ github.event.inputs.sindri_version || 'latest' }}

      - name: Validate GCP template
        if: contains(github.event.inputs.clouds, 'gcp')
        run: |
          ./v3/target/release/sindri packer validate --cloud gcp \
            --sindri-version ${{ github.event.inputs.sindri_version || 'latest' }}

      - name: Validate OCI template
        if: contains(github.event.inputs.clouds, 'oci')
        run: |
          ./v3/target/release/sindri packer validate --cloud oci \
            --sindri-version ${{ github.event.inputs.sindri_version || 'latest' }}

      - name: Validate Alibaba template
        if: contains(github.event.inputs.clouds, 'alibaba')
        run: |
          ./v3/target/release/sindri packer validate --cloud alibaba \
            --sindri-version ${{ github.event.inputs.sindri_version || 'latest' }}

  build-aws:
    name: Build AWS AMI
    needs: validate
    if: |
      contains(github.event.inputs.clouds, 'aws') &&
      github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: v3 -> target

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Build sindri
        working-directory: v3
        run: cargo build -p sindri --release

      - name: Build AWS AMI
        run: |
          ./v3/target/release/sindri packer build --cloud aws \
            --sindri-version ${{ github.event.inputs.sindri_version || 'latest' }} \
            ${{ github.event.inputs.profile && format('--profile {0}', github.event.inputs.profile) || '' }} \
            ${{ github.event.inputs.extensions && format('--extensions {0}', github.event.inputs.extensions) || '' }} \
            ${{ github.event.inputs.cis_hardening == 'true' && '--cis-hardening' || '' }} \
            --json > build-result.json

      - name: Upload Build Manifest
        uses: actions/upload-artifact@v4
        with:
          name: aws-build-manifest
          path: |
            build-result.json
            manifest.json

  build-azure:
    name: Build Azure Image
    needs: validate
    if: |
      contains(github.event.inputs.clouds, 'azure') &&
      github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: v3 -> target

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Build sindri
        working-directory: v3
        run: cargo build -p sindri --release

      - name: Build Azure Image
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP || 'sindri-packer' }}
        run: |
          ./v3/target/release/sindri packer build --cloud azure \
            --sindri-version ${{ github.event.inputs.sindri_version || 'latest' }} \
            ${{ github.event.inputs.profile && format('--profile {0}', github.event.inputs.profile) || '' }} \
            ${{ github.event.inputs.cis_hardening == 'true' && '--cis-hardening' || '' }} \
            --json > build-result.json

      - name: Upload Build Manifest
        uses: actions/upload-artifact@v4
        with:
          name: azure-build-manifest
          path: |
            build-result.json
            manifest.json

  build-gcp:
    name: Build GCP Image
    needs: validate
    if: |
      contains(github.event.inputs.clouds, 'gcp') &&
      github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: v3 -> target

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Build sindri
        working-directory: v3
        run: cargo build -p sindri --release

      - name: Build GCP Image
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          ./v3/target/release/sindri packer build --cloud gcp \
            --sindri-version ${{ github.event.inputs.sindri_version || 'latest' }} \
            ${{ github.event.inputs.profile && format('--profile {0}', github.event.inputs.profile) || '' }} \
            ${{ github.event.inputs.cis_hardening == 'true' && '--cis-hardening' || '' }} \
            --json > build-result.json

      - name: Upload Build Manifest
        uses: actions/upload-artifact@v4
        with:
          name: gcp-build-manifest
          path: |
            build-result.json
            manifest.json

  build-oci:
    name: Build OCI Image
    needs: validate
    if: |
      contains(github.event.inputs.clouds, 'oci') &&
      github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure OCI Credentials
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ vars.OCI_REGION || 'us-ashburn-1' }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/config

      - name: Verify OCI Credentials
        run: |
          if [ -z "${{ secrets.OCI_USER_OCID }}" ]; then
            echo "::error::OCI_USER_OCID secret is not configured"
            exit 1
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: v3 -> target

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Build sindri
        working-directory: v3
        run: cargo build -p sindri --release

      - name: Build OCI Image
        env:
          OCI_COMPARTMENT_OCID: ${{ secrets.OCI_COMPARTMENT_OCID }}
          OCI_SUBNET_OCID: ${{ secrets.OCI_SUBNET_OCID }}
        run: |
          ./v3/target/release/sindri packer build --cloud oci \
            --sindri-version ${{ github.event.inputs.sindri_version || 'latest' }} \
            ${{ github.event.inputs.profile && format('--profile {0}', github.event.inputs.profile) || '' }} \
            ${{ github.event.inputs.cis_hardening == 'true' && '--cis-hardening' || '' }} \
            --json > build-result.json

      - name: Cleanup OCI Credentials
        if: always()
        run: |
          rm -rf ~/.oci
          echo "OCI credentials cleaned up"

      - name: Upload Build Manifest
        uses: actions/upload-artifact@v4
        with:
          name: oci-build-manifest
          path: |
            build-result.json
            manifest.json

  build-alibaba:
    name: Build Alibaba Cloud Image
    needs: validate
    if: |
      contains(github.event.inputs.clouds, 'alibaba') &&
      github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure Alibaba Cloud Credentials
        run: |
          echo "ALICLOUD_ACCESS_KEY=${{ secrets.ALICLOUD_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "ALICLOUD_SECRET_KEY=${{ secrets.ALICLOUD_SECRET_KEY }}" >> $GITHUB_ENV
          echo "ALICLOUD_REGION=${{ vars.ALICLOUD_REGION || 'cn-hangzhou' }}" >> $GITHUB_ENV

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: v3 -> target

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Build sindri
        working-directory: v3
        run: cargo build -p sindri --release

      - name: Build Alibaba Cloud Image
        run: |
          ./v3/target/release/sindri packer build --cloud alibaba \
            --sindri-version ${{ github.event.inputs.sindri_version || 'latest' }} \
            ${{ github.event.inputs.profile && format('--profile {0}', github.event.inputs.profile) || '' }} \
            ${{ github.event.inputs.cis_hardening == 'true' && '--cis-hardening' || '' }} \
            --json > build-result.json

      - name: Upload Build Manifest
        uses: actions/upload-artifact@v4
        with:
          name: alibaba-build-manifest
          path: |
            build-result.json
            manifest.json

  summary:
    name: Build Summary
    needs: [build-aws, build-azure, build-gcp, build-oci, build-alibaba]
    if: always() && github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Summary
        run: |
          echo "## Sindri VM Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Cloud | Status | Image ID |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY

          for dir in artifacts/*; do
            if [ -f "$dir/build-result.json" ]; then
              cloud=$(basename "$dir" | sed 's/-build-manifest//')
              success=$(jq -r '.success // "unknown"' "$dir/build-result.json")
              image_id=$(jq -r '.image_id // "N/A"' "$dir/build-result.json")
              status=$([[ "$success" == "true" ]] && echo "Success" || echo "Failed")
              echo "| $cloud | $status | $image_id |" >> $GITHUB_STEP_SUMMARY
            fi
          done
