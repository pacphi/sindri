# Packer VM Image Test Workflow (v3)
# This workflow tests Sindri v3 VM images using InSpec compliance profiles
name: "v3: Test Sindri VM Images"

on:
  workflow_dispatch:
    inputs:
      cloud:
        description: "Cloud provider to test"
        required: true
        type: choice
        options:
          - aws
          - azure
          - gcp
          - oci
          - alibaba
      image_id:
        description: "Image ID to test"
        required: true
        type: string
      region:
        description: "Cloud region"
        required: false
        default: "us-west-2"
        type: string

  workflow_run:
    workflows: ["v3: Build Sindri VM Images"]
    types:
      - completed

env:
  INSPEC_VERSION: "5.22.36"

jobs:
  test-aws:
    name: Test AWS AMI
    if: github.event.inputs.cloud == 'aws' || github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ github.event.inputs.region || 'us-west-2' }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install InSpec
        run: |
          gem install inspec-bin -v ${{ env.INSPEC_VERSION }}
          inspec --chef-license=accept-silent

      - name: Download Build Manifest
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v7
        with:
          name: aws-build-manifest
          run-id: ${{ github.event.workflow_run.id }}

      - name: Get Image ID
        id: image
        run: |
          if [ -n "${{ github.event.inputs.image_id }}" ]; then
            echo "image_id=${{ github.event.inputs.image_id }}" >> $GITHUB_OUTPUT
          elif [ -f build-result.json ]; then
            echo "image_id=$(jq -r '.image_id' build-result.json)" >> $GITHUB_OUTPUT
          else
            echo "No image ID available"
            exit 1
          fi

      - name: Launch Test Instance
        id: launch
        uses: ./.github/actions/packer/launch-instance
        with:
          cloud: aws
          image-id: ${{ steps.image.outputs.image_id }}
          region: ${{ github.event.inputs.region || 'us-west-2' }}
          security-group-id: ${{ secrets.AWS_SECURITY_GROUP_ID }}
          subnet-id: ${{ secrets.AWS_SUBNET_ID }}

      - name: Run InSpec Tests
        run: |
          inspec exec v3/inspec/integration/sindri/ \
            -t ssh://${{ steps.launch.outputs.ssh-user }}@${{ steps.launch.outputs.public-ip }} \
            -i ${{ steps.launch.outputs.ssh-key-path }} \
            --reporter cli json:test-results.json

      - name: Terminate Test Instance
        if: always()
        uses: ./.github/actions/packer/terminate-instance
        with:
          cloud: aws
          instance-id: ${{ steps.launch.outputs.instance-id }}
          region: ${{ github.event.inputs.region || 'us-west-2' }}

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: aws-test-results
          path: test-results.json

  test-azure:
    name: Test Azure Image
    if: github.event.inputs.cloud == 'azure'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install InSpec
        run: |
          gem install inspec-bin -v ${{ env.INSPEC_VERSION }}
          inspec --chef-license=accept-silent

      - name: Launch Test Instance
        id: launch
        uses: ./.github/actions/packer/launch-instance
        with:
          cloud: azure
          image-id: ${{ github.event.inputs.image_id }}
          region: ${{ github.event.inputs.region || 'westus2' }}
          resource-group: ${{ secrets.AZURE_RESOURCE_GROUP || 'sindri-test' }}

      - name: Run InSpec Tests
        run: |
          inspec exec v3/inspec/integration/sindri/ \
            -t ssh://${{ steps.launch.outputs.ssh-user }}@${{ steps.launch.outputs.public-ip }} \
            -i ${{ steps.launch.outputs.ssh-key-path }} \
            --reporter cli json:test-results.json

      - name: Terminate Test Instance
        if: always()
        uses: ./.github/actions/packer/terminate-instance
        with:
          cloud: azure
          instance-id: ${{ steps.launch.outputs.instance-id }}
          region: ${{ github.event.inputs.region || 'westus2' }}
          resource-group: ${{ secrets.AZURE_RESOURCE_GROUP || 'sindri-test' }}

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: azure-test-results
          path: test-results.json

  test-gcp:
    name: Test GCP Image
    if: github.event.inputs.cloud == 'gcp'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install InSpec
        run: |
          gem install inspec-bin -v ${{ env.INSPEC_VERSION }}
          inspec --chef-license=accept-silent

      - name: Launch Test Instance
        id: launch
        uses: ./.github/actions/packer/launch-instance
        with:
          cloud: gcp
          image-id: ${{ github.event.inputs.image_id }}
          region: ${{ github.event.inputs.region || 'us-central1-a' }}
          project-id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Run InSpec Tests
        run: |
          inspec exec v3/inspec/integration/sindri/ \
            -t ssh://${{ steps.launch.outputs.ssh-user }}@${{ steps.launch.outputs.public-ip }} \
            -i ${{ steps.launch.outputs.ssh-key-path }} \
            --reporter cli json:test-results.json

      - name: Terminate Test Instance
        if: always()
        uses: ./.github/actions/packer/terminate-instance
        with:
          cloud: gcp
          instance-id: ${{ steps.launch.outputs.instance-id }}
          region: ${{ github.event.inputs.region || 'us-central1-a' }}
          project-id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: gcp-test-results
          path: test-results.json

  test-oci:
    name: Test OCI Image
    if: github.event.inputs.cloud == 'oci'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
      OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_TENANCY_OCID: ${{ secrets.OCI_TENANCY_OCID }}
      OCI_API_KEY: ${{ secrets.OCI_API_KEY }}
    steps:
      - uses: actions/checkout@v6

      - name: Configure OCI Credentials
        run: |
          mkdir -p ~/.oci
          echo "$OCI_API_KEY" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install InSpec
        run: |
          gem install inspec-bin -v ${{ env.INSPEC_VERSION }}
          inspec --chef-license=accept-silent

      - name: Launch Test Instance
        id: launch
        uses: ./.github/actions/packer/launch-instance
        with:
          cloud: oci
          image-id: ${{ github.event.inputs.image_id }}
          region: ${{ github.event.inputs.region || 'us-ashburn-1' }}
          compartment-id: ${{ secrets.OCI_COMPARTMENT_ID }}
          subnet-id: ${{ secrets.OCI_SUBNET_ID }}

      - name: Run InSpec Tests
        run: |
          inspec exec v3/inspec/integration/sindri/ \
            -t ssh://${{ steps.launch.outputs.ssh-user }}@${{ steps.launch.outputs.public-ip }} \
            -i ${{ steps.launch.outputs.ssh-key-path }} \
            --reporter cli json:test-results.json

      - name: Terminate Test Instance
        if: always()
        uses: ./.github/actions/packer/terminate-instance
        with:
          cloud: oci
          instance-id: ${{ steps.launch.outputs.instance-id }}
          region: ${{ github.event.inputs.region || 'us-ashburn-1' }}

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: oci-test-results
          path: test-results.json

  test-alibaba:
    name: Test Alibaba Cloud Image
    if: github.event.inputs.cloud == 'alibaba'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      ALICLOUD_ACCESS_KEY: ${{ secrets.ALICLOUD_ACCESS_KEY }}
      ALICLOUD_SECRET_KEY: ${{ secrets.ALICLOUD_SECRET_KEY }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install InSpec
        run: |
          gem install inspec-bin -v ${{ env.INSPEC_VERSION }}
          inspec --chef-license=accept-silent

      - name: Launch Test Instance
        id: launch
        uses: ./.github/actions/packer/launch-instance
        with:
          cloud: alibaba
          image-id: ${{ github.event.inputs.image_id }}
          region: ${{ github.event.inputs.region || 'us-west-1' }}
          vswitch-id: ${{ secrets.ALIBABA_VSWITCH_ID }}
          security-group-id: ${{ secrets.ALIBABA_SECURITY_GROUP_ID }}

      - name: Run InSpec Tests
        run: |
          inspec exec v3/inspec/integration/sindri/ \
            -t ssh://${{ steps.launch.outputs.ssh-user }}@${{ steps.launch.outputs.public-ip }} \
            -i ${{ steps.launch.outputs.ssh-key-path }} \
            --reporter cli json:test-results.json

      - name: Terminate Test Instance
        if: always()
        uses: ./.github/actions/packer/terminate-instance
        with:
          cloud: alibaba
          instance-id: ${{ steps.launch.outputs.instance-id }}
          region: ${{ github.event.inputs.region || 'us-west-1' }}

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: alibaba-test-results
          path: test-results.json

  summary:
    name: Test Summary
    needs: [test-aws, test-azure, test-gcp, test-oci, test-alibaba]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Generate Summary
        run: |
          echo "## Sindri VM Image Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for dir in artifacts/*; do
            if [ -f "$dir/test-results.json" ]; then
              cloud=$(basename "$dir" | sed 's/-test-results//')
              passed=$(jq '.statistics.controls.passed.total // 0' "$dir/test-results.json")
              failed=$(jq '.statistics.controls.failed.total // 0' "$dir/test-results.json")
              echo "### $cloud" >> $GITHUB_STEP_SUMMARY
              echo "- Passed: $passed" >> $GITHUB_STEP_SUMMARY
              echo "- Failed: $failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
