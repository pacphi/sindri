# Reusable Workflow: RunPod Provider
# Tests extensions on RunPod GPU cloud pods
name: "v3: Provider - RunPod"

on:
  workflow_call:
    inputs:
      extensions:
        description: 'JSON array of extension names to test'
        type: string
        required: true
      max-parallel:
        description: 'Maximum parallel jobs'
        type: number
        default: 2
      gpu-type:
        description: 'RunPod GPU type (e.g., NVIDIA RTX A4000, NVIDIA GeForce RTX 3090)'
        type: string
        default: ''
      sindri-image:
        description: 'Sindri container image to test'
        type: string
        default: 'ghcr.io/pacphi/sindri:latest'

    outputs:
      results:
        description: 'Test results JSON'
        value: ${{ jobs.summary.outputs.results }}
      passed:
        description: 'Number of passed tests'
        value: ${{ jobs.summary.outputs.passed }}
      failed:
        description: 'Number of failed tests'
        value: ${{ jobs.summary.outputs.failed }}

    secrets:
      RUNPOD_API_KEY:
        description: 'RunPod API key'
        required: true

env:
  RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}

jobs:
  # Test each extension on RunPod
  test:
    name: "Test: ${{ matrix.extension }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: ${{ inputs.max-parallel }}
      matrix:
        extension: ${{ fromJson(inputs.extensions) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install runpodctl
        run: |
          curl -Lo runpodctl "https://github.com/runpod/runpodctl/releases/latest/download/runpodctl-linux-amd64"
          chmod +x runpodctl
          sudo mv runpodctl /usr/local/bin/
          runpodctl version

      - name: Configure runpodctl
        run: |
          runpodctl config --apiKey "$RUNPOD_API_KEY"

      - name: Get Extension Requirements
        id: requirements
        run: |
          EXT_FILE="v3/extensions/${{ matrix.extension }}/extension.yaml"
          if [[ -f "$EXT_FILE" ]]; then
            MEMORY=$(yq -r '.requirements.memory // 2048' "$EXT_FILE")
            GPU=$(yq -r '.requirements.gpu // false' "$EXT_FILE")
          else
            MEMORY=2048
            GPU=false
          fi
          echo "memory=$MEMORY" >> $GITHUB_OUTPUT
          echo "gpu=$GPU" >> $GITHUB_OUTPUT

          # Determine container disk and volume size
          if [[ $MEMORY -le 2048 ]]; then
            DISK_SIZE=20
            VOLUME_SIZE=20
          elif [[ $MEMORY -le 8192 ]]; then
            DISK_SIZE=40
            VOLUME_SIZE=40
          else
            DISK_SIZE=80
            VOLUME_SIZE=80
          fi
          echo "disk_size=$DISK_SIZE" >> $GITHUB_OUTPUT
          echo "volume_size=$VOLUME_SIZE" >> $GITHUB_OUTPUT

      - name: Create RunPod Pod
        id: create
        run: |
          POD_NAME="sindri-test-${{ matrix.extension }}-$(date +%s)"
          POD_NAME=$(echo "$POD_NAME" | tr '_' '-' | cut -c1-63)

          echo "Creating RunPod pod: $POD_NAME"

          GPU_TYPE="${{ inputs.gpu-type }}"
          if [[ -z "$GPU_TYPE" && "${{ steps.requirements.outputs.gpu }}" == "true" ]]; then
            GPU_TYPE="NVIDIA RTX A4000"
          fi

          CREATE_ARGS=(
            "--name" "$POD_NAME"
            "--imageName" "${{ inputs.sindri-image }}"
            "--containerDiskSize" "${{ steps.requirements.outputs.disk_size }}"
            "--volumeSize" "${{ steps.requirements.outputs.volume_size }}"
          )

          if [[ -n "$GPU_TYPE" ]]; then
            CREATE_ARGS+=("--gpuType" "$GPU_TYPE" "--gpuCount" "1")
          fi

          POD_ID=$(runpodctl create pod "${CREATE_ARGS[@]}" 2>&1 | grep -oP 'id:\s*\K\S+' || true)

          if [[ -z "$POD_ID" ]]; then
            echo "::error::Failed to create RunPod pod"
            exit 1
          fi

          echo "pod_id=$POD_ID" >> $GITHUB_OUTPUT
          echo "pod_name=$POD_NAME" >> $GITHUB_OUTPUT
          echo "Pod created: $POD_ID"

      - name: Wait for Pod Ready
        id: wait
        timeout-minutes: 10
        run: |
          POD_ID="${{ steps.create.outputs.pod_id }}"
          echo "Waiting for pod $POD_ID to be ready..."

          for i in $(seq 1 60); do
            STATUS=$(runpodctl get pod "$POD_ID" --format json 2>/dev/null | jq -r '.desiredStatus // "unknown"' 2>/dev/null || echo "unknown")
            if [[ "$STATUS" == "RUNNING" ]]; then
              echo "Pod is running"
              break
            fi
            echo "Status: $STATUS (attempt $i/60)"
            sleep 10
          done

          FINAL_STATUS=$(runpodctl get pod "$POD_ID" --format json 2>/dev/null | jq -r '.desiredStatus // "unknown"' 2>/dev/null || echo "unknown")
          if [[ "$FINAL_STATUS" != "RUNNING" ]]; then
            echo "::error::Pod did not reach RUNNING state (status: $FINAL_STATUS)"
            exit 1
          fi

      - name: Run Extension Tests
        id: test
        timeout-minutes: 15
        run: |
          POD_ID="${{ steps.create.outputs.pod_id }}"

          echo "::group::Installing ${{ matrix.extension }}"
          START_TIME=$(date +%s)

          if runpodctl exec "$POD_ID" -- sindri extension install ${{ matrix.extension }} --yes 2>&1 | tee install.log; then
            INSTALL_RESULT="success"
          else
            INSTALL_RESULT="failure"
          fi

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "::endgroup::"

          if [[ "$INSTALL_RESULT" == "success" ]]; then
            echo "::group::Validating ${{ matrix.extension }}"
            if runpodctl exec "$POD_ID" -- sindri extension validate ${{ matrix.extension }} 2>&1 | tee validate.log; then
              VALIDATE_RESULT="success"
            else
              VALIDATE_RESULT="failure"
            fi
            echo "::endgroup::"

            echo "::group::Removing ${{ matrix.extension }}"
            runpodctl exec "$POD_ID" -- sindri extension remove ${{ matrix.extension }} --yes 2>&1 | tee remove.log || true
            echo "::endgroup::"
          else
            VALIDATE_RESULT="skipped"
          fi

          echo "install_result=$INSTALL_RESULT" >> $GITHUB_OUTPUT
          echo "install_duration=$DURATION" >> $GITHUB_OUTPUT
          echo "validate_result=$VALIDATE_RESULT" >> $GITHUB_OUTPUT

      - name: Cleanup RunPod Pod
        if: always()
        run: |
          POD_ID="${{ steps.create.outputs.pod_id }}"
          if [[ -n "$POD_ID" ]]; then
            echo "Destroying RunPod pod: $POD_ID"
            runpodctl remove pod "$POD_ID" || true
          fi

      - name: Create Test Report
        id: report
        if: always()
        run: |
          cat > test-result.json << EOF
          {
            "extension": "${{ matrix.extension }}",
            "provider": "runpod",
            "gpu_type": "${{ inputs.gpu-type }}",
            "install": {
              "result": "${{ steps.test.outputs.install_result || 'error' }}",
              "duration": ${{ steps.test.outputs.install_duration || 0 }}
            },
            "validate": {
              "result": "${{ steps.test.outputs.validate_result || 'skipped' }}"
            },
            "overall": "${{ steps.test.outputs.install_result == 'success' && steps.test.outputs.validate_result == 'success' && 'passed' || 'failed' }}"
          }
          EOF

          cat test-result.json
          echo "result=$(cat test-result.json | jq -c .)" >> $GITHUB_OUTPUT

      - name: Upload Test Result
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: runpod-result-${{ matrix.extension }}
          path: |
            test-result.json
            install.log
            validate.log
            remove.log
          retention-days: 7

  # Aggregate results
  summary:
    name: Test Summary
    needs: test
    if: always()
    runs-on: ubuntu-latest
    outputs:
      results: ${{ steps.aggregate.outputs.results }}
      passed: ${{ steps.aggregate.outputs.passed }}
      failed: ${{ steps.aggregate.outputs.failed }}

    steps:
      - name: Download All Results
        uses: actions/download-artifact@v7
        with:
          path: results
          pattern: runpod-result-*

      - name: Aggregate Results
        id: aggregate
        run: |
          RESULTS="[]"
          PASSED=0
          FAILED=0

          for dir in results/*/; do
            if [[ -f "$dir/test-result.json" ]]; then
              RESULT=$(cat "$dir/test-result.json")
              RESULTS=$(echo "$RESULTS" | jq --argjson r "$RESULT" '. + [$r]')

              OVERALL=$(echo "$RESULT" | jq -r '.overall')
              if [[ "$OVERALL" == "passed" ]]; then
                PASSED=$((PASSED + 1))
              else
                FAILED=$((FAILED + 1))
              fi
            fi
          done

          {
            echo "results<<EOF"
            echo "$RESULTS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - name: Generate Summary
        run: |
          echo "## RunPod Provider Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**GPU Type:** ${{ inputs.gpu-type || 'CPU only' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Passed:** ${{ steps.aggregate.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed:** ${{ steps.aggregate.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Extension | Install | Validate | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|----------|----------|" >> $GITHUB_STEP_SUMMARY

          echo '${{ steps.aggregate.outputs.results }}' | jq -r '.[] | "| \(.extension) | " +
            (if .install.result == "success" then "pass" else "fail" end) + " | " +
            (if .validate.result == "success" then "pass" elif .validate.result == "skipped" then "skip" else "fail" end) +
            " | \(.install.duration)s |"' >> $GITHUB_STEP_SUMMARY
