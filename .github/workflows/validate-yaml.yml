---
# .github/workflows/validate-yaml.yml
# YAML validation workflow
name: Validate YAML

on:
  pull_request:
    paths:
      - "**.yaml"
      - "**.yml"
      - "v2/docker/lib/schemas/*.json"
  push:
    branches: [main]
    paths:
      - "**.yaml"
      - "**.yml"
      - "v2/docker/lib/schemas/*.json"
  workflow_dispatch:
  workflow_call:

jobs:
  lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint --strict \
            v2/docker/lib/*.yaml \
            v2/docker/lib/extensions/*/extension.yaml \
            examples/**/*.yaml \
            .github/workflows/*.yml

  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install tools
        run: |
          npm install -g ajv-cli ajv-formats
          wget https://github.com/mikefarah/yq/releases/lav2/test/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Validate all schemas
        run: ./v2/test/unit/yaml/validate-schema.sh all

  cross-references:
    name: Cross-Reference Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/lav2/test/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Validate cross-references
        run: ./v2/test/unit/yaml/test-cross-references.sh

  domain-requirements:
    name: Domain Requirements Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/lav2/test/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Validate domain requirements
        run: |
          chmod +x v2/test/unit/yaml/test-domain-requirements.sh
          # Run format/duplicate validation (hard fail)
          # DNS validation disabled in CI (network may be restricted)
          VALIDATE_DNS=false ./v2/test/unit/yaml/test-domain-requirements.sh

  extension-consistency:
    name: Extension Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/lav2/test/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Check extension naming consistency
        run: |
          # Extension directory name must match metadata.name
          FAILURES=0
          for ext_dir in v2/docker/lib/extensions/*/; do
            if [[ -f "$ext_dir/extension.yaml" ]]; then
              dir_name=$(basename "$ext_dir")
              yaml_name=$(yq '.metadata.name' "$ext_dir/extension.yaml")

              if [[ "$dir_name" != "$yaml_name" ]]; then
                echo "FAIL: Directory '$dir_name' doesn't match metadata.name '$yaml_name'"
                ((FAILURES++)) || true
              fi
            fi
          done

          if [[ $FAILURES -gt 0 ]]; then
            echo "Extension naming check failed: $FAILURES error(s)"
            exit 1
          fi
          echo "All extension names consistent"

      - name: Check category consistency
        run: |
          # Extension category must match registry entry
          FAILURES=0
          for ext_dir in v2/docker/lib/extensions/*/; do
            if [[ -f "$ext_dir/extension.yaml" ]]; then
              ext_name=$(basename "$ext_dir")
              ext_category=$(yq '.metadata.category // ""' "$ext_dir/extension.yaml")
              reg_category=$(yq ".extensions.$ext_name.category // \"\"" v2/docker/lib/registry.yaml)

              if [[ -n "$ext_category" ]] && [[ -n "$reg_category" ]] && \
                 [[ "$ext_category" != "$reg_category" ]]; then
                echo "FAIL: $ext_name category mismatch: extension.yaml='$ext_category', registry.yaml='$reg_category'"
                ((FAILURES++)) || true
              fi
            fi
          done

          if [[ $FAILURES -gt 0 ]]; then
            echo "Category consistency check failed: $FAILURES error(s)"
            exit 1
          fi
          echo "All extension categories consistent"
