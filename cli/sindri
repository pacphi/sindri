#!/bin/bash
# Sindri CLI - Main entry point

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Detect environment and source common functions
if [[ -f "/docker/lib/common.sh" ]]; then
    # Running inside container
    source /docker/lib/common.sh
    BASE_DIR="/docker"
else
    # Running on host
    BASE_DIR="$(dirname "$SCRIPT_DIR")"
    source "$BASE_DIR/docker/lib/common.sh"
fi

show_version() {
    local version_file
    local version

    # Try to find VERSION file
    if [[ -f "$SCRIPT_DIR/../VERSION" ]]; then
        version_file="$SCRIPT_DIR/../VERSION"
    elif [[ -f "/docker/VERSION" ]]; then
        version_file="/docker/VERSION"
    elif [[ -f "$BASE_DIR/VERSION" ]]; then
        version_file="$BASE_DIR/VERSION"
    fi

    if [[ -n "$version_file" && -f "$version_file" ]]; then
        version=$(tr -d '[:space:]' < "$version_file")
    else
        version="unknown"
    fi

    # Check if we're on a tagged release commit
    if command -v git &>/dev/null && [[ -d "$SCRIPT_DIR/../.git" || -d "$BASE_DIR/.git" ]]; then
        local git_dir="${SCRIPT_DIR}/.."
        [[ -d "$BASE_DIR/.git" ]] && git_dir="$BASE_DIR"

        # Get current commit SHA
        local sha
        sha=$(git -C "$git_dir" rev-parse --short HEAD 2>/dev/null)

        # Check if current commit is tagged with a version tag
        local tag
        tag=$(git -C "$git_dir" describe --exact-match --tags HEAD 2>/dev/null | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+' || true)

        # If not on a tagged release, append dev suffix
        if [[ -z "$tag" && -n "$sha" ]]; then
            version="${version}-dev+${sha}"
        fi
    fi

    echo "sindri version $version"
}

show_help() {
    cat << 'EOH'
sindri - Cloud Development Forge

USAGE:
    sindri <command> [options]

COMMANDS:
    deploy [--provider <name>] [--rebuild] [--config <file>]
                                 Deploy to provider (docker, fly, devpod)
    plan [--config <file>]       Show deployment plan
    destroy [--provider <name>] [--force] [--config <file>]
                                 Destroy deployment
    connect [--config <file>]    Connect to deployed instance
    test [--config <file>] [--suite <name>]
                                 Run test suite on deployed instance

    profiles list                List available profiles
    profiles show <name>         Show profile details

    config init                  Initialize sindri.yaml
    config validate [--config <file>]
                                 Validate configuration against schema

OPTIONS:
    -h, --help                   Show this help
    -V, --version                Show version information
    -c, --config <file>          Use specific config file (default: sindri.yaml)
    -p, --provider <name>        Deployment provider (docker, fly, devpod)
    -r, --rebuild                Force rebuild of Docker image
    -v, --verbose                Verbose output

EXAMPLES:
    sindri config init
    sindri deploy --provider docker
    sindri deploy --provider fly
    sindri deploy --provider fly --rebuild  # Force rebuild on Fly.io
    sindri deploy --provider devpod
    sindri deploy --config examples/fly/minimal.sindri.yaml
    sindri connect
    sindri destroy --provider docker
    sindri destroy --force
    sindri test --config examples/fly/minimal.sindri.yaml --suite smoke
EOH
}

# Initialize configuration
config_init() {
    if [[ -f "sindri.yaml" ]]; then
        print_warning "sindri.yaml already exists"
        read -p "Overwrite? (y/N) " -n 1 -r
        echo
        [[ ! $REPLY =~ ^[Yy]$ ]] && return 0
    fi

    cat > sindri.yaml << 'EOYAML'
version: 1.0
name: my-sindri-dev

deployment:
  provider: docker  # Options: docker, fly, devpod
  resources:
    memory: 2GB     # RAM allocation (e.g., 1GB, 2GB, 4GB)
    cpus: 2         # Number of CPUs

  volumes:
    workspace:
      path: /workspace
      size: 10GB    # Persistent volume size

extensions:
  profile: fullstack  # Options: minimal, fullstack, ai-dev, systems, enterprise, devops, cloud-native
  # Or specify custom extensions:
  # active:
  #   - nodejs
  #   - python
  #   - docker

# Secrets configuration (set via provider-specific mechanisms)
secrets:
  # Claude Code
  - name: ANTHROPIC_API_KEY
    source: env

  # GitHub integration
  - name: GITHUB_TOKEN
    source: env
  - name: GIT_USER_NAME
    source: env
  - name: GIT_USER_EMAIL
    source: env

  # AI Tools (optional)
  # - name: OPENROUTER_API_KEY
  #   source: env
  # - name: GOOGLE_GEMINI_API_KEY
  #   source: env
  # - name: PERPLEXITY_API_KEY
  #   source: env

providers:
  # Fly.io configuration
  fly:
    region: sjc                # Fly.io region (sjc, ord, iad, etc.)
    autoStopMachines: true     # Auto-suspend when idle (cost savings)
    autoStartMachines: true    # Auto-resume on connection
    cpuKind: shared            # shared (cost-effective) or performance (dedicated)
    sshPort: 10022             # External SSH port
    organization: personal     # Fly.io organization
    highAvailability: false    # Enable for multi-machine redundancy

  # Docker configuration
  docker:
    network: bridge
    restart: unless-stopped

  # Kubernetes configuration
  kubernetes:
    namespace: default
    storageClass: standard
    ingress:
      enabled: false
      hostname: ""
EOYAML

    print_success "Created sindri.yaml"
    echo ""
    echo "Configuration options:"
    echo "  • Provider: docker (local), fly (cloud), devpod (DevContainer)"
    echo "  • Resources: Adjust memory/cpus based on needs"
    echo "  • Extensions: Choose profile or custom active list"
    echo "  • Secrets: Configure provider-specific secrets"
    echo ""
    echo "Next steps:"
    echo "  1. Edit sindri.yaml to customize your deployment"
    echo "  2. Run: ./cli/sindri deploy"
    echo ""
    echo "For Fly.io deployments:"
    echo "  • Set secrets: flyctl secrets set ANTHROPIC_API_KEY=sk-ant-... -a my-sindri-dev"
    echo "  • See docs/providers/FLY.md for complete guide"
    echo ""
}

# Validate configuration
config_validate() {
    local config="${1:-sindri.yaml}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found"
        return 1
    fi

    # Validate against schema
    local schema="$BASE_DIR/docker/lib/schemas/sindri.schema.json"
    if [[ -f "$schema" ]]; then
        validate_yaml_schema "$config" "$schema"
    fi

    print_success "Configuration valid"
}

# Deploy to provider
deploy() {
    local provider="${1:-}"
    local rebuild="${2:-}"
    local config="${3:-sindri.yaml}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found. Run: sindri config init"
        return 1
    fi

    # Use provider from config if not specified via command line
    if [[ -z "$provider" ]]; then
        provider=$(yq '.deployment.provider' "$config" 2>/dev/null || echo "docker")
    fi

    print_header "Deploying with $provider provider"

    # Export rebuild flag for adapters to use
    export SINDRI_REBUILD="$rebuild"

    case "$provider" in
        docker)
            "$BASE_DIR/deploy/adapters/docker-adapter.sh" "$config"
            ;;
        fly)
            "$BASE_DIR/deploy/adapters/fly-adapter.sh" "$config"
            ;;
        devpod)
            "$BASE_DIR/deploy/adapters/devpod-adapter.sh" "$config"
            ;;
        *)
            print_error "Unknown provider: $provider"
            echo "Available providers: docker, fly, devpod"
            return 1
            ;;
    esac
}

# Connect to instance
connect() {
    local config="${1:-sindri.yaml}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found"
        return 1
    fi

    local name provider
    name=$(yq '.name' "$config")
    provider=$(yq '.deployment.provider' "$config")

    case "$provider" in
        docker)
            docker exec -it "$name" /bin/bash
            ;;
        fly)
            flyctl ssh console -a "$name"
            ;;
        devpod)
            devpod ssh "$name"
            ;;
        *)
            print_error "Unknown provider: $provider"
            ;;
    esac
}

# Destroy deployment
destroy() {
    local provider="${1:-}"
    local force="${2:-}"
    local config="${3:-sindri.yaml}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found"
        return 1
    fi

    # Use provider from config if not specified via command line
    if [[ -z "$provider" ]]; then
        provider=$(yq '.deployment.provider' "$config" 2>/dev/null || echo "docker")
    fi

    local name
    name=$(yq '.name' "$config")

    # Confirmation prompt unless --force is used
    if [[ "$force" != "--force" ]]; then
        print_warning "This will destroy the deployment '$name' on provider '$provider'"
        read -p "Are you sure? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_status "Destroy cancelled"
            return 0
        fi
    fi

    print_header "Destroying $name on $provider"

    case "$provider" in
        docker)
            # Stop and remove container
            if docker ps -a | grep -q "$name"; then
                print_status "Stopping container $name..."
                docker stop "$name" 2>/dev/null || true
                print_status "Removing container $name..."
                docker rm "$name" 2>/dev/null || true
            fi

            # Remove docker-compose resources if exists
            if [[ -f "docker-compose.yml" ]]; then
                print_status "Removing docker-compose resources..."
                docker-compose down -v 2>/dev/null || true
                rm -f docker-compose.yml
            fi

            print_success "Docker deployment destroyed"
            ;;
        fly)
            print_status "Destroying Fly.io app $name..."

            # Delete the app (this also deletes volumes and secrets)
            if flyctl apps list | grep -q "$name"; then
                flyctl apps destroy "$name" --yes
            else
                print_warning "App $name not found on Fly.io"
            fi

            # Remove fly.toml
            if [[ -f "fly.toml" ]]; then
                rm -f fly.toml
                print_status "Removed fly.toml"
            fi

            print_success "Fly.io deployment destroyed"
            ;;
        devpod)
            print_status "Destroying DevPod workspace..."

            # Stop and delete DevPod workspace
            if devpod list | grep -q "$name"; then
                devpod delete "$name" --force
            fi

            # Remove .devcontainer directory
            if [[ -d ".devcontainer" ]]; then
                rm -rf .devcontainer
                print_status "Removed .devcontainer directory"
            fi

            print_success "DevPod deployment destroyed"
            ;;
        *)
            print_error "Unknown provider: $provider"
            echo "Available providers: docker, fly, devpod"
            return 1
            ;;
    esac
}

# Run test suite on deployed instance
test_suite() {
    local config="${1:-sindri.yaml}"
    local suite="${2:-smoke}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found"
        return 1
    fi

    local name provider
    name=$(yq '.name' "$config")
    provider=$(yq '.deployment.provider' "$config")

    print_header "Running test suite: $suite on $name ($provider)"

    case "$suite" in
        smoke)
            # Basic connectivity and health checks
            print_status "Running smoke tests..."

            case "$provider" in
                docker)
                    # Check container is running
                    if ! docker ps | grep -q "$name"; then
                        print_error "Container $name is not running"
                        return 1
                    fi

                    # Check basic commands work
                    docker exec "$name" whoami || { print_error "Failed to exec into container"; return 1; }
                    docker exec "$name" cat /etc/os-release || { print_error "Failed to read OS info"; return 1; }
                    ;;
                fly)
                    # Check app is running
                    if ! flyctl status -a "$name" 2>/dev/null | grep -q "running"; then
                        print_error "Fly.io app $name is not running"
                        return 1
                    fi

                    # Check SSH connectivity
                    flyctl ssh console -a "$name" -C "whoami" || { print_error "SSH test failed"; return 1; }
                    ;;
                devpod)
                    # Check workspace exists
                    if ! devpod list | grep -q "$name"; then
                        print_error "DevPod workspace $name not found"
                        return 1
                    fi

                    # Check SSH connectivity
                    devpod ssh "$name" "whoami" || { print_error "SSH test failed"; return 1; }
                    ;;
            esac

            print_success "Smoke tests passed"
            ;;
        integration)
            # Full integration tests
            print_status "Running integration tests..."

            # Deploy if not already running
            if ! deploy "" "" "$config"; then
                print_error "Deploy failed"
                return 1
            fi

            # Run extension validation
            case "$provider" in
                docker)
                    docker exec "$name" /docker/cli/extension-manager validate-all
                    ;;
                fly)
                    flyctl ssh console -a "$name" -C "/docker/cli/extension-manager validate-all"
                    ;;
                devpod)
                    devpod ssh "$name" "/docker/cli/extension-manager validate-all"
                    ;;
            esac

            print_success "Integration tests passed"
            ;;
        full)
            # Run all test suites
            print_status "Running full test suite..."
            test_suite "$config" "smoke" || return 1
            test_suite "$config" "integration" || return 1
            print_success "Full test suite passed"
            ;;
        *)
            print_error "Unknown test suite: $suite"
            echo "Available suites: smoke, integration, full"
            return 1
            ;;
    esac
}

# Show deployment plan
plan() {
    local config="${1:-sindri.yaml}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found"
        return 1
    fi

    print_header "Deployment Plan"

    # Parse configuration
    local name provider memory cpus volume_size profile
    name=$(yq '.name' "$config")
    provider=$(yq '.deployment.provider' "$config")
    memory=$(yq '.deployment.resources.memory // "2GB"' "$config")
    cpus=$(yq '.deployment.resources.cpus // 2' "$config")
    volume_size=$(yq '.deployment.volumes.workspace.size // "10GB"' "$config")
    profile=$(yq '.extensions.profile // "minimal"' "$config")

    echo ""
    echo "Configuration Summary:"
    echo "  Name:        $name"
    echo "  Provider:    $provider"
    echo "  Memory:      $memory"
    echo "  CPUs:        $cpus"
    echo "  Volume:      $volume_size"
    echo "  Profile:     $profile"
    echo ""

    case "$provider" in
        docker)
            echo "Docker Deployment Plan:"
            echo "  • Build sindri:latest image (always rebuilds for fresh source)"
            echo "  • Create docker-compose.yml"
            echo "  • Create persistent volume: workspace"
            echo "  • Start container with resource limits"
            echo "  • Install extension profile: $profile"
            echo ""
            echo "Commands to be executed:"
            echo "  docker build -t sindri:latest -f docker/Dockerfile ."
            echo "  docker-compose up -d"
            echo ""
            echo "Note: Docker provider always rebuilds to ensure fresh source code."
            echo "      This is optimal for local development."
            echo ""
            ;;
        fly)
            local region auto_stop ssh_port
            region=$(yq '.providers.fly.region // "sjc"' "$config")
            auto_stop=$(yq '.providers.fly.autoStopMachines // true' "$config")
            ssh_port=$(yq '.providers.fly.sshPort // 10022' "$config")

            echo "Fly.io Deployment Plan:"
            echo "  • Region:    $region"
            echo "  • Auto-stop: $auto_stop"
            echo "  • SSH Port:  $ssh_port"
            echo ""
            echo "Actions:"
            echo "  • Generate fly.toml configuration"
            echo "  • Create app: $name"
            echo "  • Create volume: workspace (${volume_size})"
            echo "  • Deploy application"
            echo "  • Install extension profile: $profile"
            echo ""
            echo "Commands to be executed:"
            echo "  flyctl apps create $name --org personal"
            echo "  flyctl volumes create workspace -s ${volume_size//GB/} -r $region -a $name"
            echo "  flyctl deploy --ha=false"
            echo ""
            echo "Note: Use --rebuild flag to force image rebuild: sindri deploy --rebuild"
            echo ""
            ;;
        devpod)
            echo "DevPod/DevContainer Deployment Plan:"
            echo "  • Generate .devcontainer/devcontainer.json"
            echo "  • Generate .devcontainer/provider.yaml"
            echo "  • Configure VS Code extensions"
            echo "  • Mount workspace volume"
            echo "  • Install extension profile: $profile"
            echo ""
            echo "Next steps:"
            echo "  • Use with DevPod: devpod up . --provider docker"
            echo "  • Use with VS Code: Open in DevContainer"
            echo "  • Use with GitHub Codespaces: Push and create codespace"
            echo ""
            echo "Note: Use --rebuild flag to force image rebuild: sindri deploy --rebuild"
            echo ""
            ;;
        *)
            print_error "Unknown provider: $provider"
            ;;
    esac

    # Show secrets if configured
    local secrets
    secrets=$(yq '.secrets[]?.name' "$config" 2>/dev/null || true)
    if [[ ! -z "$secrets" ]]; then
        echo "Secrets to configure:"
        echo "$secrets" | while read -r secret; do
            echo "  • $secret"
        done
        echo ""
    fi

    print_success "Plan complete. Run 'sindri deploy' to execute."
}

# Main
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        deploy)
            local provider=""
            local rebuild=""
            local config="sindri.yaml"
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -p|--provider)
                        provider="$2"
                        shift 2
                        ;;
                    -r|--rebuild)
                        rebuild="--rebuild"
                        shift
                        ;;
                    -c|--config)
                        config="$2"
                        shift 2
                        ;;
                    *)
                        shift
                        ;;
                esac
            done
            deploy "$provider" "$rebuild" "$config"
            ;;
        connect)
            local config="sindri.yaml"
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -c|--config)
                        config="$2"
                        shift 2
                        ;;
                    *)
                        shift
                        ;;
                esac
            done
            connect "$config"
            ;;
        destroy)
            local provider=""
            local force=""
            local config="sindri.yaml"
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -p|--provider)
                        provider="$2"
                        shift 2
                        ;;
                    -f|--force)
                        force="--force"
                        shift
                        ;;
                    -c|--config)
                        config="$2"
                        shift 2
                        ;;
                    *)
                        shift
                        ;;
                esac
            done
            destroy "$provider" "$force" "$config"
            ;;
        plan)
            local config="sindri.yaml"
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -c|--config)
                        config="$2"
                        shift 2
                        ;;
                    *)
                        shift
                        ;;
                esac
            done
            plan "$config"
            ;;
        test)
            local config="sindri.yaml"
            local suite="smoke"
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -c|--config)
                        config="$2"
                        shift 2
                        ;;
                    -s|--suite)
                        suite="$2"
                        shift 2
                        ;;
                    *)
                        shift
                        ;;
                esac
            done
            test_suite "$config" "$suite"
            ;;
        config)
            case "${1:-}" in
                init)
                    config_init
                    ;;
                validate)
                    shift
                    local config="sindri.yaml"
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            -c|--config)
                                config="$2"
                                shift 2
                                ;;
                            *)
                                config="$1"
                                shift
                                ;;
                        esac
                    done
                    config_validate "$config"
                    ;;
                *)
                    echo "Usage: sindri config <init|validate>"
                    ;;
            esac
            ;;
        profiles)
            case "${1:-}" in
                list)
                    "$BASE_DIR/cli/extension-manager" list-profiles
                    ;;
                show)
                    [[ -z "${2:-}" ]] && echo "Usage: sindri profiles show <name>" && exit 1
                    yq ".profiles.\"$2\"" "$BASE_DIR/docker/lib/profiles.yaml"
                    ;;
                *)
                    echo "Usage: sindri profiles <list|show>"
                    ;;
            esac
            ;;
        secrets)
            # Source secrets manager
            source "$BASE_DIR/cli/secrets-manager"

            case "${1:-}" in
                validate)
                    secrets_validate "${2:-sindri.yaml}"
                    ;;
                list)
                    secrets_list "${2:-sindri.yaml}"
                    ;;
                test-vault)
                    secrets_test_vault
                    ;;
                encode-file)
                    [[ -z "${2:-}" ]] && echo "Usage: sindri secrets encode-file <path>" && exit 1
                    secrets_encode_file "$2"
                    ;;
                *)
                    echo "Usage: sindri secrets <validate|list|test-vault|encode-file>"
                    ;;
            esac
            ;;
        help|-h|--help)
            show_help
            ;;
        version|-V|--version)
            show_version
            ;;
        *)
            print_error "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
