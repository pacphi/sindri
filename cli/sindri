#!/bin/bash
# Sindri CLI - Main entry point

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_DIR="$(dirname "$SCRIPT_DIR")"

# Source common functions
source "$BASE_DIR/docker/lib/common.sh"

show_help() {
    cat << 'EOH'
sindri - Cloud Development Forge

USAGE:
    sindri <command> [options]

COMMANDS:
    deploy [--provider <name>]   Deploy to provider (docker, fly, devpod)
    validate                     Validate sindri.yaml configuration
    plan                         Show deployment plan
    destroy [--provider <name>] [--force]  Destroy deployment
    connect                      Connect to deployed instance

    profiles list                List available profiles
    profiles show <name>         Show profile details

    config init                  Initialize sindri.yaml
    config validate              Validate configuration

OPTIONS:
    -h, --help                   Show this help
    -c, --config <file>          Use specific config file (default: sindri.yaml)
    -p, --provider <name>        Deployment provider (docker, fly, devpod)
    -v, --verbose                Verbose output

EXAMPLES:
    sindri config init
    sindri deploy --provider docker
    sindri deploy --provider fly
    sindri deploy --provider devpod
    sindri connect
    sindri destroy --provider docker
    sindri destroy --force
EOH
}

# Initialize configuration
config_init() {
    if [[ -f "sindri.yaml" ]]; then
        print_warning "sindri.yaml already exists"
        read -p "Overwrite? (y/N) " -n 1 -r
        echo
        [[ ! $REPLY =~ ^[Yy]$ ]] && return 0
    fi

    cat > sindri.yaml << 'EOYAML'
version: 1.0
name: my-sindri-dev

deployment:
  provider: docker  # Options: docker, fly, devpod
  resources:
    memory: 2GB     # RAM allocation (e.g., 1GB, 2GB, 4GB)
    cpus: 2         # Number of CPUs

  volumes:
    workspace:
      path: /workspace
      size: 10GB    # Persistent volume size

extensions:
  profile: fullstack  # Options: minimal, fullstack, ai-dev, systems, enterprise, devops, cloud-native
  # Or specify custom extensions:
  # active:
  #   - nodejs
  #   - python
  #   - docker

# Secrets configuration (set via provider-specific mechanisms)
secrets:
  # Claude Code
  - name: ANTHROPIC_API_KEY
    source: env

  # GitHub integration
  - name: GITHUB_TOKEN
    source: env
  - name: GIT_USER_NAME
    source: env
  - name: GIT_USER_EMAIL
    source: env

  # AI Tools (optional)
  # - name: OPENROUTER_API_KEY
  #   source: env
  # - name: GOOGLE_GEMINI_API_KEY
  #   source: env
  # - name: PERPLEXITY_API_KEY
  #   source: env

providers:
  # Fly.io configuration
  fly:
    region: sjc                # Fly.io region (sjc, ord, iad, etc.)
    autoStopMachines: true     # Auto-suspend when idle (cost savings)
    autoStartMachines: true    # Auto-resume on connection
    cpuKind: shared            # shared (cost-effective) or performance (dedicated)
    sshPort: 10022             # External SSH port
    organization: personal     # Fly.io organization
    highAvailability: false    # Enable for multi-machine redundancy

  # Docker configuration
  docker:
    network: bridge
    restart: unless-stopped

  # Kubernetes configuration
  kubernetes:
    namespace: default
    storageClass: standard
    ingress:
      enabled: false
      hostname: ""
EOYAML

    print_success "Created sindri.yaml"
    echo ""
    echo "Configuration options:"
    echo "  • Provider: docker (local), fly (cloud), devpod (DevContainer)"
    echo "  • Resources: Adjust memory/cpus based on needs"
    echo "  • Extensions: Choose profile or custom active list"
    echo "  • Secrets: Configure provider-specific secrets"
    echo ""
    echo "Next steps:"
    echo "  1. Edit sindri.yaml to customize your deployment"
    echo "  2. Run: ./cli/sindri deploy"
    echo ""
    echo "For Fly.io deployments:"
    echo "  • Set secrets: flyctl secrets set ANTHROPIC_API_KEY=sk-ant-... -a my-sindri-dev"
    echo "  • See docs/FLY_DEPLOYMENT.md for complete guide"
    echo ""
}

# Validate configuration
config_validate() {
    local config="${1:-sindri.yaml}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found"
        return 1
    fi

    # Validate against schema
    local schema="$BASE_DIR/docker/lib/schemas/sindri.schema.json"
    if [[ -f "$schema" ]]; then
        validate_yaml_schema "$config" "$schema"
    fi

    print_success "Configuration valid"
}

# Deploy to provider
deploy() {
    local provider="${1:-}"
    local config="${2:-sindri.yaml}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found. Run: sindri config init"
        return 1
    fi

    # Use provider from config if not specified via command line
    if [[ -z "$provider" ]]; then
        provider=$(yq '.deployment.provider' "$config" 2>/dev/null || echo "docker")
    fi

    print_header "Deploying with $provider provider"

    case "$provider" in
        docker)
            "$BASE_DIR/deploy/adapters/docker-adapter.sh" "$config"
            ;;
        fly)
            "$BASE_DIR/deploy/adapters/fly-adapter.sh" "$config"
            ;;
        devpod)
            "$BASE_DIR/deploy/adapters/devpod-adapter.sh" "$config"
            ;;
        *)
            print_error "Unknown provider: $provider"
            echo "Available providers: docker, fly, devpod"
            return 1
            ;;
    esac
}

# Connect to instance
connect() {
    local config="${1:-sindri.yaml}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found"
        return 1
    fi

    local name provider
    name=$(yq '.name' "$config")
    provider=$(yq '.deployment.provider' "$config")

    case "$provider" in
        docker)
            docker exec -it "$name" /bin/bash
            ;;
        fly)
            flyctl ssh console -a "$name"
            ;;
        devpod)
            devpod ssh "$name"
            ;;
        *)
            print_error "Unknown provider: $provider"
            ;;
    esac
}

# Destroy deployment
destroy() {
    local provider="${1:-}"
    local force="${2:-}"
    local config="${3:-sindri.yaml}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found"
        return 1
    fi

    # Use provider from config if not specified via command line
    if [[ -z "$provider" ]]; then
        provider=$(yq '.deployment.provider' "$config" 2>/dev/null || echo "docker")
    fi

    local name
    name=$(yq '.name' "$config")

    # Confirmation prompt unless --force is used
    if [[ "$force" != "--force" ]]; then
        print_warning "This will destroy the deployment '$name' on provider '$provider'"
        read -p "Are you sure? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_status "Destroy cancelled"
            return 0
        fi
    fi

    print_header "Destroying $name on $provider"

    case "$provider" in
        docker)
            # Stop and remove container
            if docker ps -a | grep -q "$name"; then
                print_status "Stopping container $name..."
                docker stop "$name" 2>/dev/null || true
                print_status "Removing container $name..."
                docker rm "$name" 2>/dev/null || true
            fi

            # Remove docker-compose resources if exists
            if [[ -f "docker-compose.yml" ]]; then
                print_status "Removing docker-compose resources..."
                docker-compose down -v 2>/dev/null || true
                rm -f docker-compose.yml
            fi

            print_success "Docker deployment destroyed"
            ;;
        fly)
            print_status "Destroying Fly.io app $name..."

            # Delete the app (this also deletes volumes and secrets)
            if flyctl apps list | grep -q "$name"; then
                flyctl apps destroy "$name" --yes
            else
                print_warning "App $name not found on Fly.io"
            fi

            # Remove fly.toml
            if [[ -f "fly.toml" ]]; then
                rm -f fly.toml
                print_status "Removed fly.toml"
            fi

            print_success "Fly.io deployment destroyed"
            ;;
        devpod)
            print_status "Destroying DevPod workspace..."

            # Stop and delete DevPod workspace
            if devpod list | grep -q "$name"; then
                devpod delete "$name" --force
            fi

            # Remove .devcontainer directory
            if [[ -d ".devcontainer" ]]; then
                rm -rf .devcontainer
                print_status "Removed .devcontainer directory"
            fi

            print_success "DevPod deployment destroyed"
            ;;
        *)
            print_error "Unknown provider: $provider"
            echo "Available providers: docker, fly, devpod"
            return 1
            ;;
    esac
}

# Show deployment plan
plan() {
    local config="${1:-sindri.yaml}"

    if [[ ! -f "$config" ]]; then
        print_error "$config not found"
        return 1
    fi

    print_header "Deployment Plan"

    # Parse configuration
    local name provider memory cpus volume_size profile
    name=$(yq '.name' "$config")
    provider=$(yq '.deployment.provider' "$config")
    memory=$(yq '.deployment.resources.memory // "2GB"' "$config")
    cpus=$(yq '.deployment.resources.cpus // 2' "$config")
    volume_size=$(yq '.deployment.volumes.workspace.size // "10GB"' "$config")
    profile=$(yq '.extensions.profile // "minimal"' "$config")

    echo ""
    echo "Configuration Summary:"
    echo "  Name:        $name"
    echo "  Provider:    $provider"
    echo "  Memory:      $memory"
    echo "  CPUs:        $cpus"
    echo "  Volume:      $volume_size"
    echo "  Profile:     $profile"
    echo ""

    case "$provider" in
        docker)
            echo "Docker Deployment Plan:"
            echo "  • Build or use sindri:latest image"
            echo "  • Create docker-compose.yml"
            echo "  • Create persistent volume: workspace"
            echo "  • Start container with resource limits"
            echo "  • Install extension profile: $profile"
            echo ""
            echo "Commands to be executed:"
            echo "  docker build -t sindri:latest -f docker/Dockerfile ."
            echo "  docker-compose up -d"
            echo ""
            ;;
        fly)
            local region auto_stop ssh_port
            region=$(yq '.providers.fly.region // "sjc"' "$config")
            auto_stop=$(yq '.providers.fly.autoStopMachines // true' "$config")
            ssh_port=$(yq '.providers.fly.sshPort // 10022' "$config")

            echo "Fly.io Deployment Plan:"
            echo "  • Region:    $region"
            echo "  • Auto-stop: $auto_stop"
            echo "  • SSH Port:  $ssh_port"
            echo ""
            echo "Actions:"
            echo "  • Generate fly.toml configuration"
            echo "  • Create app: $name"
            echo "  • Create volume: workspace (${volume_size})"
            echo "  • Deploy application"
            echo "  • Install extension profile: $profile"
            echo ""
            echo "Commands to be executed:"
            echo "  flyctl apps create $name --org personal"
            echo "  flyctl volumes create workspace -s ${volume_size//GB/} -r $region -a $name"
            echo "  flyctl deploy --ha=false"
            echo ""
            ;;
        devpod)
            echo "DevPod/DevContainer Deployment Plan:"
            echo "  • Generate .devcontainer/devcontainer.json"
            echo "  • Generate .devcontainer/provider.yaml"
            echo "  • Configure VS Code extensions"
            echo "  • Mount workspace volume"
            echo "  • Install extension profile: $profile"
            echo ""
            echo "Next steps:"
            echo "  • Use with DevPod: devpod up . --provider docker"
            echo "  • Use with VS Code: Open in DevContainer"
            echo "  • Use with GitHub Codespaces: Push and create codespace"
            echo ""
            ;;
        *)
            print_error "Unknown provider: $provider"
            ;;
    esac

    # Show secrets if configured
    local secrets
    secrets=$(yq '.secrets[]?.name' "$config" 2>/dev/null || true)
    if [[ ! -z "$secrets" ]]; then
        echo "Secrets to configure:"
        echo "$secrets" | while read -r secret; do
            echo "  • $secret"
        done
        echo ""
    fi

    print_success "Plan complete. Run 'sindri deploy' to execute."
}

# Main
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        deploy)
            local provider=""
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -p|--provider)
                        provider="$2"
                        shift 2
                        ;;
                    *)
                        shift
                        ;;
                esac
            done
            deploy "$provider"
            ;;
        validate)
            config_validate "$@"
            ;;
        connect)
            connect "$@"
            ;;
        destroy)
            local provider=""
            local force=""
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    -p|--provider)
                        provider="$2"
                        shift 2
                        ;;
                    -f|--force)
                        force="--force"
                        shift
                        ;;
                    *)
                        shift
                        ;;
                esac
            done
            destroy "$provider" "$force"
            ;;
        plan)
            plan "$@"
            ;;
        config)
            case "${1:-}" in
                init)
                    config_init
                    ;;
                validate)
                    config_validate "${2:-sindri.yaml}"
                    ;;
                *)
                    echo "Usage: sindri config <init|validate>"
                    ;;
            esac
            ;;
        profiles)
            case "${1:-}" in
                list)
                    "$BASE_DIR/cli/extension-manager" list-profiles
                    ;;
                show)
                    [[ -z "${2:-}" ]] && echo "Usage: sindri profiles show <name>" && exit 1
                    yq ".profiles.\"$2\"" "$BASE_DIR/docker/lib/profiles.yaml"
                    ;;
                *)
                    echo "Usage: sindri profiles <list|show>"
                    ;;
            esac
            ;;
        help|-h|--help)
            show_help
            ;;
        *)
            print_error "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
