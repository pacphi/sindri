#!/bin/bash
# ai-tools.sh.example - AI CLI tools and coding assistants
# Extension API v1.0
#
# This extension installs AI CLI tools with:
# - Autonomous agents (Codex, Plandex, Hector)
# - Platform CLIs (Gemini, GitHub Copilot, AWS Q)
# - Local models (Ollama)
# - Framework tools (Fabric, Grok)
# - AI workspace setup

# Source shared extension library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$(dirname "$SCRIPT_DIR")/extensions-common.sh"

# ============================================================================
# METADATA
# ============================================================================

EXT_NAME="ai-tools"
EXT_VERSION="1.0.0"
EXT_DESCRIPTION="AI CLI tools and coding assistants (Codex, Gemini, Ollama, Fabric, etc.)"
EXT_CATEGORY="ai-tools"

# Initialize extension environment
extension_init

# ============================================================================
# PREREQUISITES
# ============================================================================

prerequisites() {
  print_status "Checking prerequisites for ${EXT_NAME}..."

  # Check for npm (required for most tools)
  if ! command_exists npm; then
    print_error "npm is required but not found"
    print_status "Install the nodejs extension first"
    return 1
  fi

  # Check for required tools
  local missing_tools=()
  for tool in curl wget sudo; do
    if ! command_exists "$tool"; then
      missing_tools+=("$tool")
    fi
  done

  if [[ ${#missing_tools[@]} -gt 0 ]]; then
    print_error "Missing required tools: ${missing_tools[*]}"
    print_status "Install with: sudo apt-get install ${missing_tools[*]}"
    return 1
  fi

  # Check disk space (AI tools need ~1GB)
  local available_space
  available_space=$(df -BM / | awk 'NR==2 {print $4}' | sed 's/M//')
  if [[ $available_space -lt 1500 ]]; then
    print_warning "Low disk space: ${available_space}MB available (1.5GB recommended for AI tools)"
  fi

  # Optional dependencies (not required but enable more tools)
  local optional_deps=(go pip gh aws)
  local available_deps=()
  for dep in "${optional_deps[@]}"; do
    command_exists "$dep" && available_deps+=("$dep")
  done
  if [[ ${#available_deps[@]} -gt 0 ]]; then
    print_status "Optional dependencies available: ${available_deps[*]}"
  fi

  print_success "All prerequisites met"
  return 0
}

# ============================================================================
# INSTALL
# ============================================================================

install() {
  print_status "Installing AI CLI tools and coding assistants..."

  # Codex CLI
  print_status "Installing Codex CLI..."
  if command_exists codex; then
    print_warning "Codex CLI already installed"
  else
    local install_output
    if install_output=$(npm install -g codex-cli 2>&1); then
      if command_exists codex; then
        print_success "Codex CLI installed"
      else
        print_warning "Failed to install Codex CLI - binary not found after installation"
        print_debug "npm output: $install_output"
      fi
    else
      print_warning "Failed to install Codex CLI"
      echo "$install_output" | grep -i "error\|warn" | head -5
    fi
  fi

  # Gemini CLI
  print_status "Installing Gemini CLI..."
  if command_exists gemini; then
    print_warning "Gemini CLI already installed"
  else
    local install_output
    if install_output=$(npm install -g @google/gemini-cli 2>&1); then
      if command_exists gemini; then
        print_success "Gemini CLI installed"
      else
        print_warning "Failed to install Gemini CLI - binary not found after installation"
        print_debug "npm output: $install_output"
      fi
    else
      print_warning "Failed to install Gemini CLI"
      echo "$install_output" | grep -i "error\|warn" | head -5
    fi
  fi

  # GitHub Copilot CLI
  print_status "Installing GitHub Copilot CLI..."
  if command_exists gh; then
    if gh extension list 2>/dev/null | grep -q "github/gh-copilot"; then
      print_warning "GitHub Copilot CLI already installed"
    else
      local install_output
      if install_output=$(gh extension install github/gh-copilot 2>&1); then
        print_success "GitHub Copilot CLI installed"
      else
        print_warning "Failed to install GitHub Copilot CLI"
        echo "$install_output" | grep -i "error\|warn" | head -3
      fi
    fi
  else
    print_warning "GitHub CLI (gh) not found - skipping GitHub Copilot CLI"
    print_status "Install github-cli extension for gh"
  fi

  # Check AWS CLI for Amazon Q
  if command_exists aws; then
    print_status "AWS CLI available - Amazon Q Developer accessible via 'aws q' commands"
  else
    print_warning "AWS CLI not found - Amazon Q Developer unavailable"
    print_status "Install cloud-tools extension for AWS CLI"
  fi

  # Check if running in CI mode
  if [[ "$CI_MODE" == "true" ]]; then
    print_status "CI mode detected - skipping optional tools (Ollama, Fabric, Go/Python tools)"
    return 0
  fi

  # Ollama
  print_status "Installing Ollama..."
  if command_exists ollama; then
    print_warning "Ollama already installed"
  else
    local install_output
    if install_output=$(curl -fsSL https://ollama.ai/install.sh | sh 2>&1); then
      if command_exists ollama; then
        print_success "Ollama installed"
        print_status "Start with: nohup ollama serve > ~/ollama.log 2>&1 &"
      else
        print_warning "Failed to install Ollama - binary not found after installation"
      fi
    else
      print_warning "Failed to install Ollama"
      echo "$install_output" | grep -i "error\|warn" | head -3
    fi
  fi

  # Fabric
  print_status "Installing Fabric..."
  if command_exists fabric; then
    print_warning "Fabric already installed"
  else
    local ARCH=$(uname -m)
    local FABRIC_ARCH="amd64"
    [[ "$ARCH" == "aarch64" ]] && FABRIC_ARCH="arm64"

    local install_output
    if install_output=$(curl -L "https://github.com/danielmiessler/fabric/releases/latest/download/fabric-linux-${FABRIC_ARCH}" -o fabric 2>&1); then
      chmod +x fabric
      if sudo mv fabric /usr/local/bin/; then
        print_success "Fabric installed"
        print_status "Initialize with: fabric --setup"
      else
        print_warning "Failed to move Fabric to /usr/local/bin"
      fi
    else
      print_warning "Failed to download Fabric"
      echo "$install_output" | grep -i "error\|warn" | head -3
    fi
  fi

  # Go-based tools (require Go)
  if command_exists go; then
    # Set up Go bin path
    export GOPATH=$HOME/go
    export GOBIN=$GOPATH/bin
    export PATH=$PATH:$GOBIN
    mkdir -p "$GOBIN"

    # Plandex
    print_status "Installing Plandex..."
    if command_exists plandex; then
      print_warning "Plandex already installed"
    else
      local install_output
      if install_output=$(timeout 300 go install github.com/plandex-ai/plandex@latest 2>&1); then
        if command_exists plandex; then
          print_success "Plandex installed"
        else
          print_warning "Failed to install Plandex - binary not found after installation"
        fi
      else
        print_warning "Failed to install Plandex"
        echo "$install_output" | grep -i "error\|warn" | head -3
      fi
    fi

    # Hector
    print_status "Installing Hector..."
    if command_exists hector; then
      print_warning "Hector already installed"
    else
      local install_output
      if install_output=$(timeout 300 go install github.com/kadirpekel/hector/cmd/hector@latest 2>&1); then
        if command_exists hector; then
          print_success "Hector installed"
        else
          print_warning "Failed to install Hector - binary not found after installation"
        fi
      else
        print_warning "Failed to install Hector"
        echo "$install_output" | grep -i "error\|warn" | head -3
      fi
    fi
  else
    print_warning "Go not found - skipping Plandex and Hector"
    print_status "Install golang extension for Go-based tools"
  fi

  # Python-based tools (require pip)
  if command_exists pip || command_exists pip3; then
    local pip_cmd="pip"
    command_exists pip3 && pip_cmd="pip3"

    # Grok CLI
    print_status "Installing Grok CLI..."
    if command_exists grok; then
      print_warning "Grok CLI already installed"
    else
      local install_output
      if install_output=$($pip_cmd install grok-cli 2>&1); then
        if command_exists grok; then
          print_success "Grok CLI installed"
        else
          print_warning "Failed to install Grok CLI - binary not found after installation"
        fi
      else
        print_warning "Failed to install Grok CLI"
        echo "$install_output" | grep -i "error\|warn" | head -3
      fi
    fi
  else
    print_warning "pip not found - skipping Grok CLI"
    print_status "Install python extension for Python-based tools"
  fi

  return 0
}

# ============================================================================
# CONFIGURE
# ============================================================================

configure() {
  print_status "Configuring AI CLI tools..."

  # Configure Go bin PATH for SSH sessions (if Go tools were installed)
  if command_exists go && [[ -d "$HOME/go/bin" ]]; then
    if command_exists setup_tool_path 2>/dev/null; then
      setup_tool_path "go-tools" 'export PATH=$PATH:$HOME/go/bin'
    else
      # Fallback: add to bashrc
      if ! grep -q '$HOME/go/bin' "$HOME/.bashrc" 2>/dev/null; then
        echo "" >> "$HOME/.bashrc"
        echo "# ${EXT_NAME} - Go tools" >> "$HOME/.bashrc"
        echo 'export PATH=$PATH:$HOME/go/bin' >> "$HOME/.bashrc"
        print_success "Added Go tools to PATH"
      fi
    fi
    export PATH=$PATH:$HOME/go/bin
  fi

  # Create SSH wrappers
  if command_exists create_tool_wrapper 2>/dev/null; then
    local ai_tools=(codex gemini ollama fabric plandex hector grok)
    for tool in "${ai_tools[@]}"; do
      if command_exists "$tool"; then
        create_tool_wrapper "$tool" "$(which $tool)"
      fi
    done
  fi

  # Create AI tools aliases
  if ! grep -q "# AI tools aliases" "$HOME/.bashrc" 2>/dev/null; then
    print_status "Creating AI tools aliases..."
    cat >> "$HOME/.bashrc" << 'EOF'

# AI tools aliases
# Codex
alias cx="codex"
alias cxs="codex suggest"
alias cxe="codex edit"
alias cxr="codex run"

# Gemini
alias gm="gemini"
alias gmc="gemini chat"
alias gmg="gemini generate"

# Ollama
alias ol="ollama"
alias olp="ollama pull"
alias olr="ollama run"
alias oll="ollama list"

# Fabric
alias fb="fabric"
alias fbex="fabric --pattern explain"
alias fbsum="fabric --pattern summarize"
alias fbimp="fabric --pattern improve_code"

# Plandex
alias px="plandex"
alias pxi="plandex init"
alias pxp="plandex plan"
alias pxe="plandex execute"
alias pxs="plandex status"

# GitHub Copilot
alias ghcp="gh copilot suggest"
alias ghce="gh copilot explain"

# AWS Q
alias awsq="aws q"
EOF
    print_success "AI tools aliases created"
  else
    print_debug "AI tools aliases already exist"
  fi

  # Create AI tools workspace
  local WORKSPACE_DIR="${WORKSPACE_DIR:-/workspace}"
  print_status "Setting up AI tools workspace..."
  mkdir -p "$WORKSPACE_DIR/ai-tools"/{ollama-models,fabric-patterns,projects}

  # Create comprehensive README (truncated for brevity - includes full content)
  if [[ ! -f "$WORKSPACE_DIR/ai-tools/README.md" ]]; then
    cat > "$WORKSPACE_DIR/ai-tools/README.md" << 'EOF'
# AI CLI Tools and Coding Assistants

## Installed AI Tools

### Autonomous Coding Agents

#### Codex CLI
- **Command**: `codex`
- **Description**: Multi-mode AI assistant with suggest, edit, and run capabilities
- **Usage**:
  ```bash
  codex suggest "how to optimize this function"
  codex edit file.js
  codex run "create a REST API"
  ```

#### Plandex
- **Command**: `plandex`
- **Prerequisites**: Requires Go
- **Usage**:
  ```bash
  plandex init
  plandex plan "add user authentication"
  plandex execute
  ```

#### Hector
- **Command**: `hector`
- **Prerequisites**: Requires Go
- **Description**: Pure A2A-Native declarative AI agent platform using YAML
- **Usage**:
  ```bash
  hector serve --config agent.yaml
  hector chat assistant
  hector call assistant "task"
  hector list
  ```

### Major Platform CLIs

#### Gemini CLI
- **Command**: `gemini`
- **API Key**: Set `GOOGLE_GEMINI_API_KEY`
- **Get Key**: https://makersuite.google.com/app/apikey
- **Usage**: `gemini chat "explain this code"`

#### GitHub Copilot CLI
- **Command**: `gh copilot`
- **Prerequisites**: GitHub CLI and Copilot subscription
- **Usage**:
  ```bash
  gh copilot suggest "git command to undo"
  gh copilot explain "docker-compose up"
  ```

#### Amazon Q Developer
- **Command**: `aws q`
- **Prerequisites**: AWS CLI
- **Usage**: `aws q chat`

### Local Model Management

#### Ollama
- **Command**: `ollama`
- **Description**: Run LLMs locally
- **Start**: `nohup ollama serve > ~/ollama.log 2>&1 &`
- **Usage**:
  ```bash
  ollama pull llama3.2
  ollama run llama3.2
  ollama list
  ```

#### Grok CLI
- **Command**: `grok`
- **Prerequisites**: Python/pip
- **API Key**: Set `GROK_API_KEY`
- **Usage**: `grok chat`

### Framework Tools

#### Fabric
- **Command**: `fabric`
- **Description**: AI pattern framework
- **Setup**: `fabric --setup`
- **Usage**:
  ```bash
  echo "code" | fabric --pattern explain
  fabric --list
  ```

## API Key Requirements

- **Google Gemini**: `GOOGLE_GEMINI_API_KEY` - https://makersuite.google.com/app/apikey
- **GitHub Copilot**: GitHub account with subscription
- **AWS Q**: AWS credentials
- **Grok**: `GROK_API_KEY` - xAI account
- **Ollama**: No API key (local)

### Setting API Keys

```bash
# Via Fly.io secrets (recommended)
flyctl secrets set GOOGLE_GEMINI_API_KEY=key -a <app>
flyctl secrets set GROK_API_KEY=key -a <app>

# Or in ~/.bashrc
export GOOGLE_GEMINI_API_KEY=your_key
export GROK_API_KEY=your_key
```

## Directory Structure

```
ai-tools/
├── ollama-models/   # Ollama model storage
├── fabric-patterns/ # Custom Fabric patterns
└── projects/        # AI-assisted projects
```

## Getting Started

**Local AI (no API keys):**
```bash
nohup ollama serve > ~/ollama.log 2>&1 &
ollama pull llama3.2
ollama run llama3.2
```

**Cloud AI (requires API keys):**
```bash
export GOOGLE_GEMINI_API_KEY=your_key
gemini chat "help me debug this"
```

**Development Tasks:**
```bash
plandex init
plandex plan "add JWT authentication"
```

## Best Practices

1. **Cost Management**: Use Ollama for dev/testing
2. **Security**: Never commit API keys
3. **Context**: Provide clear, specific prompts
4. **Validation**: Review AI-generated code
5. **Privacy**: Use local models for sensitive code
EOF
    print_success "AI tools README created"
  fi

  print_success "AI CLI tools configured"
  return 0
}

# ============================================================================
# VALIDATE
# ============================================================================

validate() {
  print_status "Validating AI CLI tools installation..."

  local all_valid=true

  # Core tools (npm-based)
  local core_tools=(codex gemini)
  local core_found=0
  for tool in "${core_tools[@]}"; do
    if command_exists "$tool"; then
      ((core_found++))
      print_success "$tool: installed"
    fi
  done

  if [[ $core_found -eq 0 ]]; then
    print_error "No core AI tools found"
    all_valid=false
  else
    print_status "Core tools: $core_found/${#core_tools[@]}"
  fi

  # Optional tools
  local optional_tools=(ollama fabric plandex hector grok)
  local optional_found=0
  for tool in "${optional_tools[@]}"; do
    command_exists "$tool" && ((optional_found++))
  done
  print_status "Optional tools: $optional_found/${#optional_tools[@]}"

  # Platform CLIs
  local platform_clis=()
  command_exists gh && gh extension list 2>/dev/null | grep -q "gh-copilot" && platform_clis+=("gh-copilot")
  command_exists aws && platform_clis+=("aws-q")
  [[ ${#platform_clis[@]} -gt 0 ]] && print_status "Platform CLIs: ${platform_clis[*]}"

  # Check workspace
  local WORKSPACE_DIR="${WORKSPACE_DIR:-/workspace}"
  if [[ -d "$WORKSPACE_DIR/ai-tools" ]]; then
    print_success "AI tools workspace: exists"
  else
    print_warning "AI tools workspace: not found"
  fi

  if [[ "$all_valid" == "true" ]]; then
    print_success "Validation passed"
    return 0
  else
    print_error "Validation failed"
    return 1
  fi
}

# ============================================================================
# STATUS
# ============================================================================

status() {
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "Extension: $EXT_NAME v$EXT_VERSION"
  echo "Description: $EXT_DESCRIPTION"
  echo "Category: $EXT_CATEGORY"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""

  # Check installation status - at least one core tool should be present
  local core_tools=(codex gemini)
  local found_core=false
  for tool in "${core_tools[@]}"; do
    if command_exists "$tool"; then
      found_core=true
      break
    fi
  done

  if ! $found_core; then
    echo "Status: ✗ NOT INSTALLED"
    return 1
  fi

  echo "Status: ✓ INSTALLED"
  echo ""

  # Extension-specific tool listing with versions
  print_status "Installed tools:"

  # Core tools
  echo ""
  echo "  Core tools (npm):"
  for tool in "${core_tools[@]}"; do
    if command_exists "$tool"; then
      local version=$($tool --version 2>/dev/null || echo "installed")
      echo "    ✓ $tool: $version"
    else
      echo "    ✗ $tool: not installed"
    fi
  done

  # Optional tools
  echo ""
  echo "  Optional tools:"
  local optional_tools=(ollama fabric plandex hector grok)
  for tool in "${optional_tools[@]}"; do
    if command_exists "$tool"; then
      local version=""
      case "$tool" in
        ollama) version=$(ollama --version 2>/dev/null) ;;
        fabric) version=$(fabric --version 2>/dev/null) ;;
        plandex) version=$(plandex version 2>/dev/null) ;;
        hector) version=$(hector version 2>/dev/null) ;;
        grok) version=$(grok --version 2>/dev/null) ;;
      esac
      echo "    ✓ $tool: ${version:-installed}"
    fi
  done

  # Platform CLIs
  echo ""
  echo "  Platform CLIs:"
  if command_exists gh && gh extension list 2>/dev/null | grep -q "gh-copilot"; then
    echo "    ✓ GitHub Copilot CLI (via gh extension)"
  fi
  if command_exists aws; then
    echo "    ✓ AWS Q Developer (via aws q)"
  fi

  # Dependencies
  echo ""
  print_status "Dependencies:"
  command_exists go && echo "  ✓ Go (enables Plandex, Hector)"
  command_exists pip && echo "  ✓ pip (enables Grok)"
  command_exists gh && echo "  ✓ gh (enables GitHub Copilot)"
  command_exists aws && echo "  ✓ aws (enables Amazon Q)"

  # Workspace
  echo ""
  local WORKSPACE_DIR="${WORKSPACE_DIR:-/workspace}"
  if [[ -d "$WORKSPACE_DIR/ai-tools" ]]; then
    print_status "AI tools workspace:"
    echo "  $WORKSPACE_DIR/ai-tools/"
    for dir in ollama-models fabric-patterns projects; do
      [[ -d "$WORKSPACE_DIR/ai-tools/$dir" ]] && echo "    ├── $dir/"
    done
  fi

  return 0
}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

check_dependent_extensions() {
  local provided_commands=("$@")
  local dependent_extensions=()
  local manifest_file="$SCRIPT_DIR/active-extensions.conf"
  [[ ! -f "$manifest_file" ]] && manifest_file="/workspace/scripts/extensions.d/active-extensions.conf"
  [[ ! -f "$manifest_file" ]] && return 0

  while IFS= read -r line; do
    [[ "$line" =~ ^[[:space:]]*# ]] && continue
    [[ -z "${line// }" ]] && continue
    local ext_name=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    [[ "$ext_name" == "$EXT_NAME" ]] && continue
    local ext_file="$SCRIPT_DIR/${ext_name}.sh"
    if [[ ! -f "$ext_file" ]]; then
      local matches=("$SCRIPT_DIR/"*"-${ext_name}.sh")
      ext_file="${matches[0]}"
    fi
    [[ ! -f "$ext_file" ]] && continue
    for cmd in "${provided_commands[@]}"; do
      if grep -q "$cmd" "$ext_file" 2>/dev/null; then
        dependent_extensions+=("$ext_name")
        break
      fi
    done
  done < "$manifest_file"

  printf '%s\n' "${dependent_extensions[@]}"
}

# ============================================================================
# REMOVE
# ============================================================================

remove() {
  print_warning "Uninstalling AI CLI tools..."

  local dependent_exts=()
  mapfile -t dependent_exts < <(check_dependent_extensions "codex" "gemini" "ollama" "fabric" "plandex")
  if [[ ${#dependent_exts[@]} -gt 0 ]]; then
    print_warning "The following extensions depend on AI tools and may stop working:"
    for ext in "${dependent_exts[@]}"; do
      echo "  - $ext"
    done
    echo ""
  fi

  if ! prompt_confirmation "Continue with AI tools removal?"; then
    print_status "Removal cancelled"
    return 1
  fi

  # Remove npm-based tools
  print_status "Removing npm-based tools..."
  local npm_tools=(codex-cli @google/gemini-cli)
  for tool in "${npm_tools[@]}"; do
    if npm list -g "$tool" 2>/dev/null | grep -q "$tool"; then
      npm uninstall -g "$tool" 2>/dev/null
    fi
  done

  # Remove GitHub Copilot extension
  if command_exists gh && gh extension list 2>/dev/null | grep -q "gh-copilot"; then
    gh extension remove github/gh-copilot 2>/dev/null
    print_success "GitHub Copilot CLI removed"
  fi

  # Remove Ollama
  if command_exists ollama; then
    print_status "Removing Ollama..."
    sudo systemctl stop ollama 2>/dev/null || killall ollama 2>/dev/null
    sudo rm -f /usr/local/bin/ollama /usr/bin/ollama
    rm -rf ~/.ollama
    print_success "Ollama removed"
  fi

  # Remove Fabric
  [[ -f /usr/local/bin/fabric ]] && sudo rm -f /usr/local/bin/fabric

  # Remove Go-based tools
  if [[ -d "$HOME/go/bin" ]]; then
    for tool in plandex hector; do
      [[ -f "$HOME/go/bin/$tool" ]] && rm -f "$HOME/go/bin/$tool"
    done
  fi

  # Remove Python-based tools
  if command_exists pip || command_exists pip3; then
    local pip_cmd="pip"
    command_exists pip3 && pip_cmd="pip3"
    $pip_cmd uninstall -y grok-cli 2>/dev/null
  fi

  # Remove aliases
  cleanup_bashrc "# AI tools aliases"

  # Remove Go tools PATH from bashrc
  cleanup_bashrc "# ${EXT_NAME}"

  # Remove workspace
  local WORKSPACE_DIR="${WORKSPACE_DIR:-/workspace}"
  if [[ -d "$WORKSPACE_DIR/ai-tools" ]]; then
    read -p "Remove AI tools workspace directory? (y/N): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      rm -rf "$WORKSPACE_DIR/ai-tools"
      print_success "AI tools workspace removed"
    fi
  fi

  print_success "AI CLI tools uninstalled"
  print_warning "Restart shell: source ~/.bashrc"
  return 0
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

extension_main "$@"
