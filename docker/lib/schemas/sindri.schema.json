{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://sindri.dev/schemas/sindri.schema.json",
  "title": "Sindri Configuration",
  "description": "Provider-agnostic Sindri deployment configuration",
  "type": "object",
  "required": ["version", "name", "deployment", "extensions"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$"
    },
    "name": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Deployment name"
    },
    "deployment": {
      "type": "object",
      "required": ["provider"],
      "properties": {
        "provider": {
          "type": "string",
          "enum": ["fly", "kubernetes", "docker-compose", "devpod"],
          "description": "Deployment provider"
        },
        "image": {
          "type": "string",
          "description": "Docker image to deploy"
        },
        "resources": {
          "type": "object",
          "properties": {
            "memory": {
              "type": "string",
              "pattern": "^\\d+(MB|GB)$"
            },
            "cpus": {
              "type": "integer",
              "minimum": 1
            }
          }
        },
        "volumes": {
          "type": "object",
          "properties": {
            "workspace": {
              "type": "object",
              "properties": {
                "path": {
                  "type": "string",
                  "default": "/workspace"
                },
                "size": {
                  "type": "string",
                  "pattern": "^\\d+(MB|GB)$",
                  "default": "10GB"
                }
              }
            }
          }
        }
      }
    },
    "extensions": {
      "type": "object",
      "oneOf": [
        {
          "required": ["profile"],
          "properties": {
            "profile": {
              "type": "string",
              "enum": [
                "minimal",
                "fullstack",
                "ai-dev",
                "anthropic-dev",
                "systems",
                "enterprise",
                "data-science",
                "devops",
                "mobile"
              ]
            }
          }
        },
        {
          "required": ["active"],
          "properties": {
            "active": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        }
      ]
    },
    "secrets": {
      "type": "array",
      "description": "Secrets to inject into the deployment",
      "items": {
        "type": "object",
        "required": ["name", "source"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Environment variable name for the secret",
            "pattern": "^[A-Z][A-Z0-9_]*$"
          },
          "source": {
            "type": "string",
            "enum": ["env", "file", "vault"],
            "description": "Source type: env (environment/file), file (file mount), vault (HashiCorp Vault)"
          },
          "required": {
            "type": "boolean",
            "default": false,
            "description": "Fail deployment if secret is not available"
          },
          "path": {
            "type": "string",
            "description": "File path (for source: file)"
          },
          "mountPath": {
            "type": "string",
            "description": "Container destination path (for source: file)"
          },
          "permissions": {
            "type": "string",
            "pattern": "^0[0-7]{3}$",
            "default": "0644",
            "description": "Unix file permissions in octal (for source: file)"
          },
          "vaultPath": {
            "type": "string",
            "description": "Vault KV path (for source: vault)"
          },
          "vaultKey": {
            "type": "string",
            "description": "Key within the Vault secret (for source: vault)"
          },
          "vaultMount": {
            "type": "string",
            "default": "secret",
            "description": "Vault mount point (for source: vault)"
          }
        },
        "allOf": [
          {
            "if": {
              "properties": { "source": { "const": "file" } }
            },
            "then": {
              "required": ["path", "mountPath"]
            }
          },
          {
            "if": {
              "properties": { "source": { "const": "vault" } }
            },
            "then": {
              "required": ["vaultPath", "vaultKey"]
            }
          }
        ]
      }
    },
    "providers": {
      "type": "object",
      "properties": {
        "fly": {
          "type": "object",
          "properties": {
            "region": {
              "type": "string",
              "default": "sjc",
              "description": "Fly.io region code (e.g., sjc, ord, iad, ams)"
            },
            "autoStopMachines": {
              "type": "boolean",
              "default": true,
              "description": "Auto-suspend machines when idle (cost optimization)"
            },
            "autoStartMachines": {
              "type": "boolean",
              "default": true,
              "description": "Auto-start machines on incoming connections"
            },
            "cpuKind": {
              "type": "string",
              "enum": ["shared", "performance"],
              "default": "shared",
              "description": "CPU type: shared (cost-effective) or performance (dedicated)"
            },
            "sshPort": {
              "type": "integer",
              "minimum": 1024,
              "maximum": 65535,
              "default": 10022,
              "description": "External SSH port"
            },
            "organization": {
              "type": "string",
              "description": "Fly.io organization name"
            },
            "highAvailability": {
              "type": "boolean",
              "default": false,
              "description": "Enable high availability (multiple machines)"
            }
          }
        },
        "kubernetes": {
          "type": "object",
          "properties": {
            "namespace": {
              "type": "string",
              "default": "default"
            },
            "storageClass": {
              "type": "string"
            },
            "ingress": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                },
                "hostname": {
                  "type": "string"
                }
              }
            }
          }
        },
        "devpod": {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["aws", "gcp", "azure", "digitalocean", "kubernetes", "ssh", "docker"],
              "description": "DevPod provider type"
            },
            "aws": {
              "type": "object",
              "description": "AWS EC2 provider options",
              "properties": {
                "region": {
                  "type": "string",
                  "default": "us-west-2",
                  "description": "AWS region"
                },
                "instanceType": {
                  "type": "string",
                  "default": "c5.xlarge",
                  "description": "EC2 instance type"
                },
                "diskSize": {
                  "type": "integer",
                  "default": 40,
                  "description": "Root volume size in GB"
                },
                "useSpot": {
                  "type": "boolean",
                  "default": false,
                  "description": "Use spot instances for cost savings"
                },
                "subnetId": {
                  "type": "string",
                  "description": "VPC subnet ID for instance placement"
                },
                "securityGroupId": {
                  "type": "string",
                  "description": "Security group ID to attach"
                }
              }
            },
            "gcp": {
              "type": "object",
              "description": "GCP Compute Engine provider options",
              "properties": {
                "project": {
                  "type": "string",
                  "description": "GCP project ID"
                },
                "zone": {
                  "type": "string",
                  "default": "us-central1-a",
                  "description": "GCP zone"
                },
                "machineType": {
                  "type": "string",
                  "default": "e2-standard-4",
                  "description": "GCE machine type"
                },
                "diskSize": {
                  "type": "integer",
                  "default": 40,
                  "description": "Boot disk size in GB"
                },
                "diskType": {
                  "type": "string",
                  "enum": ["pd-standard", "pd-balanced", "pd-ssd"],
                  "default": "pd-balanced",
                  "description": "Persistent disk type"
                }
              }
            },
            "azure": {
              "type": "object",
              "description": "Azure VM provider options",
              "properties": {
                "subscription": {
                  "type": "string",
                  "description": "Azure subscription ID"
                },
                "resourceGroup": {
                  "type": "string",
                  "default": "devpod-resources",
                  "description": "Resource group name"
                },
                "location": {
                  "type": "string",
                  "default": "eastus",
                  "description": "Azure region"
                },
                "vmSize": {
                  "type": "string",
                  "default": "Standard_D4s_v3",
                  "description": "VM size"
                },
                "diskSize": {
                  "type": "integer",
                  "default": 40,
                  "description": "OS disk size in GB"
                }
              }
            },
            "digitalocean": {
              "type": "object",
              "description": "DigitalOcean Droplet provider options",
              "properties": {
                "region": {
                  "type": "string",
                  "default": "nyc3",
                  "description": "DigitalOcean region"
                },
                "size": {
                  "type": "string",
                  "default": "s-4vcpu-8gb",
                  "description": "Droplet size"
                },
                "diskSize": {
                  "type": "integer",
                  "description": "Block storage size in GB (optional)"
                }
              }
            },
            "kubernetes": {
              "type": "object",
              "description": "Kubernetes pod provider options",
              "properties": {
                "namespace": {
                  "type": "string",
                  "default": "devpod",
                  "description": "Kubernetes namespace"
                },
                "storageClass": {
                  "type": "string",
                  "description": "Storage class for persistent volumes"
                },
                "context": {
                  "type": "string",
                  "description": "Kubernetes context to use"
                },
                "nodeSelector": {
                  "type": "object",
                  "additionalProperties": {
                    "type": "string"
                  },
                  "description": "Node selector labels"
                }
              }
            },
            "ssh": {
              "type": "object",
              "description": "SSH provider options for existing machines",
              "properties": {
                "host": {
                  "type": "string",
                  "description": "SSH host address"
                },
                "user": {
                  "type": "string",
                  "default": "root",
                  "description": "SSH user"
                },
                "port": {
                  "type": "integer",
                  "default": 22,
                  "description": "SSH port"
                },
                "keyPath": {
                  "type": "string",
                  "default": "~/.ssh/id_rsa",
                  "description": "Path to SSH private key"
                }
              }
            },
            "docker": {
              "type": "object",
              "description": "Local Docker provider options",
              "properties": {
                "dockerHost": {
                  "type": "string",
                  "description": "Docker host URL (defaults to local socket)"
                }
              }
            }
          }
        }
      }
    }
  }
}
