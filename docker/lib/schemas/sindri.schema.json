{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://sindri.dev/schemas/sindri.schema.json",
  "title": "Sindri Configuration",
  "description": "Provider-agnostic Sindri deployment configuration",
  "type": "object",
  "required": ["version", "name", "deployment", "extensions"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$"
    },
    "name": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Deployment name"
    },
    "deployment": {
      "type": "object",
      "required": ["provider"],
      "properties": {
        "provider": {
          "type": "string",
          "enum": ["fly", "kubernetes", "docker-compose"]
        },
        "image": {
          "type": "string",
          "description": "Docker image to deploy"
        },
        "resources": {
          "type": "object",
          "properties": {
            "memory": {
              "type": "string",
              "pattern": "^\\d+(MB|GB)$"
            },
            "cpus": {
              "type": "integer",
              "minimum": 1
            }
          }
        },
        "volumes": {
          "type": "object",
          "properties": {
            "workspace": {
              "type": "object",
              "properties": {
                "path": {
                  "type": "string",
                  "default": "/workspace"
                },
                "size": {
                  "type": "string",
                  "pattern": "^\\d+(MB|GB)$",
                  "default": "10GB"
                }
              }
            }
          }
        }
      }
    },
    "extensions": {
      "type": "object",
      "oneOf": [
        {
          "required": ["profile"],
          "properties": {
            "profile": {
              "type": "string",
              "enum": [
                "minimal",
                "fullstack",
                "ai-dev",
                "systems",
                "enterprise"
              ]
            }
          }
        },
        {
          "required": ["active"],
          "properties": {
            "active": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        }
      ]
    },
    "secrets": {
      "type": "array",
      "description": "Secrets to inject into the deployment",
      "items": {
        "type": "object",
        "required": ["name", "source"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Environment variable name for the secret",
            "pattern": "^[A-Z][A-Z0-9_]*$"
          },
          "source": {
            "type": "string",
            "enum": ["env", "file", "vault"],
            "description": "Source type: env (environment/file), file (file mount), vault (HashiCorp Vault)"
          },
          "required": {
            "type": "boolean",
            "default": false,
            "description": "Fail deployment if secret is not available"
          },
          "path": {
            "type": "string",
            "description": "File path (for source: file)"
          },
          "mountPath": {
            "type": "string",
            "description": "Container destination path (for source: file)"
          },
          "permissions": {
            "type": "string",
            "pattern": "^0[0-7]{3}$",
            "default": "0644",
            "description": "Unix file permissions in octal (for source: file)"
          },
          "vaultPath": {
            "type": "string",
            "description": "Vault KV path (for source: vault)"
          },
          "vaultKey": {
            "type": "string",
            "description": "Key within the Vault secret (for source: vault)"
          },
          "vaultMount": {
            "type": "string",
            "default": "secret",
            "description": "Vault mount point (for source: vault)"
          }
        },
        "allOf": [
          {
            "if": {
              "properties": { "source": { "const": "file" } }
            },
            "then": {
              "required": ["path", "mountPath"]
            }
          },
          {
            "if": {
              "properties": { "source": { "const": "vault" } }
            },
            "then": {
              "required": ["vaultPath", "vaultKey"]
            }
          }
        ]
      }
    },
    "providers": {
      "type": "object",
      "properties": {
        "fly": {
          "type": "object",
          "properties": {
            "region": {
              "type": "string",
              "default": "sjc",
              "description": "Fly.io region code (e.g., sjc, ord, iad)"
            },
            "autoStopMachines": {
              "type": "boolean",
              "default": true,
              "description": "Auto-suspend machines when idle (cost optimization)"
            },
            "autoStartMachines": {
              "type": "boolean",
              "default": true,
              "description": "Auto-start machines on incoming connections"
            },
            "cpuKind": {
              "type": "string",
              "enum": ["shared", "performance"],
              "default": "shared",
              "description": "CPU type: shared (cost-effective) or performance (dedicated)"
            },
            "sshPort": {
              "type": "integer",
              "minimum": 1024,
              "maximum": 65535,
              "default": 10022,
              "description": "External SSH port"
            },
            "organization": {
              "type": "string",
              "description": "Fly.io organization name"
            },
            "highAvailability": {
              "type": "boolean",
              "default": false,
              "description": "Enable high availability (multiple machines)"
            }
          }
        },
        "kubernetes": {
          "type": "object",
          "properties": {
            "namespace": {
              "type": "string",
              "default": "default"
            },
            "storageClass": {
              "type": "string"
            },
            "ingress": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                },
                "hostname": {
                  "type": "string"
                }
              }
            }
          }
        }
      }
    }
  }
}
