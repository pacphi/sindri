# Changelog Management Guide

This document explains how Sindri manages changelogs across multiple major versions (v1, v2, v3) and the automation that supports it.

---

## Table of Contents

- [Overview](#overview)
- [Changelog Structure](#changelog-structure)
- [Automation Scripts](#automation-scripts)
- [Release Workflows](#release-workflows)
- [Version Validation](#version-validation)
- [Migration Guides](#migration-guides)
- [Best Practices](#best-practices)
- [Troubleshooting](#troubleshooting)

---

## Overview

### Why Version-Specific Changelogs?

Sindri maintains **separate changelogs for each major version** (v1, v2, v3) instead of a single monolithic file. This approach provides:

1. **Clarity**: Users can easily find changes relevant to their version
2. **Conflict Prevention**: v2 and v3 releases can happen concurrently without merge conflicts
3. **Scalability**: Root CHANGELOG.md would exceed 1000+ lines with all versions
4. **Better Organization**: Clear version boundaries and navigation

This pattern is based on:

- [Keep a Changelog Discussion #526](https://github.com/olivierlacan/keep-a-changelog/discussions/526)
- [Monorepo Versioning Best Practices](https://dev.to/jellyfith/monorepo-versioning-stop-the-chaos-3oij)

---

## Changelog Structure

### File Organization

```
/CHANGELOG.md              # Link library/index (navigation hub)
/v1/CHANGELOG.md           # v1-specific (v1.0.0 → v1.13.0) - ARCHIVED
/v2/CHANGELOG.md           # v2-specific (v2.0.0+) - Bash/Docker
/v3/CHANGELOG.md           # v3-specific (v3.0.0+) - Rust
/RELEASE_NOTES.v2.md       # Migration guide: v1 → v2
/RELEASE_NOTES.v3.md       # Migration guide: v2 → v3 (to be published)
```

### Root CHANGELOG.md

The root CHANGELOG.md is now a **link library** that:

- Provides quick navigation to version-specific changelogs
- Lists migration guides
- Shows version status (active, maintenance, archived)
- Links to releases and documentation

### Version-Specific Changelogs

Each major version has its own changelog:

**v1/CHANGELOG.md**:

- Status: Archived (no new releases)
- End of Life: January 2026
- Contains v1.0.0 through v1.13.0

**v2/CHANGELOG.md**:

- Status: Maintenance mode
- Architecture: Bash/Docker
- Auto-generated by `.github/workflows/release-v2.yml`

**v3/CHANGELOG.md**:

- Status: Active development
- Architecture: Rust binary
- Auto-generated by `.github/workflows/release-v3.yml`

---

## Automation Scripts

All automation scripts are located in `.github/scripts/`.

### 1. generate-changelog.sh

**Purpose**: Consolidates duplicated changelog generation logic from v2 and v3 workflows.

**Usage**:

```bash
./.github/scripts/generate-changelog.sh <version> <version-prefix> <path-filter> <output-file>
```

**Examples**:

```bash
# Generate v2 changelog
./.github/scripts/generate-changelog.sh 2.3.0 v2 v2/ changelog.md

# Generate v3 changelog
./.github/scripts/generate-changelog.sh 3.1.0 v3 v3/ changelog.md
```

**Features**:

- Extracts commits using conventional commit format
- Filters by directory path (`v2/` or `v3/`)
- Categorizes commits into sections (features, fixes, docs, etc.)
- Adds version-specific installation instructions
- Generates Keep a Changelog format with emoji headers

**Conventional Commit Types**:

- `feat:` → Features section
- `fix:` → Bug Fixes section
- `docs:` → Documentation section
- `deps:` → Dependencies section
- `perf:` → Performance section
- `refactor:` → Refactoring section
- `test:` → Tests section
- `chore:`, `ci:`, `style:` → Maintenance section

### 2. validate-versions.sh

**Purpose**: Validates version consistency across multiple files to prevent version drift.

**Usage**:

```bash
./.github/scripts/validate-versions.sh [--strict]
```

**Validations**:

- ✅ Git tags match `v2/cli/VERSION`
- ✅ Git tags match `v3/Cargo.toml` version
- ✅ Changelog entries exist for latest tags
- ✅ No cross-version commits (v2 changes in v3 range, etc.)

**Strict Mode**:
Use `--strict` for pre-release validation (treats warnings as errors):

```bash
./.github/scripts/validate-versions.sh --strict
```

### 3. generate-migration-guide.sh

**Purpose**: Generates migration guide drafts by extracting breaking changes from conventional commits.

**Usage**:

```bash
./.github/scripts/generate-migration-guide.sh <from-version> <to-version> <output-file>
```

**Example**:

```bash
# Generate v2 → v3 migration guide
./.github/scripts/generate-migration-guide.sh v2.2.1 v3.0.0 RELEASE_NOTES.v3.md
```

**Breaking Change Detection**:

- Commits with `!` indicator (e.g., `feat!:`, `fix!:`)
- Commits with `BREAKING CHANGE:` footer
- Commits with `BREAKING-CHANGE:` footer

**Output**:

- Auto-extracted breaking changes with commit hashes
- Migration checklist templates (extension authors, end users, DevOps)
- Placeholders for manual enrichment (code examples, troubleshooting)

**Note**: Migration guides require manual review and enrichment before publication.

---

## Release Workflows

### v2 Release Workflow

File: `.github/workflows/release-v2.yml`

**Trigger**: Tags matching `v2.*.*` (e.g., `v2.3.0`, `v2.3.1-beta.1`)

**Changelog Steps**:

1. Checkout repository with full history
2. Run `generate-changelog.sh 2.3.0 v2 v2/ changelog.md`
3. Update `v2/CHANGELOG.md` with new entry
4. Update `v2/cli/VERSION` file
5. Validate versions with `validate-versions.sh`
6. Commit changes to `main` branch

**Path Filtering**:

```bash
git log v2.2.0..v2.3.0 --oneline -- v2/
```

Only commits touching the `v2/` directory are included in v2 changelogs.

### v3 Release Workflow

File: `.github/workflows/release-v3.yml`

**Trigger**: Tags matching `v3.*.*` (e.g., `v3.0.0`, `v3.1.0-alpha.1`)

**Changelog Steps**:

1. Checkout repository with full history
2. Run `generate-changelog.sh 3.1.0 v3 v3/ changelog.md`
3. Update `v3/CHANGELOG.md` with new entry
4. Update `v3/Cargo.toml` version
5. Validate versions with `validate-versions.sh`
6. Commit changes to `main` branch

**Path Filtering**:

```bash
git log v3.0.0..v3.1.0 --oneline -- v3/
```

Only commits touching the `v3/` directory are included in v3 changelogs.

---

## Version Validation

### Validation Checks

The `validate-versions.sh` script runs during:

- **Pre-release**: Validates version consistency before building artifacts
- **CI/CD**: Can be added to PR checks (future enhancement)

### Version Sources

**v2 Version Sources**:

- Git tags: `v2.x.x`
- File: `v2/cli/VERSION`
- Changelog: `v2/CHANGELOG.md`

**v3 Version Sources**:

- Git tags: `v3.x.x`
- File: `v3/Cargo.toml` (`version = "x.x.x"`)
- Changelog: `v3/CHANGELOG.md`

### Common Issues

**Version Drift**:

```
❌ ERROR: v2 tag (2.3.0) != v2/cli/VERSION (2.2.1)
```

**Solution**: Update `v2/cli/VERSION` manually before tagging:

```bash
echo "2.3.0" > v2/cli/VERSION
git add v2/cli/VERSION
git commit -m "chore: bump v2 to 2.3.0"
git tag v2.3.0
git push origin main v2.3.0
```

**Cross-Version Commits**:

```
⚠️ WARNING: Found 3 v3/ changes in v2 release range (v2.2.0..v2.3.0)
```

This is usually harmless (e.g., CI changes affecting both), but indicates commits touching both versions.

---

## Migration Guides

### When to Create Migration Guides

Create migration guides for **major version upgrades**:

- v1 → v2: `RELEASE_NOTES.v2.md` (published)
- v2 → v3: `RELEASE_NOTES.v3.md` (to be published with v3.0.0)

### Migration Guide Workflow

1. **Auto-generate draft** using `generate-migration-guide.sh`
2. **Manual enrichment**:
   - Add before/after code examples
   - Write step-by-step migration instructions
   - Add troubleshooting sections
   - Include user persona checklists
3. **Community review** with early adopters
4. **Publish** with major release

### Quality Standards

See `RELEASE_NOTES.v2.md` (1190+ lines) for quality expectations:

- Detailed breaking change explanations
- Clear migration steps for different user personas
- Before/after code examples
- Troubleshooting guides
- Links to ADRs and documentation

---

## Best Practices

### Commit Message Conventions

Follow [Conventional Commits](https://www.conventionalcommits.org/):

```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

**Examples**:

```bash
# Feature (appears in Features section)
feat(v2): add new extension hook

# Bug fix (appears in Bug Fixes section)
fix(v3): resolve cargo build issue

# Breaking change (triggers migration guide extraction)
feat(v2)!: remove deprecated extension API

BREAKING CHANGE: The old extension.yaml format is no longer supported.
```

### Scoping by Version

**Recommended** (clear version targeting):

```bash
feat(v2): add Docker health check
fix(v3): update Rust dependencies
docs(v2): update README installation
```

**Avoid** (unclear version):

```bash
feat: add feature  # Which version?
```

### Release Checklist

Before creating a release tag:

- [ ] All PRs merged and tested
- [ ] Version files updated (VERSION or Cargo.toml)
- [ ] Breaking changes documented in commit messages
- [ ] Tests passing in CI
- [ ] Security scans clean
- [ ] No pending deprecation warnings

---

## Troubleshooting

### Changelog Generation Failures

**Problem**: Script fails to find previous tag

```
No previous v2 tag found, using all v2 commits
```

**Cause**: First release for this version prefix

**Solution**: Expected behavior for first release (e.g., v2.0.0)

---

**Problem**: Empty changelog sections

```
No features, fixes, or other changes found
```

**Cause**: No commits matching path filter (`v2/` or `v3/`)

**Solution**: Ensure commits touch the correct version directory

---

### Version Validation Errors

**Problem**: CHANGELOG missing version entry

```
⚠️ WARNING: v2 CHANGELOG.md missing entry for 2.3.0
```

**Cause**: Workflow failed to update CHANGELOG.md

**Solution**: Manually add entry or re-run workflow

---

**Problem**: Workflow can't commit changes

```
Error: Permission denied (push to main)
```

**Cause**: Missing `contents: write` permission

**Solution**: Verify workflow has `permissions.contents: write`

---

### Migration Guide Issues

**Problem**: No breaking changes detected

```
Found 0 breaking change(s)
```

**Cause**: Commits don't use `!` or `BREAKING CHANGE:` footer

**Solution**: Update commit messages or manually add breaking changes to guide

---

## References

- [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)
- [Semantic Versioning](https://semver.org/spec/v2.0.0.html)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Release Process](RELEASE.md)
- [Contributing Guide](CONTRIBUTING.md)

---

**Questions?** Open a [discussion](https://github.com/pacphi/sindri/discussions) or [issue](https://github.com/pacphi/sindri/issues).
