#!/usr/bin/env node
/**
 * FAQ Build Script
 *
 * Combines separate source files (HTML, JS, JSON) into a single
 * self-contained HTML file that works without a server.
 *
 * Usage: node build.mjs
 * Or via pnpm: pnpm build:faq
 */

import { readFileSync, writeFileSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));

// Paths
const SRC_DIR = join(__dirname, 'src');
const OUTPUT_FILE = join(__dirname, 'index.html');

const HTML_TEMPLATE = join(SRC_DIR, 'index.html');
const JS_FILE = join(SRC_DIR, 'faq.js');
const DATA_FILE = join(SRC_DIR, 'v2-faq-data.json');

console.log('Building FAQ page...');
console.log(`  Source: ${SRC_DIR}`);
console.log(`  Output: ${OUTPUT_FILE}`);

try {
  // Read source files
  const htmlTemplate = readFileSync(HTML_TEMPLATE, 'utf-8');
  let jsCode = readFileSync(JS_FILE, 'utf-8');
  const jsonData = readFileSync(DATA_FILE, 'utf-8');

  // Parse and re-stringify JSON to minimize whitespace
  const parsedData = JSON.parse(jsonData);
  const minifiedJson = JSON.stringify(parsedData);

  // Modify JS to use embedded data instead of fetch
  // Replace the loadFaqData function body
  jsCode = jsCode.replace(
    /async function loadFaqData\(\) \{[\s\S]*?^  \} catch/m,
    `async function loadFaqData() {
  // Use embedded data (no fetch needed - injected by build.mjs)
  if (window.FAQ_DATA) {
    state.faqData = window.FAQ_DATA;
    state.filteredQuestions = [...state.faqData.questions];
    renderCategoryFilters();
    renderFaqItems();
    hideLoading();
    return;
  }
  // Fallback to fetch for development
  try {
    const response = await fetch('faq-data.json');
    if (!response.ok) throw new Error('HTTP ' + response.status);
    state.faqData = await response.json();
    state.filteredQuestions = [...state.faqData.questions];
    renderCategoryFilters();
    renderFaqItems();
    hideLoading();
  } catch`
  );

  // Create the combined output using simple string concatenation
  // (avoiding .replace() which interprets $& as special patterns)

  // Find the position of the script tag in HTML
  const scriptTagPattern = '<script src="faq.js"></script>';
  const scriptTagIndex = htmlTemplate.indexOf(scriptTagPattern);

  if (scriptTagIndex === -1) {
    throw new Error('Could not find <script src="faq.js"></script> in template');
  }

  // Build output by concatenating parts
  const beforeScript = htmlTemplate.substring(0, scriptTagIndex);
  const afterScript = htmlTemplate.substring(scriptTagIndex + scriptTagPattern.length);

  const embeddedContent = `<script>
// Embedded FAQ Data (generated by build.mjs)
window.FAQ_DATA = ${minifiedJson};
</script>

<script>
${jsCode}
</script>`;

  let outputHtml = beforeScript + embeddedContent + afterScript;

  // Add build info comment at the top
  const buildInfo = `
<!--
  Sindri FAQ - Self-contained build
  Generated: ${new Date().toISOString()}
  Questions: ${parsedData.questions.length}
  Categories: ${parsedData.categories.length}

  This file is auto-generated. Edit source files in src/ directory.
  Rebuild with: pnpm build:faq
-->
`;

  outputHtml = outputHtml.replace('<!DOCTYPE html>', '<!DOCTYPE html>' + buildInfo);

  // Write output
  writeFileSync(OUTPUT_FILE, outputHtml, 'utf-8');

  // Stats
  const stats = {
    questions: parsedData.questions.length,
    categories: parsedData.categories.length,
    outputSize: (Buffer.byteLength(outputHtml, 'utf-8') / 1024).toFixed(1),
  };

  console.log('\nBuild complete!');
  console.log(`  Questions: ${stats.questions}`);
  console.log(`  Categories: ${stats.categories}`);
  console.log(`  Output size: ${stats.outputSize} KB`);
  console.log(`\nOpen in browser: file://${OUTPUT_FILE}`);

} catch (error) {
  console.error('\nBuild failed:', error.message);
  console.error(error.stack);
  process.exit(1);
}
