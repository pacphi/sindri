#!/bin/bash
#
# clone-project - Clone or fork repository with Claude enhancements
#
# Clones or forks an existing repository and applies Claude AI enhancements
# including Git hooks, dependency installation, CLAUDE.md creation, and
# Claude tool initialization.
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Determine lib directory (support both container and local paths)
if [[ -d "/docker/lib" ]]; then
    DOCKER_LIB="/docker/lib"
else
    DOCKER_LIB="$(cd "${SCRIPT_DIR}/../docker/lib" && pwd)"
fi
export DOCKER_LIB

source "${DOCKER_LIB}/common.sh"
source "${DOCKER_LIB}/git.sh"
source "${DOCKER_LIB}/project-core.sh"

REPO_URL=""
FORK_MODE=false
BRANCH_NAME=""
CLONE_DEPTH=""
GIT_NAME=""
GIT_EMAIL=""
FEATURE_BRANCH=""
SKIP_DEPS=false
SKIP_TOOLS=false
SKIP_ENHANCE=false
PROJECT_NAME=""

show_usage() {
    echo "Usage: $0 <repository-url> [options]"
    echo ""
    echo "Clone or fork a repository and enhance it with Claude tools"
    echo ""
    echo "Options:"
    echo "  --fork              Fork repo before cloning (requires gh CLI)"
    echo "  --branch <name>     Checkout specific branch after clone"
    echo "  --depth <n>         Shallow clone with n commits"
    echo "  --git-name <name>   Configure Git user name for this project"
    echo "  --git-email <email> Configure Git user email for this project"
    echo "  --feature <name>    Create and checkout feature branch after clone"
    echo "  --no-deps           Skip dependency installation"
    echo "  --skip-tools        Skip agentic tool initialization (claude-flow, aqe, etc.)"
    echo "  --no-enhance        Skip all enhancements (just clone/fork)"
    echo "  -h, --help          Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 https://github.com/user/my-app"
    echo "  $0 https://github.com/original/project --fork"
    echo "  $0 https://github.com/original/project --fork --feature add-new-feature"
    echo "  $0 https://github.com/company/app --git-name \"John Doe\""
    exit 1
}

if [ $# -eq 0 ]; then
    show_usage
fi

if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    show_usage
fi

REPO_URL="$1"
shift

if [[ ! "$REPO_URL" =~ ^(https?://|git@) ]]; then
    print_error "Invalid repository URL: $REPO_URL"
    exit 1
fi

PROJECT_NAME=$(basename "$REPO_URL" .git)
if [[ -z "$PROJECT_NAME" ]]; then
    print_error "Could not determine project name from URL"
    exit 1
fi

while [[ $# -gt 0 ]]; do
    case $1 in
        --fork)
            FORK_MODE=true
            shift
            ;;
        --branch)
            BRANCH_NAME="$2"
            shift 2
            ;;
        --depth)
            CLONE_DEPTH="$2"
            shift 2
            ;;
        --git-name)
            GIT_NAME="$2"
            shift 2
            ;;
        --git-email)
            GIT_EMAIL="$2"
            shift 2
            ;;
        --feature)
            FEATURE_BRANCH="$2"
            shift 2
            ;;
        --no-deps)
            SKIP_DEPS=true
            shift
            ;;
        --skip-tools)
            SKIP_TOOLS=true
            shift
            ;;
        --no-enhance)
            SKIP_ENHANCE=true
            shift
            ;;
        -h|--help)
            show_usage
            ;;
        *)
            print_error "Unknown option: $1"
            show_usage
            ;;
    esac
done

# Use WORKSPACE_PROJECTS if available, otherwise use local projects dir
PROJECTS_BASE="${WORKSPACE_PROJECTS:-${HOME}/projects}"
PROJECT_DIR="$PROJECTS_BASE/$PROJECT_NAME"

if [ -d "$PROJECT_DIR" ]; then
    print_error "Project $PROJECT_NAME already exists at $PROJECT_DIR"
    exit 1
fi

if [[ "$FORK_MODE" == true ]]; then
    if ! command_exists gh; then
        print_error "GitHub CLI (gh) is required for forking. Please install it first."
        exit 1
    fi

    if ! gh auth status >/dev/null 2>&1; then
        print_error "GitHub CLI is not authenticated. Please run: gh auth login"
        exit 1
    fi

    print_status "Forking repository: $REPO_URL"

    cd "$PROJECTS_BASE" || exit 1
    if ! gh repo fork "$REPO_URL" --clone; then
        print_error "Failed to fork repository"
        exit 1
    fi

    cd "$PROJECT_NAME" || exit 1

    if [[ "$SKIP_ENHANCE" != true ]]; then
        print_status "Setting up fork remotes and aliases..."
        setup_fork_remotes
        setup_fork_aliases
    fi
else
    print_status "Cloning repository: $REPO_URL"

    CLONE_CMD="git clone"
    if [[ -n "$CLONE_DEPTH" ]]; then
        CLONE_CMD="$CLONE_CMD --depth $CLONE_DEPTH"
    fi
    if [[ -n "$BRANCH_NAME" ]]; then
        CLONE_CMD="$CLONE_CMD --branch $BRANCH_NAME"
    fi
    CLONE_CMD="$CLONE_CMD \"$REPO_URL\" \"$PROJECT_DIR\""

    if ! eval "$CLONE_CMD"; then
        print_error "Failed to clone repository"
        exit 1
    fi

    cd "$PROJECT_DIR" || exit 1
fi

if [[ -n "$BRANCH_NAME" ]] && [[ "$FORK_MODE" == true ]]; then
    print_status "Checking out branch: $BRANCH_NAME"
    git checkout "$BRANCH_NAME" 2>/dev/null || {
        print_warning "Branch $BRANCH_NAME not found locally, trying to fetch from upstream"
        git fetch upstream "$BRANCH_NAME" 2>/dev/null && git checkout -b "$BRANCH_NAME" "upstream/$BRANCH_NAME"
    } || {
        print_error "Could not checkout branch: $BRANCH_NAME"
    }
fi

if [[ -n "$GIT_NAME" ]] || [[ -n "$GIT_EMAIL" ]]; then
    apply_git_config_overrides ${GIT_NAME:+--name "$GIT_NAME"} ${GIT_EMAIL:+--email "$GIT_EMAIL"} || exit 1
fi

if [[ "$SKIP_ENHANCE" != true ]]; then
    print_status "Applying Claude enhancements..."

    setup_git_hooks "$PROJECT_DIR"

    create_project_claude_md --from-cli || exit 1

    setup_project_enhancements \
        $([[ "$SKIP_DEPS" == "true" ]] && echo "--skip-deps") \
        $([[ "$SKIP_TOOLS" == "true" ]] && echo "--skip-tools") \
        ${GIT_NAME:+--git-name "$GIT_NAME"} \
        ${GIT_EMAIL:+--git-email "$GIT_EMAIL"} || exit 1
fi

if [[ -n "$FEATURE_BRANCH" ]]; then
    print_status "Creating feature branch: $FEATURE_BRANCH"
    git checkout -b "$FEATURE_BRANCH"
    print_success "Switched to new branch: $FEATURE_BRANCH"
fi

print_success "Project $PROJECT_NAME cloned successfully"
echo "üìÅ Location: $PROJECT_DIR"
echo "üìù Next steps:"
echo "   1. cd $PROJECT_DIR"
if [[ ! -f "CLAUDE.md" ]] || [[ "$SKIP_ENHANCE" == true ]]; then
    echo "   2. Run 'claude /init' to set up project context"
fi
echo "   3. Start coding with: claude"

echo ""
echo "Initialized Tools:"
(
    cd "$PROJECT_DIR" || exit 1

    # Non-extension tools (keep as-is)
    if command_exists claude; then echo "  ‚úì Claude Code"; fi
    if command_exists uvx && [[ -f ".github/spec.json" ]]; then echo "  ‚úì GitHub spec-kit"; fi

    # Extension-based tools (dynamic capability reporting)
    if [[ -f "${SCRIPT_DIR}/../docker/lib/capability-manager.sh" ]]; then
        source "${SCRIPT_DIR}/../docker/lib/capability-manager.sh"
        report_initialized_extensions
    fi
)

echo ""
echo "Git Configuration:"
echo "   User: $(git config user.name) <$(git config user.email)>"
echo "   Branch: $(git branch --show-current)"
if [[ "$FORK_MODE" == true ]]; then
    echo "   Origin: $(git remote get-url origin 2>/dev/null || echo 'not set')"
    echo "   Upstream: $(git remote get-url upstream 2>/dev/null || echo 'not set')"
fi
