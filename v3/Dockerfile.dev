# syntax=docker/dockerfile:1.4
# ==============================================================================
# Sindri v3 Dockerfile.dev - Development Builds (Local Source)
# ==============================================================================
# Multi-stage build for development iteration with bundled extensions.
#
# IMPORTANT: This Dockerfile uses COPY to build from local files.
# It does NOT clone from GitHub - it builds whatever is in your working directory.
#
# Two usage contexts:
#
#   1. LOCAL DEVELOPMENT (Path A - Makefile):
#      The Makefile runs: docker build -f v3/Dockerfile.dev -t sindri:latest .
#      This copies YOUR LOCAL working directory files into the build.
#      No git push required. Test uncommitted changes instantly.
#
#   2. FROM-SOURCE BUILDS (Path B - CLI):
#      When using `sindri deploy --from-source`, the CLI first clones the
#      repository from GitHub, then runs this Dockerfile against the clone.
#      The COPY commands pull from the cloned repo, not your local machine.
#      Requires git push first.
#
# See v3/docs/MAINTAINER_GUIDE.md for the full "Two Development Paths" guide.
#
# ------------------------------------------------------------------------------
# Build Performance (with base image):
# ------------------------------------------------------------------------------
# - First build: 3-5 minutes
# - Incremental builds: 1-2 minutes (code changes only)
# - Clean rebuild: 3-5 minutes (dependencies cached)
#
# ------------------------------------------------------------------------------
# Base Image:
# ------------------------------------------------------------------------------
# Uses pre-built base image (ghcr.io/pacphi/sindri:base-latest) containing:
# - Rust 1.93 toolchain
# - cargo-chef for dependency caching
# - System packages (Ubuntu 24.04)
# - GitHub CLI
#
# ------------------------------------------------------------------------------
# Quick Commands:
# ------------------------------------------------------------------------------
#   make v3-docker-build-fast           # Build image from local files
#   make v3-cycle-fast CONFIG=sindri.yaml  # Full local dev cycle
#
# ------------------------------------------------------------------------------
# Key Optimizations:
# ------------------------------------------------------------------------------
# - Base image separates slow-changing layers (rebuilt quarterly)
# - cargo-chef caches dependencies (rebuilt only when Cargo.toml changes)
# - BuildKit cache mounts for cargo registry/git
# - Incremental compilation for application code
# - Extensions bundled for offline/air-gapped deployments
# ==============================================================================

# ------------------------------------------------------------------------------
# Build Arguments
# ------------------------------------------------------------------------------
ARG BASE_IMAGE=ghcr.io/pacphi/sindri:base-latest

# ==============================================================================
# Stage 1: Prepare Recipe (cargo-chef)
# ==============================================================================
FROM rust:1.93-slim-bookworm AS chef

RUN cargo install cargo-chef --locked

WORKDIR /app

# Copy local source for recipe preparation (uses local files, not git clone)
COPY v3/Cargo.toml v3/Cargo.lock ./
COPY v3/crates/ ./crates/

RUN cargo chef prepare --recipe-path recipe.json

# ==============================================================================
# Stage 2: Build Dependencies (cached - only rebuilds when Cargo.toml changes)
# ==============================================================================
FROM rust:1.93-slim-bookworm AS builder-deps

RUN cargo install cargo-chef --locked

# Install build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        pkg-config \
        libssl-dev \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY --from=chef /app/recipe.json recipe.json

# Build dependencies with cache mounts (FAST incremental builds)
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo chef cook --release --recipe-path recipe.json

# ==============================================================================
# Stage 3: Build Application (FAST - only rebuilds when source changes)
# ==============================================================================
FROM rust:1.93-slim-bookworm AS builder

ARG TARGETARCH

# Install build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        pkg-config \
        libssl-dev \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy compiled dependencies from builder-deps (CACHED unless Cargo.toml changes)
COPY --from=builder-deps /app/target target
COPY --from=builder-deps /usr/local/cargo /usr/local/cargo

# Copy local source for building (uses local files, not git clone)
COPY v3/Cargo.toml v3/Cargo.lock ./
COPY v3/crates/ ./crates/
COPY v3/embedded/ ./embedded/
COPY v3/schemas/ ./schemas/
COPY v3/profiles.yaml ./profiles.yaml

# Build application (only source code recompiled)
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    echo "Building sindri from source for ${TARGETARCH}..." && \
    cargo build --release --bin sindri && \
    mkdir -p /output && \
    cp target/release/sindri /output/sindri && \
    chmod +x /output/sindri

# ==============================================================================
# Stage 4: Runtime Image (inherits from base)
# ==============================================================================
FROM ${BASE_IMAGE}

# ------------------------------------------------------------------------------
# Runtime environment already set by base image
# ------------------------------------------------------------------------------
# Inherited from base:
# - Ubuntu 24.04 with system packages
# - Developer user and workspace directories
# - GitHub CLI
# - SSH server configuration structure

# ------------------------------------------------------------------------------
# Install mise, fonts, starship (changes occasionally)
# ------------------------------------------------------------------------------
COPY v3/docker/scripts/setup-ssh-environment.sh \
     v3/docker/scripts/install-mise.sh \
     v3/docker/scripts/install-nerd-fonts.sh \
     v3/docker/scripts/install-starship.sh \
     v3/docker/scripts/setup-motd.sh \
     v3/docker/scripts/check-extension-status.sh \
     v3/docker/scripts/show-motd.sh \
     /tmp/scripts/

RUN <<EOF
bash /tmp/scripts/setup-ssh-environment.sh
bash /tmp/scripts/install-mise.sh
bash /tmp/scripts/install-nerd-fonts.sh
bash /tmp/scripts/install-starship.sh
bash /tmp/scripts/setup-motd.sh
mkdir -p /etc/profile.d
cp /tmp/scripts/show-motd.sh /etc/profile.d/00-show-motd.sh
chmod +x /etc/profile.d/00-show-motd.sh
cp /tmp/scripts/check-extension-status.sh /etc/profile.d/sindri-extension-status.sh
chmod +x /etc/profile.d/sindri-extension-status.sh
rm -rf /tmp/scripts
EOF

# ------------------------------------------------------------------------------
# Setup SSH and Configuration (changes occasionally)
# ------------------------------------------------------------------------------
COPY v3/docker/config/sshd_config /etc/ssh/sshd_config
COPY v3/docker/config/developer-sudoers /etc/sudoers.d/developer

RUN mkdir -p /run/sshd /etc/ssh/sshd_config.d && \
    chmod 0440 /etc/sudoers.d/developer && \
    chmod 644 /etc/ssh/sshd_config

# ------------------------------------------------------------------------------
# Copy Sindri CLI Binary (FAST - changes frequently during development)
# ------------------------------------------------------------------------------
COPY --from=builder /output/sindri /usr/local/bin/sindri
RUN sindri --version

# ------------------------------------------------------------------------------
# Bundle Extensions (FAST - changes frequently during development)
# ------------------------------------------------------------------------------
RUN mkdir -p /opt/sindri

COPY --chown=${DEVELOPER_USER}:${DEVELOPER_USER} v3/extensions/ /opt/sindri/extensions/
COPY --chown=${DEVELOPER_USER}:${DEVELOPER_USER} v3/registry.yaml /opt/sindri/registry.yaml
COPY --chown=${DEVELOPER_USER}:${DEVELOPER_USER} v3/profiles.yaml /opt/sindri/profiles.yaml
COPY --chown=${DEVELOPER_USER}:${DEVELOPER_USER} v3/compatibility-matrix.yaml /opt/sindri/compatibility-matrix.yaml
COPY --chown=${DEVELOPER_USER}:${DEVELOPER_USER} v3/extension-source.yaml /opt/sindri/extension-source.yaml
COPY --chown=${DEVELOPER_USER}:${DEVELOPER_USER} v3/common.sh /opt/sindri/common.sh

ENV SINDRI_EXT_HOME=/opt/sindri/extensions

# ------------------------------------------------------------------------------
# Copy Entrypoint and Support Scripts (changes occasionally)
# ------------------------------------------------------------------------------
COPY v3/docker/scripts/entrypoint.sh /docker/scripts/
COPY v3/docker/scripts/healthcheck.sh /docker/scripts/

RUN chmod +x /docker/scripts/entrypoint.sh /docker/scripts/healthcheck.sh

# ------------------------------------------------------------------------------
# Runtime Configuration
# ------------------------------------------------------------------------------
WORKDIR ${WORKSPACE}
EXPOSE ${SSH_PORT}

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /docker/scripts/healthcheck.sh > /dev/null 2>&1 || exit 1

ENTRYPOINT ["/docker/scripts/entrypoint.sh"]

# ==============================================================================
# Development Workflow:
# ==============================================================================
# 1. Build base once (or when Rust/deps change):
#      make v3-docker-build-base
#
# 2. Fast incremental builds (CLI/extensions changed):
#      make v3-docker-build-fast
#
# 3. Full rebuild (when you need to):
#      make v3-docker-build-from-source
#
# Build times:
# - Base image: 15-20 min (build once, reuse for weeks/months)
# - Fast build (incremental): 1-2 min
# - Fast build (clean): 3-5 min
# - Full rebuild: 40-50 min
# ==============================================================================
