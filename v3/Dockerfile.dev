# ==============================================================================
# Sindri v3 Dockerfile.dev (Development)
# ==============================================================================
# Multi-stage build for Sindri v3 with source compilation and bundled extensions
#
# Build mode:
#   - Builds from source using cargo build --release (~8 min build)
#   - Bundles extensions, registry, profiles at /opt/sindri/
#   - Larger image (~1.2GB vs production's ~800MB)
#   - Useful for development, testing, and air-gapped deployments
#
# Key differences from Dockerfile (production):
#   - Builds from source (not pre-compiled binary)
#   - Bundled extensions at /opt/sindri/extensions
#   - Longer builds (~8 min vs production's 2-5 min)
#   - Larger image size (~1.2GB vs production's ~800MB)
#   - Extensions available immediately without installation
# ==============================================================================

# ------------------------------------------------------------------------------
# Build Arguments
# ------------------------------------------------------------------------------
ARG UBUNTU_VERSION=24.04
ARG RUST_VERSION=1.92
ARG SINDRI_VERSION=3.0.0
ARG SINDRI_REPO=https://github.com/pacphi/sindri

# ==============================================================================
# Stage 1: Build from Source
# ==============================================================================
FROM rust:${RUST_VERSION}-slim-bookworm AS builder

ARG SINDRI_VERSION
ARG SINDRI_REPO
ARG TARGETARCH

# Install build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git \
        pkg-config \
        libssl-dev \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Clone repository and build
RUN echo "Building sindri from source for ${TARGETARCH}..." && \
    git clone --depth 1 --branch "${SINDRI_VERSION}" "${SINDRI_REPO}" /tmp/sindri && \
    cd /tmp/sindri/v3 && \
    cargo build --release --bin sindri && \
    mkdir -p /output && \
    cp target/release/sindri /output/sindri && \
    chmod +x /output/sindri

# ==============================================================================
# Stage 2: Runtime Image
# ==============================================================================
FROM ubuntu:${UBUNTU_VERSION}

# ------------------------------------------------------------------------------
# Runtime Build Arguments
# ------------------------------------------------------------------------------
ARG DEBIAN_FRONTEND=noninteractive
ARG DEVELOPER_USER=developer
ARG DEVELOPER_UID=1001
ARG DEVELOPER_GID=1001
ARG ALT_HOME=/alt/home/developer
ARG WORKSPACE=${ALT_HOME}/workspace
ARG SSH_PORT=2222

# Set environment variables
ENV DEVELOPER_USER=${DEVELOPER_USER} \
    ALT_HOME=${ALT_HOME} \
    WORKSPACE=${WORKSPACE} \
    SSH_PORT=${SSH_PORT} \
    DEBIAN_FRONTEND=noninteractive \
    TERM=xterm-256color \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# ------------------------------------------------------------------------------
# Install System Packages
# ------------------------------------------------------------------------------
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        # Core utilities
        ca-certificates \
        curl \
        wget \
        git \
        openssh-server \
        sudo \
        locales \
        tzdata \
        fontconfig \
        unzip \
        # Build tools (for native extensions)
        build-essential \
        pkg-config \
        libssl-dev && \
    # Configure locales
    locale-gen en_US.UTF-8 && \
    update-locale LANG=en_US.UTF-8 && \
    # Cleanup apt cache and remove SSH host keys generated during installation
    # SSH keys will be generated at runtime by entrypoint.sh for security
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    rm -f /etc/ssh/ssh_host_*

# ------------------------------------------------------------------------------
# Copy Sindri CLI Binary
# ------------------------------------------------------------------------------
COPY --from=builder /output/sindri /usr/local/bin/sindri

# Verify binary is executable and functional
RUN sindri --version

# ------------------------------------------------------------------------------
# Bundle Extensions (Development Mode)
# ------------------------------------------------------------------------------
# In development mode, extensions ARE bundled with the image at /opt/sindri/
# This provides immediate availability without installation and supports
# air-gapped deployments.
#
# Extensions are copied from the build context (repository) and include:
# - extension definitions (extensions/)
# - registry metadata (registry.yaml)
# - profile configurations (profiles.yaml)
# - common utilities (common.sh)
# ------------------------------------------------------------------------------
RUN mkdir -p /opt/sindri

# Copy extensions and configuration from build context
COPY --chown=${DEVELOPER_USER}:${DEVELOPER_USER} v3/extensions/ /opt/sindri/extensions/
COPY --chown=${DEVELOPER_USER}:${DEVELOPER_USER} v3/registry.yaml /opt/sindri/registry.yaml
COPY --chown=${DEVELOPER_USER}:${DEVELOPER_USER} v3/profiles.yaml /opt/sindri/profiles.yaml
COPY --chown=${DEVELOPER_USER}:${DEVELOPER_USER} v3/common.sh /opt/sindri/common.sh

# Set SINDRI_EXT_HOME to point to bundled extensions
ENV SINDRI_EXT_HOME=/opt/sindri/extensions

# ------------------------------------------------------------------------------
# Install GitHub CLI from official releases (avoids CVE vulnerabilities)
# ------------------------------------------------------------------------------
ARG GH_VERSION=2.86.0
RUN ARCH=$(dpkg --print-architecture) && \
    wget -qO /tmp/gh.tar.gz "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_${ARCH}.tar.gz" && \
    tar -xzf /tmp/gh.tar.gz -C /tmp && \
    mv /tmp/gh_${GH_VERSION}_linux_${ARCH}/bin/gh /usr/local/bin/ && \
    rm -rf /tmp/gh.tar.gz /tmp/gh_${GH_VERSION}_linux_${ARCH} && \
    gh --version

# ------------------------------------------------------------------------------
# Create Developer User
# ------------------------------------------------------------------------------
RUN groupadd -g ${DEVELOPER_GID} ${DEVELOPER_USER} && \
    useradd -m -u ${DEVELOPER_UID} -g ${DEVELOPER_GID} -s /bin/bash ${DEVELOPER_USER} && \
    echo "${DEVELOPER_USER} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${DEVELOPER_USER} && \
    chmod 0440 /etc/sudoers.d/${DEVELOPER_USER}

# ------------------------------------------------------------------------------
# Setup SSH Server
# ------------------------------------------------------------------------------
RUN mkdir -p /run/sshd && \
    mkdir -p /etc/ssh/sshd_config.d

# Copy SSH configuration
COPY v3/docker/config/sshd_config /etc/ssh/sshd_config
COPY v3/docker/config/developer-sudoers /etc/sudoers.d/${DEVELOPER_USER}

RUN chmod 0440 /etc/sudoers.d/${DEVELOPER_USER} && \
    chmod 644 /etc/ssh/sshd_config

# Configure SSH environment for login shells (TMPDIR for Claude Code plugins)
COPY v3/docker/scripts/setup-ssh-environment.sh /tmp/
RUN bash /tmp/setup-ssh-environment.sh && rm /tmp/setup-ssh-environment.sh

# ------------------------------------------------------------------------------
# Install mise (Tool Version Manager)
# ------------------------------------------------------------------------------
# mise is critical for managing language runtimes installed via extensions
# (node, python, ruby, go, etc.)
COPY v3/docker/scripts/install-mise.sh /tmp/
RUN bash /tmp/install-mise.sh && rm /tmp/install-mise.sh

# ------------------------------------------------------------------------------
# Install Nerd Fonts (for Starship icons/symbols)
# ------------------------------------------------------------------------------
COPY v3/docker/scripts/install-nerd-fonts.sh /tmp/
RUN bash /tmp/install-nerd-fonts.sh && rm /tmp/install-nerd-fonts.sh

# ------------------------------------------------------------------------------
# Install Starship (Optional Shell Prompt)
# ------------------------------------------------------------------------------
COPY v3/docker/scripts/install-starship.sh /tmp/
RUN bash /tmp/install-starship.sh && rm /tmp/install-starship.sh

# ------------------------------------------------------------------------------
# Setup Directories and Permissions
# ------------------------------------------------------------------------------
RUN mkdir -p /docker/scripts /docker/config && \
    mkdir -p ${ALT_HOME} ${WORKSPACE} && \
    chown -R ${DEVELOPER_USER}:${DEVELOPER_USER} ${ALT_HOME} && \
    chmod 755 /docker /docker/scripts /docker/config

# ------------------------------------------------------------------------------
# Copy Entrypoint and Support Scripts
# ------------------------------------------------------------------------------
COPY v3/docker/scripts/entrypoint.sh /docker/scripts/
COPY v3/docker/scripts/healthcheck.sh /docker/scripts/
COPY v3/docker/scripts/setup-motd.sh /tmp/
COPY v3/docker/scripts/check-extension-status.sh /tmp/
COPY v3/docker/scripts/show-motd.sh /tmp/

RUN chmod +x /docker/scripts/entrypoint.sh && \
    chmod +x /docker/scripts/healthcheck.sh && \
    bash /tmp/setup-motd.sh && \
    rm /tmp/setup-motd.sh && \
    # Install login shell scripts
    mkdir -p /etc/profile.d && \
    cp /tmp/show-motd.sh /etc/profile.d/00-show-motd.sh && \
    chmod +x /etc/profile.d/00-show-motd.sh && \
    cp /tmp/check-extension-status.sh /etc/profile.d/sindri-extension-status.sh && \
    chmod +x /etc/profile.d/sindri-extension-status.sh && \
    rm /tmp/show-motd.sh /tmp/check-extension-status.sh

# ------------------------------------------------------------------------------
# Runtime Configuration
# ------------------------------------------------------------------------------
WORKDIR ${WORKSPACE}
EXPOSE ${SSH_PORT}

# Comprehensive health check
# - Checks SSH daemon
# - Checks extension installation status
# - Checks critical directories
# - Checks Sindri CLI functionality
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /docker/scripts/healthcheck.sh > /dev/null 2>&1 || exit 1

# Run entrypoint as root (it will start SSH daemon and manage permissions)
ENTRYPOINT ["/docker/scripts/entrypoint.sh"]
