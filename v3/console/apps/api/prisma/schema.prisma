// Prisma schema for Sindri Console
// PostgreSQL primary database for instance registry, observability, and administration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────────────────────
// Enumerations
// ─────────────────────────────────────────────────────────────────────────────

enum InstanceStatus {
  RUNNING
  STOPPED
  DEPLOYING
  DESTROYING
  SUSPENDED
  ERROR
  UNKNOWN
}

enum UserRole {
  ADMIN
  OPERATOR
  DEVELOPER
  VIEWER
}

enum TerminalSessionStatus {
  ACTIVE
  CLOSED
  DISCONNECTED
}

enum EventType {
  DEPLOY
  REDEPLOY
  CONNECT
  DISCONNECT
  BACKUP
  RESTORE
  DESTROY
  SUSPEND
  RESUME
  EXTENSION_INSTALL
  EXTENSION_REMOVE
  HEARTBEAT_LOST
  HEARTBEAT_RECOVERED
  ERROR
}

enum DeploymentStatus {
  PENDING
  IN_PROGRESS
  SUCCEEDED
  FAILED
  CANCELLED
}

enum ScheduledTaskStatus {
  ACTIVE
  PAUSED
  DISABLED
}

enum TaskExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  SKIPPED
  TIMED_OUT
}

// ─────────────────────────────────────────────────────────────────────────────
// Core Models
// ─────────────────────────────────────────────────────────────────────────────

/// Represents a deployed Sindri environment instance across any provider.
model Instance {
  id           String         @id @default(cuid())
  name         String         @unique
  provider     String         // fly, docker, devpod, e2b, kubernetes
  region       String?        // e.g. sea, iad, us-east-1
  extensions   String[]       // List of installed extension names
  config_hash  String?        // SHA256 of sindri.yaml at deploy time
  ssh_endpoint String?        // SSH connection string (host:port)
  status       InstanceStatus @default(UNKNOWN)
  created_at   DateTime       @default(now())
  updated_at   DateTime       @updatedAt

  // Relations
  heartbeats         Heartbeat[]
  events             Event[]
  terminal_sessions  TerminalSession[]
  command_executions CommandExecution[]
  deployments        Deployment[]

  @@index([status])
  @@index([provider])
  @@index([created_at])
}

/// Periodic health/metrics ping from a running Sindri instance agent.
model Heartbeat {
  id           String   @id @default(cuid())
  instance_id  String
  timestamp    DateTime @default(now())
  cpu_percent  Float    // 0–100
  memory_used  BigInt   // bytes
  memory_total BigInt   // bytes
  disk_used    BigInt   // bytes
  disk_total   BigInt   // bytes
  uptime       BigInt   // seconds

  // Relations
  instance Instance @relation(fields: [instance_id], references: [id], onDelete: Cascade)

  @@index([instance_id])
  @@index([timestamp])
  @@index([instance_id, timestamp])
}

/// Lifecycle and operational events emitted by instances or the Console.
model Event {
  id          String    @id @default(cuid())
  instance_id String
  event_type  EventType
  timestamp   DateTime  @default(now())
  metadata    Json?     // Arbitrary structured payload per event type

  // Relations
  instance Instance @relation(fields: [instance_id], references: [id], onDelete: Cascade)

  @@index([instance_id])
  @@index([event_type])
  @@index([timestamp])
  @@index([instance_id, timestamp])
}

// ─────────────────────────────────────────────────────────────────────────────
// User & Access Management
// ─────────────────────────────────────────────────────────────────────────────

/// Console user accounts with RBAC role assignment.
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password_hash String   // bcrypt hash; null if SSO-only
  role          UserRole @default(DEVELOPER)
  created_at    DateTime @default(now())

  // Relations
  api_keys           ApiKey[]
  terminal_sessions  TerminalSession[]
  command_executions CommandExecution[]

  @@index([email])
  @@index([role])
}

/// API keys for CI/CD and programmatic access to the Console API.
model ApiKey {
  id         String    @id @default(cuid())
  user_id    String
  key_hash   String    @unique // SHA256 of the raw key; raw key shown once at creation
  name       String            // Human-readable label
  created_at DateTime  @default(now())
  expires_at DateTime?         // Null means non-expiring

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([key_hash])
  @@index([expires_at])
}

// ─────────────────────────────────────────────────────────────────────────────
// Terminal Sessions
// ─────────────────────────────────────────────────────────────────────────────

// ─────────────────────────────────────────────────────────────────────────────
// Scheduled Tasks
// ─────────────────────────────────────────────────────────────────────────────

/// A scheduled cron task that executes commands on Sindri instances.
model ScheduledTask {
  id            String              @id @default(cuid())
  name          String
  description   String?
  cron          String              // cron expression e.g. "0 2 * * *"
  timezone      String              @default("UTC")
  command       String              // command to execute
  instance_id   String?             // target instance (null = all)
  status        ScheduledTaskStatus @default(ACTIVE)
  template      String?             // template key if from gallery
  timeout_sec   Int                 @default(300)
  max_retries   Int                 @default(0)
  notify_on_failure Boolean         @default(false)
  notify_on_success Boolean         @default(false)
  notify_emails   String[]          @default([])
  last_run_at     DateTime?
  next_run_at     DateTime?
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  created_by      String?           // user id

  executions      TaskExecution[]

  @@index([status])
  @@index([instance_id])
  @@index([next_run_at])
  @@index([created_at])
}

/// An individual execution record for a scheduled task.
model TaskExecution {
  id          String              @id @default(cuid())
  task_id     String
  instance_id String?
  status      TaskExecutionStatus @default(PENDING)
  exit_code   Int?
  stdout      String?
  stderr      String?
  started_at  DateTime            @default(now())
  finished_at DateTime?
  duration_ms Int?
  triggered_by String?            // "scheduler" | "manual"

  task ScheduledTask @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@index([task_id])
  @@index([status])
  @@index([started_at])
  @@index([task_id, started_at])
}

/// A command execution record — dispatched via the Console to one instance.
model CommandExecution {
  id             String   @id @default(cuid())
  instance_id    String
  user_id        String
  command        String
  args           String[] @default([])
  env            Json     @default("{}")
  working_dir    String?
  timeout_ms     Int      @default(30000)
  status         String   @default("RUNNING") // PENDING | RUNNING | SUCCEEDED | FAILED | TIMEOUT
  exit_code      Int?
  stdout         String?
  stderr         String?
  duration_ms    Int?
  correlation_id String   @unique
  script_content String?  // populated for script executions
  created_at     DateTime @default(now())
  completed_at   DateTime?

  instance Instance @relation(fields: [instance_id], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([instance_id])
  @@index([user_id])
  @@index([status])
  @@index([created_at])
  @@index([instance_id, created_at])
  @@index([correlation_id])
}

// ─────────────────────────────────────────────────────────────────────────────
// Deployment Templates & Deployments
// ─────────────────────────────────────────────────────────────────────────────

/// A reusable sindri.yaml template shown in the deployment wizard.
model DeploymentTemplate {
  id                       String   @id @default(cuid())
  name                     String
  slug                     String   @unique // URL-safe identifier, e.g. "python-ml"
  category                 String   // e.g. "language", "ai", "infrastructure"
  description              String
  yaml_content             String   // Full sindri.yaml content
  extensions               String[] // Derived list of extension names from yaml_content
  provider_recommendations String[] // Suggested providers e.g. ["fly", "docker"]
  is_official              Boolean  @default(false) // Curated by the Sindri team
  created_by               String?  // user_id of uploader; null = built-in template
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  deployments Deployment[]

  @@index([category])
  @@index([is_official])
  @@index([created_at])
}

/// A deployment run — tracks the full lifecycle of one sindri deploy operation.
model Deployment {
  id           String           @id @default(cuid())
  instance_id  String?          // null before the instance is registered
  template_id  String?          // source template, if any
  config_hash  String           // SHA256 of the sindri.yaml used
  yaml_content String           // Snapshot of sindri.yaml at deploy time
  provider     String           // Target provider
  region       String?          // Target region
  status       DeploymentStatus @default(PENDING)
  initiated_by String?          // user_id
  started_at   DateTime         @default(now())
  completed_at DateTime?
  logs         String?          // Captured deploy output
  error        String?          // Error message on failure

  instance Instance?           @relation(fields: [instance_id], references: [id], onDelete: SetNull)
  template DeploymentTemplate? @relation(fields: [template_id], references: [id], onDelete: SetNull)

  @@index([instance_id])
  @@index([template_id])
  @@index([status])
  @@index([started_at])
  @@index([initiated_by])
}

/// Web terminal sessions opened from the Console to a Sindri instance.
model TerminalSession {
  id          String                @id @default(cuid())
  instance_id String
  user_id     String
  started_at  DateTime              @default(now())
  ended_at    DateTime?
  status      TerminalSessionStatus @default(ACTIVE)

  // Relations
  instance Instance @relation(fields: [instance_id], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([instance_id])
  @@index([user_id])
  @@index([status])
  @@index([started_at])
  @@index([instance_id, user_id])
}
