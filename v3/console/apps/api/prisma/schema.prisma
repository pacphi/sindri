// Prisma schema for Sindri Console
// PostgreSQL primary database for instance registry, observability, and administration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────────────────────
// Enumerations
// ─────────────────────────────────────────────────────────────────────────────

enum InstanceStatus {
  RUNNING
  STOPPED
  DEPLOYING
  DESTROYING
  SUSPENDED
  ERROR
  UNKNOWN
}

enum UserRole {
  ADMIN
  OPERATOR
  DEVELOPER
  VIEWER
}

enum TerminalSessionStatus {
  ACTIVE
  CLOSED
  DISCONNECTED
}

enum EventType {
  DEPLOY
  REDEPLOY
  CONNECT
  DISCONNECT
  BACKUP
  RESTORE
  DESTROY
  SUSPEND
  RESUME
  EXTENSION_INSTALL
  EXTENSION_REMOVE
  HEARTBEAT_LOST
  HEARTBEAT_RECOVERED
  ERROR
}

enum DeploymentStatus {
  PENDING
  IN_PROGRESS
  SUCCEEDED
  FAILED
  CANCELLED
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}

enum LogSource {
  AGENT
  EXTENSION
  BUILD
  APP
  SYSTEM
}

enum AlertRuleType {
  THRESHOLD
  ANOMALY
  LIFECYCLE
  SECURITY
  COST
}

enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  SILENCED
}

enum NotificationChannelType {
  WEBHOOK
  SLACK
  EMAIL
  IN_APP
}

enum ScheduledTaskStatus {
  ACTIVE
  PAUSED
  DISABLED
}

enum TaskExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  SKIPPED
  TIMED_OUT
}

// ─────────────────────────────────────────────────────────────────────────────
// Core Models
// ─────────────────────────────────────────────────────────────────────────────

/// Represents a deployed Sindri environment instance across any provider.
model Instance {
  id           String         @id @default(cuid())
  name         String         @unique
  provider     String         // fly, docker, devpod, e2b, kubernetes
  region       String?        // e.g. sea, iad, us-east-1
  extensions   String[]       // List of installed extension names
  config_hash  String?        // SHA256 of sindri.yaml at deploy time
  ssh_endpoint String?        // SSH connection string (host:port)
  status       InstanceStatus @default(UNKNOWN)
  created_at   DateTime       @default(now())
  updated_at   DateTime       @updatedAt

  // Relations
  heartbeats         Heartbeat[]
  metrics            Metric[]
  events             Event[]
  logs               Log[]
  terminal_sessions  TerminalSession[]
  command_executions CommandExecution[]
  deployments        Deployment[]

  @@index([status])
  @@index([provider])
  @@index([created_at])
}

/// Periodic health/metrics ping from a running Sindri instance agent.
model Heartbeat {
  id           String   @id @default(cuid())
  instance_id  String
  timestamp    DateTime @default(now())
  cpu_percent  Float    // 0–100
  memory_used  BigInt   // bytes
  memory_total BigInt   // bytes
  disk_used    BigInt   // bytes
  disk_total   BigInt   // bytes
  uptime       BigInt   // seconds

  // Relations
  instance Instance @relation(fields: [instance_id], references: [id], onDelete: Cascade)

  @@index([instance_id])
  @@index([timestamp])
  @@index([instance_id, timestamp])
}

/// Detailed per-collection metric snapshot — the full-fidelity time-series table.
/// Converted to a TimescaleDB hypertable partitioned by `timestamp`.
/// The lighter-weight Heartbeat table stores coarse liveness pings.
model Metric {
  id           String   @id @default(cuid())
  instance_id  String
  timestamp    DateTime @default(now())

  // CPU
  cpu_percent  Float    // overall usage 0–100
  load_avg_1   Float?
  load_avg_5   Float?
  load_avg_15  Float?
  cpu_steal    Float?   // hypervisor steal percent
  core_count   Int?

  // Memory (bytes)
  mem_used     BigInt
  mem_total    BigInt
  mem_cached   BigInt?
  swap_used    BigInt?
  swap_total   BigInt?

  // Disk (bytes, primary volume)
  disk_used    BigInt
  disk_total   BigInt
  disk_read_bps  BigInt?
  disk_write_bps BigInt?

  // Network (cumulative bytes since agent start)
  net_bytes_sent BigInt?
  net_bytes_recv BigInt?
  net_packets_sent BigInt?
  net_packets_recv BigInt?

  // Relations
  instance Instance @relation(fields: [instance_id], references: [id], onDelete: Cascade)

  @@index([instance_id, timestamp])
  @@index([timestamp])
}

/// Lifecycle and operational events emitted by instances or the Console.
model Event {
  id          String    @id @default(cuid())
  instance_id String
  event_type  EventType
  timestamp   DateTime  @default(now())
  metadata    Json?     // Arbitrary structured payload per event type

  // Relations
  instance Instance @relation(fields: [instance_id], references: [id], onDelete: Cascade)

  @@index([instance_id])
  @@index([event_type])
  @@index([timestamp])
  @@index([instance_id, timestamp])
}

// ─────────────────────────────────────────────────────────────────────────────
// User & Access Management
// ─────────────────────────────────────────────────────────────────────────────

/// Console user accounts with RBAC role assignment.
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password_hash String   // bcrypt hash; null if SSO-only
  role          UserRole @default(DEVELOPER)
  created_at    DateTime @default(now())

  // Relations
  api_keys           ApiKey[]
  terminal_sessions  TerminalSession[]
  command_executions CommandExecution[]

  @@index([email])
  @@index([role])
}

/// API keys for CI/CD and programmatic access to the Console API.
model ApiKey {
  id         String    @id @default(cuid())
  user_id    String
  key_hash   String    @unique // SHA256 of the raw key; raw key shown once at creation
  name       String            // Human-readable label
  created_at DateTime  @default(now())
  expires_at DateTime?         // Null means non-expiring

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([key_hash])
  @@index([expires_at])
}

// ─────────────────────────────────────────────────────────────────────────────
// Terminal Sessions
// ─────────────────────────────────────────────────────────────────────────────

// ─────────────────────────────────────────────────────────────────────────────
// Scheduled Tasks
// ─────────────────────────────────────────────────────────────────────────────

/// A scheduled cron task that executes commands on Sindri instances.
model ScheduledTask {
  id            String              @id @default(cuid())
  name          String
  description   String?
  cron          String              // cron expression e.g. "0 2 * * *"
  timezone      String              @default("UTC")
  command       String              // command to execute
  instance_id   String?             // target instance (null = all)
  status        ScheduledTaskStatus @default(ACTIVE)
  template      String?             // template key if from gallery
  timeout_sec   Int                 @default(300)
  max_retries   Int                 @default(0)
  notify_on_failure Boolean         @default(false)
  notify_on_success Boolean         @default(false)
  notify_emails   String[]          @default([])
  last_run_at     DateTime?
  next_run_at     DateTime?
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  created_by      String?           // user id

  executions      TaskExecution[]

  @@index([status])
  @@index([instance_id])
  @@index([next_run_at])
  @@index([created_at])
}

/// An individual execution record for a scheduled task.
model TaskExecution {
  id          String              @id @default(cuid())
  task_id     String
  instance_id String?
  status      TaskExecutionStatus @default(PENDING)
  exit_code   Int?
  stdout      String?
  stderr      String?
  started_at  DateTime            @default(now())
  finished_at DateTime?
  duration_ms Int?
  triggered_by String?            // "scheduler" | "manual"

  task ScheduledTask @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@index([task_id])
  @@index([status])
  @@index([started_at])
  @@index([task_id, started_at])
}

/// A command execution record — dispatched via the Console to one instance.
model CommandExecution {
  id             String   @id @default(cuid())
  instance_id    String
  user_id        String
  command        String
  args           String[] @default([])
  env            Json     @default("{}")
  working_dir    String?
  timeout_ms     Int      @default(30000)
  status         String   @default("RUNNING") // PENDING | RUNNING | SUCCEEDED | FAILED | TIMEOUT
  exit_code      Int?
  stdout         String?
  stderr         String?
  duration_ms    Int?
  correlation_id String   @unique
  script_content String?  // populated for script executions
  created_at     DateTime @default(now())
  completed_at   DateTime?

  instance Instance @relation(fields: [instance_id], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([instance_id])
  @@index([user_id])
  @@index([status])
  @@index([created_at])
  @@index([instance_id, created_at])
  @@index([correlation_id])
}

// ─────────────────────────────────────────────────────────────────────────────
// Deployment Templates & Deployments
// ─────────────────────────────────────────────────────────────────────────────

/// A reusable sindri.yaml template shown in the deployment wizard.
model DeploymentTemplate {
  id                       String   @id @default(cuid())
  name                     String
  slug                     String   @unique // URL-safe identifier, e.g. "python-ml"
  category                 String   // e.g. "language", "ai", "infrastructure"
  description              String
  yaml_content             String   // Full sindri.yaml content
  extensions               String[] // Derived list of extension names from yaml_content
  provider_recommendations String[] // Suggested providers e.g. ["fly", "docker"]
  is_official              Boolean  @default(false) // Curated by the Sindri team
  created_by               String?  // user_id of uploader; null = built-in template
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  deployments Deployment[]

  @@index([category])
  @@index([is_official])
  @@index([created_at])
}

/// A deployment run — tracks the full lifecycle of one sindri deploy operation.
model Deployment {
  id           String           @id @default(cuid())
  instance_id  String?          // null before the instance is registered
  template_id  String?          // source template, if any
  config_hash  String           // SHA256 of the sindri.yaml used
  yaml_content String           // Snapshot of sindri.yaml at deploy time
  provider     String           // Target provider
  region       String?          // Target region
  status       DeploymentStatus @default(PENDING)
  initiated_by String?          // user_id
  started_at   DateTime         @default(now())
  completed_at DateTime?
  logs         String?          // Captured deploy output
  error        String?          // Error message on failure

  instance Instance?           @relation(fields: [instance_id], references: [id], onDelete: SetNull)
  template DeploymentTemplate? @relation(fields: [template_id], references: [id], onDelete: SetNull)

  @@index([instance_id])
  @@index([template_id])
  @@index([status])
  @@index([started_at])
  @@index([initiated_by])
}

/// Centralized log entries from instances, agents, extensions, and builds.
/// Supports full-text search via a GIN index on the message field.
model Log {
  id            String    @id @default(cuid())
  instance_id   String
  level         LogLevel
  source        LogSource
  message       String
  metadata      Json?     // Arbitrary structured payload (stack traces, context, etc.)
  deployment_id String?   // Correlation with a specific deployment
  timestamp     DateTime  @default(now())

  // Relations
  instance Instance @relation(fields: [instance_id], references: [id], onDelete: Cascade)

  @@index([instance_id])
  @@index([level])
  @@index([source])
  @@index([timestamp])
  @@index([deployment_id])
  @@index([instance_id, timestamp])
  @@index([instance_id, level])
}

// ─────────────────────────────────────────────────────────────────────────────
// Alerting Engine
// ─────────────────────────────────────────────────────────────────────────────

/// A rule that defines conditions for generating alerts.
model AlertRule {
  id           String        @id @default(cuid())
  name         String
  description  String?
  type         AlertRuleType
  severity     AlertSeverity @default(MEDIUM)
  enabled      Boolean       @default(true)
  instance_id  String?       // null = applies to all instances
  conditions   Json          // type-specific condition config
  cooldown_sec Int           @default(300)
  created_by   String?
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt

  alerts       Alert[]
  channels     AlertRuleChannel[]

  @@index([type])
  @@index([severity])
  @@index([enabled])
  @@index([instance_id])
}

/// A triggered alert instance from an AlertRule evaluation.
model Alert {
  id              String        @id @default(cuid())
  rule_id         String
  instance_id     String?
  status          AlertStatus   @default(ACTIVE)
  severity        AlertSeverity
  title           String
  message         String
  metadata        Json?
  fired_at        DateTime      @default(now())
  acknowledged_at DateTime?
  acknowledged_by String?
  resolved_at     DateTime?
  resolved_by     String?
  dedupe_key      String

  rule          AlertRule          @relation(fields: [rule_id], references: [id], onDelete: Cascade)
  notifications AlertNotification[]

  @@index([rule_id])
  @@index([instance_id])
  @@index([status])
  @@index([severity])
  @@index([fired_at])
  @@index([dedupe_key])
}

/// A notification channel (webhook, Slack, email, in-app).
model NotificationChannel {
  id         String                  @id @default(cuid())
  name       String
  type       NotificationChannelType
  config     Json
  enabled    Boolean                 @default(true)
  created_by String?
  created_at DateTime                @default(now())
  updated_at DateTime                @updatedAt

  rules         AlertRuleChannel[]
  notifications AlertNotification[]

  @@index([type])
  @@index([enabled])
}

/// Join table: which channels receive notifications for an alert rule.
model AlertRuleChannel {
  rule_id    String
  channel_id String

  rule    AlertRule           @relation(fields: [rule_id], references: [id], onDelete: Cascade)
  channel NotificationChannel @relation(fields: [channel_id], references: [id], onDelete: Cascade)

  @@id([rule_id, channel_id])
}

/// A dispatched notification for an alert.
model AlertNotification {
  id         String   @id @default(cuid())
  alert_id   String
  channel_id String
  sent_at    DateTime @default(now())
  success    Boolean  @default(true)
  error      String?
  payload    Json?

  alert   Alert               @relation(fields: [alert_id], references: [id], onDelete: Cascade)
  channel NotificationChannel @relation(fields: [channel_id], references: [id], onDelete: Cascade)

  @@index([alert_id])
  @@index([channel_id])
  @@index([sent_at])
}

/// Web terminal sessions opened from the Console to a Sindri instance.
model TerminalSession {
  id          String                @id @default(cuid())
  instance_id String
  user_id     String
  started_at  DateTime              @default(now())
  ended_at    DateTime?
  status      TerminalSessionStatus @default(ACTIVE)

  // Relations
  instance Instance @relation(fields: [instance_id], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([instance_id])
  @@index([user_id])
  @@index([status])
  @@index([started_at])
  @@index([instance_id, user_id])
}
