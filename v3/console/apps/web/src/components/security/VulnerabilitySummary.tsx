import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import type { SecuritySummary, VulnerabilitySeverity } from '@/types/security'

interface Props {
  summary?: SecuritySummary
  loading?: boolean
  onFilterBySeverity?: (severity: VulnerabilitySeverity) => void
}

const SEVERITY_ORDER: VulnerabilitySeverity[] = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'UNKNOWN']

function severityVariant(sev: VulnerabilitySeverity): 'error' | 'destructive' | 'warning' | 'secondary' | 'muted' {
  switch (sev) {
    case 'CRITICAL': return 'error'
    case 'HIGH': return 'destructive'
    case 'MEDIUM': return 'warning'
    case 'LOW': return 'secondary'
    default: return 'muted'
  }
}

function severityBarColor(sev: VulnerabilitySeverity): string {
  switch (sev) {
    case 'CRITICAL': return 'bg-red-500'
    case 'HIGH': return 'bg-orange-500'
    case 'MEDIUM': return 'bg-amber-400'
    case 'LOW': return 'bg-blue-400'
    default: return 'bg-muted-foreground/30'
  }
}

export function VulnerabilitySummary({ summary, loading, onFilterBySeverity }: Props) {
  if (loading) {
    return (
      <Card>
        <CardHeader><CardTitle>Vulnerabilities</CardTitle></CardHeader>
        <CardContent>
          <div className="animate-pulse space-y-3">
            {[1, 2, 3, 4].map((i) => (
              <div key={i} className="h-8 bg-muted rounded" />
            ))}
          </div>
        </CardContent>
      </Card>
    )
  }

  if (!summary) return null

  const total = summary.totalVulnerabilities

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <CardTitle>Vulnerabilities</CardTitle>
          <div className="text-2xl font-bold">{total}</div>
        </div>
      </CardHeader>
      <CardContent className="space-y-2">
        {SEVERITY_ORDER.map((sev) => {
          const count = summary.bySeverity[sev] ?? 0
          const pct = total > 0 ? (count / total) * 100 : 0
          return (
            <button
              key={sev}
              className="w-full text-left group"
              onClick={() => onFilterBySeverity?.(sev)}
            >
              <div className="flex items-center justify-between mb-1">
                <Badge variant={severityVariant(sev)}>{sev}</Badge>
                <span className="text-sm font-medium">{count}</span>
              </div>
              <div className="h-1.5 bg-muted rounded-full overflow-hidden">
                <div
                  className={`h-full rounded-full transition-all group-hover:opacity-80 ${severityBarColor(sev)}`}
                  style={{ width: `${pct}%` }}
                />
              </div>
            </button>
          )
        })}

        <div className="pt-2 border-t text-xs text-muted-foreground flex justify-between">
          <span>{summary.openCount} open</span>
          <span>{summary.acknowledgedCount} acknowledged</span>
        </div>
      </CardContent>
    </Card>
  )
}
