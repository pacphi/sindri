# Sindri Console — API Specification

## Overview

The Console API is built with **Hono** (HTTP framework) and **tRPC** (type-safe RPC layer). All REST endpoints serve as the external interface for instance agents; the tRPC layer is used by the React frontend for full end-to-end type safety.

Base URL: `https://<console-host>/api/v1`

WebSocket endpoint: `wss://<console-host>/ws`

---

## Authentication

### Bootstrap Authentication (Agent Registration)

Agents use a shared API key during initial registration:

```
Authorization: Bearer <SINDRI_CONSOLE_API_KEY>
```

### Session Authentication (Browser)

The frontend authenticates via HTTP-only session cookie set on login. All subsequent API calls carry the session cookie automatically.

### Agent Token Authentication (Post-Registration)

After registration, each agent receives a per-instance JWT:

```
Authorization: Bearer <INSTANCE_JWT>
```

JWTs expire after 24 hours. Agents must re-register to obtain a new token.

---

## REST API Endpoints

### Instance Registration

#### POST /api/v1/instances/register

Register a new Sindri instance with the Console. Called by the agent on startup.

**Auth:** Bootstrap API key

**Request body:**

```json
{
  "instanceId": "string (UUID, generated by agent)",
  "name": "string (human-readable, from sindri.yaml name field)",
  "provider": "fly | docker | devpod | e2b | kubernetes",
  "region": "string (e.g. sea, us-east-1, local)",
  "extensions": ["string"],
  "yamlHash": "string (SHA256 of sindri.yaml content)",
  "bom": {
    "version": "string",
    "packages": [
      {
        "name": "string",
        "version": "string",
        "source": "apt | binary | pip | npm | cargo",
        "hash": "string"
      }
    ]
  },
  "sshEndpoint": "string (host:port, optional)",
  "agentVersion": "string"
}
```

**Response 201:**

```json
{
  "instanceToken": "string (JWT for future agent calls)",
  "wsEndpoint": "wss://console-host/ws/agent",
  "heartbeatInterval": 10,
  "metricsInterval": 30
}
```

**Response 409:** Instance already registered (returns existing token)

---

#### GET /api/v1/instances

List all registered instances visible to the authenticated user.

**Auth:** Session cookie (browser)

**Query params:**
- `provider` — filter by provider (fly, docker, devpod, e2b, kubernetes)
- `status` — filter by status (running, stopped, error, unknown)
- `region` — filter by region string

**Response 200:**

```json
{
  "instances": [
    {
      "id": "string",
      "name": "string",
      "provider": "string",
      "region": "string",
      "status": "running | stopped | error | unknown",
      "extensions": ["string"],
      "lastHeartbeat": "ISO8601",
      "uptime": 123456,
      "cpu": 23.5,
      "memoryUsed": 412345678,
      "memoryTotal": 1073741824,
      "agentConnected": true
    }
  ],
  "total": 42
}
```

---

#### GET /api/v1/instances/:id

Get full details for a single instance.

**Auth:** Session cookie

**Response 200:**

```json
{
  "id": "string",
  "name": "string",
  "provider": "string",
  "region": "string",
  "status": "string",
  "extensions": ["string"],
  "yamlHash": "string",
  "sshEndpoint": "string",
  "agentVersion": "string",
  "createdAt": "ISO8601",
  "lastHeartbeat": "ISO8601",
  "metrics": {
    "cpu": 23.5,
    "loadAvg": [1.2, 1.1, 0.9],
    "memoryUsed": 412345678,
    "memoryTotal": 1073741824,
    "diskUsed": 5368709120,
    "diskTotal": 53687091200,
    "networkBytesIn": 1048576,
    "networkBytesOut": 524288
  },
  "bom": {
    "version": "string",
    "packages": []
  }
}
```

---

#### DELETE /api/v1/instances/:id

Remove an instance from the registry. Does not destroy the underlying infrastructure.

**Auth:** Session cookie (operator or admin role required)

**Response 204:** No content

---

### Heartbeat & Metrics

#### POST /api/v1/instances/:id/heartbeat

Periodic health ping from the agent.

**Auth:** Instance JWT

**Request body:**

```json
{
  "timestamp": "ISO8601",
  "status": "running | stopping | error",
  "uptime": 123456
}
```

**Response 200:**

```json
{
  "ok": true,
  "serverTime": "ISO8601"
}
```

---

#### POST /api/v1/instances/:id/metrics

Ship a metrics snapshot from the agent.

**Auth:** Instance JWT

**Request body:**

```json
{
  "timestamp": "ISO8601",
  "cpu": {
    "usagePercent": 23.5,
    "loadAvg1": 1.2,
    "loadAvg5": 1.1,
    "loadAvg15": 0.9,
    "stealPercent": 0.0
  },
  "memory": {
    "usedBytes": 412345678,
    "totalBytes": 1073741824,
    "cachedBytes": 104857600,
    "swapUsedBytes": 0,
    "swapTotalBytes": 0
  },
  "disk": {
    "usedBytes": 5368709120,
    "totalBytes": 53687091200,
    "inodesUsed": 12345,
    "inodesTotal": 1000000,
    "readBytesPerSec": 1048576,
    "writeBytesPerSec": 524288
  },
  "network": {
    "bytesIn": 1048576,
    "bytesOut": 524288,
    "activeConnections": 12,
    "sshSessions": 1
  },
  "processes": [
    {
      "pid": 1234,
      "name": "node",
      "cpuPercent": 5.2,
      "memoryBytes": 52428800
    }
  ]
}
```

**Response 200:** `{ "ok": true }`

---

#### POST /api/v1/instances/:id/events

Report a lifecycle event from the agent.

**Auth:** Instance JWT

**Request body:**

```json
{
  "type": "deploy | redeploy | connect | disconnect | backup | destroy | extension_install | extension_error",
  "timestamp": "ISO8601",
  "metadata": {}
}
```

**Response 201:** `{ "eventId": "string" }`

---

### Authentication (Browser)

#### POST /api/v1/auth/login

**Request body:**

```json
{
  "email": "string",
  "password": "string"
}
```

**Response 200:** Sets HTTP-only session cookie

```json
{
  "user": {
    "id": "string",
    "email": "string",
    "role": "admin | operator | developer | viewer",
    "teamId": "string"
  }
}
```

---

#### POST /api/v1/auth/logout

Clears session cookie.

**Response 200:** `{ "ok": true }`

---

#### GET /api/v1/auth/me

Returns current authenticated user.

**Response 200:**

```json
{
  "id": "string",
  "email": "string",
  "role": "string",
  "teamId": "string",
  "createdAt": "ISO8601"
}
```

---

### API Keys

#### GET /api/v1/api-keys

List API keys for the current user's team.

**Response 200:**

```json
{
  "keys": [
    {
      "id": "string",
      "name": "string",
      "prefix": "sk-xxxx",
      "lastUsed": "ISO8601",
      "createdAt": "ISO8601",
      "createdBy": "string"
    }
  ]
}
```

---

#### POST /api/v1/api-keys

Create a new API key.

**Request body:**

```json
{
  "name": "string"
}
```

**Response 201:**

```json
{
  "id": "string",
  "name": "string",
  "key": "sk-...",
  "prefix": "sk-xxxx"
}
```

Note: The full key is returned only once at creation time.

---

#### DELETE /api/v1/api-keys/:id

Revoke an API key.

**Response 204:** No content

---

### Metrics History

#### GET /api/v1/instances/:id/metrics/history

Fetch historical metric time series.

**Query params:**
- `metric` — one of: `cpu`, `memory`, `disk`, `network` (required)
- `from` — ISO8601 start timestamp (default: 1 hour ago)
- `to` — ISO8601 end timestamp (default: now)
- `resolution` — `1m`, `5m`, `1h` (default: auto-selected based on range)

**Response 200:**

```json
{
  "metric": "cpu",
  "resolution": "5m",
  "from": "ISO8601",
  "to": "ISO8601",
  "datapoints": [
    { "timestamp": "ISO8601", "value": 23.5 }
  ]
}
```

---

### Audit Log

#### GET /api/v1/audit

Fetch audit log entries.

**Auth:** Admin or operator role

**Query params:**
- `instanceId` — filter by instance
- `userId` — filter by actor
- `action` — filter by action type
- `from` / `to` — time range
- `limit` — max results (default 100, max 1000)
- `offset` — pagination offset

**Response 200:**

```json
{
  "entries": [
    {
      "id": "string",
      "userId": "string",
      "userEmail": "string",
      "action": "string",
      "target": "string",
      "targetId": "string",
      "ip": "string",
      "timestamp": "ISO8601",
      "metadata": {}
    }
  ],
  "total": 4200
}
```

---

## WebSocket Protocol

### Agent WebSocket: `wss://<host>/ws/agent`

The agent connects here after registration. Connection requires the instance JWT as a query parameter:

```
wss://<host>/ws/agent?token=<INSTANCE_JWT>
```

All messages are JSON with the shape:

```json
{
  "channel": "string",
  "type": "string",
  "payload": {}
}
```

#### Heartbeat Channel

**Agent -> Console** every 10s:

```json
{
  "channel": "heartbeat",
  "type": "ping",
  "payload": {
    "instanceId": "string",
    "timestamp": "ISO8601",
    "status": "running"
  }
}
```

**Console -> Agent** response:

```json
{
  "channel": "heartbeat",
  "type": "pong",
  "payload": { "serverTime": "ISO8601" }
}
```

---

#### Metrics Channel

**Agent -> Console** every 30s (same payload as POST /metrics):

```json
{
  "channel": "metrics",
  "type": "snapshot",
  "payload": { ... }
}
```

---

#### Logs Channel

**Agent -> Console** streaming (newline-delimited log lines):

```json
{
  "channel": "logs",
  "type": "line",
  "payload": {
    "instanceId": "string",
    "timestamp": "ISO8601",
    "source": "init | extension | system | agent",
    "level": "info | warn | error",
    "message": "string"
  }
}
```

---

#### Terminal Channel

**Console -> Agent** to create a terminal:

```json
{
  "channel": "terminal",
  "type": "create",
  "payload": {
    "sessionId": "string (UUID, assigned by console)",
    "cols": 220,
    "rows": 50,
    "shell": "/bin/bash"
  }
}
```

**Agent -> Console** ready confirmation:

```json
{
  "channel": "terminal",
  "type": "ready",
  "payload": { "sessionId": "string" }
}
```

**Browser -> Console -> Agent** input:

```json
{
  "channel": "terminal",
  "type": "input",
  "payload": {
    "sessionId": "string",
    "data": "base64-encoded string"
  }
}
```

**Agent -> Console -> Browser** output:

```json
{
  "channel": "terminal",
  "type": "output",
  "payload": {
    "sessionId": "string",
    "data": "base64-encoded string"
  }
}
```

**Browser -> Console -> Agent** resize:

```json
{
  "channel": "terminal",
  "type": "resize",
  "payload": {
    "sessionId": "string",
    "cols": 220,
    "rows": 50
  }
}
```

**Either party** to close:

```json
{
  "channel": "terminal",
  "type": "close",
  "payload": { "sessionId": "string" }
}
```

---

#### Events Channel

**Agent -> Console** on occurrence:

```json
{
  "channel": "events",
  "type": "lifecycle",
  "payload": {
    "instanceId": "string",
    "event": "deploy | redeploy | connect | disconnect | backup | destroy",
    "timestamp": "ISO8601",
    "metadata": {}
  }
}
```

---

#### Commands Channel

**Console -> Agent** to run a command:

```json
{
  "channel": "commands",
  "type": "exec",
  "payload": {
    "commandId": "string (UUID)",
    "command": "string",
    "timeout": 30
  }
}
```

**Agent -> Console** output streaming:

```json
{
  "channel": "commands",
  "type": "output",
  "payload": {
    "commandId": "string",
    "data": "string",
    "stream": "stdout | stderr"
  }
}
```

**Agent -> Console** completion:

```json
{
  "channel": "commands",
  "type": "complete",
  "payload": {
    "commandId": "string",
    "exitCode": 0
  }
}
```

---

### Browser WebSocket: `wss://<host>/ws/browser`

The browser connects here for real-time updates. Authenticated via session cookie.

#### Subscriptions

**Browser -> Console** subscribe to instance updates:

```json
{
  "channel": "subscribe",
  "type": "instance",
  "payload": { "instanceId": "string" }
}
```

**Console -> Browser** live metric push (when subscribed):

```json
{
  "channel": "metrics",
  "type": "update",
  "payload": {
    "instanceId": "string",
    "timestamp": "ISO8601",
    "cpu": 23.5,
    "memoryUsed": 412345678
  }
}
```

**Console -> Browser** instance status change:

```json
{
  "channel": "events",
  "type": "status_change",
  "payload": {
    "instanceId": "string",
    "oldStatus": "running",
    "newStatus": "error",
    "timestamp": "ISO8601"
  }
}
```

---

## tRPC Router Structure

The tRPC router is used exclusively by the React frontend for type-safe data fetching.

```typescript
// Approximate tRPC router shape
const appRouter = router({
  instances: router({
    list: publicProcedure.query(...),
    get: publicProcedure.input(z.object({ id: z.string() })).query(...),
    delete: protectedProcedure.input(...).mutation(...),
    metrics: router({
      history: publicProcedure.input(...).query(...)
    })
  }),
  auth: router({
    login: publicProcedure.input(...).mutation(...),
    logout: protectedProcedure.mutation(...),
    me: protectedProcedure.query(...)
  }),
  apiKeys: router({
    list: protectedProcedure.query(...),
    create: protectedProcedure.input(...).mutation(...),
    delete: protectedProcedure.input(...).mutation(...)
  }),
  audit: router({
    list: adminProcedure.input(...).query(...)
  })
})
```

---

## Error Responses

All REST errors follow this shape:

```json
{
  "error": {
    "code": "string (machine-readable)",
    "message": "string (human-readable)",
    "details": {}
  }
}
```

| HTTP Status | Code | Meaning |
|---|---|---|
| 400 | VALIDATION_ERROR | Invalid request body |
| 401 | UNAUTHORIZED | Missing or invalid credentials |
| 403 | FORBIDDEN | Insufficient role |
| 404 | NOT_FOUND | Resource does not exist |
| 409 | CONFLICT | Resource already exists |
| 429 | RATE_LIMITED | Too many requests |
| 500 | INTERNAL_ERROR | Server error |

---

## Rate Limiting

| Endpoint | Limit |
|---|---|
| POST /instances/register | 10 req/min per IP |
| POST /auth/login | 5 req/min per IP |
| GET /instances | 300 req/min per token |
| POST /instances/:id/metrics | 120 req/min per instance |
| POST /instances/:id/heartbeat | 60 req/min per instance |
| All other endpoints | 1000 req/min per token |

---

## Phase 2 REST API Endpoints

### Deployment Templates

#### GET /api/v1/templates

List available deployment templates.

**Auth:** Session cookie

**Query params:**
- `category` — filter by category (e.g. `data-science`, `web-development`, `systems`)
- `provider` — filter by provider compatibility

**Response 200:**
```json
{
  "templates": [
    {
      "id": "tmpl_python_01",
      "name": "Python Data Science",
      "description": "Jupyter + pandas + scikit-learn environment",
      "category": "data-science",
      "extensions": ["python3", "jupyter", "pandas"],
      "providers": ["fly", "docker", "e2b"],
      "version": "1.0.0"
    }
  ],
  "total": 12
}
```

---

#### GET /api/v1/templates/:id

Get a single template including the full `sindri.yaml` content.

**Response 200:**
```json
{
  "id": "tmpl_python_01",
  "name": "Python Data Science",
  "yaml": "name: python-data-science\nextensions:\n  - python3\n",
  "version": "1.0.0"
}
```

---

### Instance Lifecycle

#### POST /api/v1/instances/:id/clone

Clone an existing instance configuration to a new instance.

**Auth:** Session cookie (OPERATOR+ required)

**Request body:**
```json
{
  "name": "my-clone",
  "provider": "fly",
  "region": "iad"
}
```

**Response 201:**
```json
{
  "id": "inst_clone_01",
  "name": "my-clone",
  "provider": "fly",
  "status": "DEPLOYING",
  "sourceInstanceId": "inst_01"
}
```

---

#### POST /api/v1/instances/:id/suspend

Gracefully stop a running instance.

**Auth:** Session cookie (OPERATOR+ required)

**Response 200:**
```json
{ "id": "inst_01", "status": "STOPPED", "message": "Instance suspended" }
```

**Response 409:** Instance is not in a suspendable state.

---

#### POST /api/v1/instances/:id/resume

Restart a stopped instance.

**Auth:** Session cookie (OPERATOR+ required)

**Response 200:**
```json
{ "id": "inst_01", "status": "RUNNING", "message": "Instance resumed" }
```

---

### Command Execution

#### POST /api/v1/instances/:id/execute

Dispatch a command to a single instance. Output is streamed via WebSocket.

**Auth:** Session cookie (DEVELOPER+ required)

**Request body:**
```json
{
  "command": "node --version",
  "timeout": 30,
  "env": {}
}
```

**Response 202:**
```json
{ "commandId": "cmd_abc123", "instanceId": "inst_01" }
```

---

#### POST /api/v1/instances/execute-many

Dispatch the same command to multiple instances in parallel.

**Auth:** Session cookie (DEVELOPER+ required)

**Request body:**
```json
{
  "instanceIds": ["inst_01", "inst_02"],
  "command": "uptime",
  "timeout": 30
}
```

**Response 202:**
```json
{
  "batchId": "batch_xyz789",
  "commands": [
    { "commandId": "cmd_01", "instanceId": "inst_01" },
    { "commandId": "cmd_02", "instanceId": "inst_02" }
  ]
}
```

---

### Scheduled Tasks

#### GET /api/v1/scheduled-tasks

List all scheduled tasks.

**Auth:** Session cookie

**Response 200:**
```json
{
  "tasks": [
    {
      "id": "task_01",
      "name": "Nightly Backup",
      "command": "/usr/local/bin/backup.sh",
      "cronExpression": "0 2 * * *",
      "instanceIds": ["inst_01", "inst_02"],
      "enabled": true,
      "timezone": "UTC",
      "lastRunAt": "2026-02-17T02:00:00Z",
      "nextRunAt": "2026-02-18T02:00:00Z"
    }
  ],
  "total": 5
}
```

---

#### POST /api/v1/scheduled-tasks

Create a new scheduled task.

**Auth:** Session cookie (OPERATOR+ required)

**Request body:**
```json
{
  "name": "Nightly Backup",
  "command": "/usr/local/bin/backup.sh",
  "cronExpression": "0 2 * * *",
  "instanceIds": ["inst_01", "inst_02"],
  "timezone": "UTC"
}
```

**Response 201:**
```json
{ "id": "task_01", "name": "Nightly Backup", "nextRunAt": "2026-02-18T02:00:00Z" }
```

---

#### PATCH /api/v1/scheduled-tasks/:id

Update a scheduled task (including toggle enabled state).

**Request body (partial):**
```json
{ "enabled": false }
```

**Response 200:** Updated task object.

---

#### DELETE /api/v1/scheduled-tasks/:id

Delete a scheduled task and its execution history.

**Auth:** OPERATOR+ required

**Response 204:** No content.

---

#### GET /api/v1/scheduled-tasks/:id/executions

List execution history for a task.

**Query params:**
- `limit` — max results (default 20, max 100)
- `offset` — pagination offset
- `status` — filter by `success`, `failure`, `timeout`

**Response 200:**
```json
{
  "executions": [
    {
      "id": "exec_01",
      "taskId": "task_01",
      "instanceId": "inst_01",
      "status": "success",
      "startedAt": "2026-02-17T02:00:00Z",
      "completedAt": "2026-02-17T02:00:05Z",
      "exitCode": 0,
      "output": "Backup completed. 1.2GB archived."
    }
  ],
  "total": 14
}
```

---

## Phase 3 Observability API

### Metrics

#### GET /api/v1/metrics/:instanceId/timeseries

Retrieve time-series chart data for a single instance.

**Auth:** Bearer token (DEVELOPER+)

**Query parameters:**

- `from` — ISO8601 start (required)
- `to` — ISO8601 end (required)
- `granularity` — `raw` | `1m` | `5m` | `1h` | `1d` (default: `raw`)
- `limit` — max data points, default 500

**Response 200:**
```json
{
  "instanceId": "inst_01",
  "granularity": "5m",
  "points": [
    {
      "timestamp": "2026-02-17T10:00:00.000Z",
      "instanceId": "inst_01",
      "cpuPercent": 42.5,
      "memUsed": "2147483648",
      "memTotal": "8589934592",
      "diskUsed": "21474836480",
      "diskTotal": "107374182400",
      "loadAvg1": 1.2,
      "loadAvg5": 0.9,
      "loadAvg15": 0.7,
      "netBytesSent": "104857600",
      "netBytesRecv": "209715200"
    }
  ]
}
```

---

#### GET /api/v1/metrics/:instanceId/aggregate

Aggregate stats (avg/max) over a time window.

**Auth:** Bearer token (DEVELOPER+)

**Query parameters:**

- `from` — ISO8601 start (required)
- `to` — ISO8601 end (required)
- `metrics` — comma-separated metric names (optional, default: all)

**Response 200:**
```json
{
  "instanceId": "inst_01",
  "from": "2026-02-17T09:00:00.000Z",
  "to": "2026-02-17T10:00:00.000Z",
  "avgCpuPercent": 38.2,
  "maxCpuPercent": 67.8,
  "avgMemUsed": "2000000000",
  "maxMemUsed": "3000000000",
  "avgDiskUsed": "20000000000",
  "maxDiskUsed": "22000000000",
  "avgLoadAvg1": 1.1,
  "sampleCount": 60
}
```

---

#### GET /api/v1/metrics/latest

Latest metric snapshot per instance (fleet-wide or filtered).

**Auth:** Bearer token (DEVELOPER+)

**Query parameters:**

- `instanceIds` — comma-separated instance IDs (optional, default: all)

**Response 200:**
```json
{
  "metrics": [
    {
      "instanceId": "inst_01",
      "timestamp": "2026-02-17T10:00:00.000Z",
      "cpuPercent": 42.5,
      "memUsed": "2147483648",
      "memTotal": "8589934592",
      "memPercent": 25.0,
      "diskUsed": "21474836480",
      "diskTotal": "107374182400",
      "diskPercent": 20.0,
      "loadAvg1": 1.2,
      "loadAvg5": 0.9,
      "loadAvg15": 0.7,
      "netBytesSent": "104857600",
      "netBytesRecv": "209715200"
    }
  ]
}
```

---

### Logs

#### GET /api/v1/logs

Query and search log entries.

**Auth:** Bearer token (DEVELOPER+)

**Query parameters:**

- `instanceId` — filter to one instance (optional)
- `level` — comma-separated log levels: `DEBUG,INFO,WARN,ERROR` (optional)
- `source` — comma-separated sources: `AGENT,EXTENSION,BUILD,APP,SYSTEM` (optional)
- `from` — ISO8601 start (optional)
- `to` — ISO8601 end (optional)
- `q` — full-text search query (optional)
- `limit` — page size, default 50, max 500
- `cursor` — log entry ID for cursor pagination (optional)

**Response 200:**
```json
{
  "logs": [
    {
      "id": "log_01",
      "instanceId": "inst_01",
      "timestamp": "2026-02-17T10:05:00.000Z",
      "level": "WARN",
      "source": "SYSTEM",
      "message": "High memory usage detected: 82%",
      "metadata": null
    }
  ],
  "total": 1240,
  "hasMore": true,
  "nextCursor": "log_50"
}
```

---

#### GET /api/v1/logs/stream

Server-Sent Events stream of new log entries (real-time).

**Auth:** Bearer token (DEVELOPER+)

**Query parameters:**

- `instanceId` — required
- `level` — comma-separated level filter (optional)

**Response:** `text/event-stream`

```
data: {"id":"log_new","instanceId":"inst_01","timestamp":"...","level":"ERROR","source":"APP","message":"Connection refused","metadata":null}

data: {"id":"log_new2",...}
```

---

### Alerts

#### GET /api/v1/alerts/rules

List all alert rules.

**Auth:** Bearer token (DEVELOPER+)

**Response 200:**
```json
{
  "rules": [
    {
      "id": "rule_01",
      "name": "High CPU",
      "instanceId": null,
      "conditions": [{"metric": "cpu_percent", "op": "gt", "threshold": 80}],
      "conditionOperator": "AND",
      "severity": "warning",
      "evaluationWindowSec": 60,
      "pendingForSec": 120,
      "cooldownSec": 300,
      "notifyChannels": ["email"],
      "notifyEmails": ["ops@example.com"],
      "webhookUrl": null,
      "enabled": true,
      "createdAt": "2026-02-17T00:00:00Z",
      "updatedAt": "2026-02-17T00:00:00Z"
    }
  ]
}
```

---

#### POST /api/v1/alerts/rules

Create a new alert rule.

**Auth:** Bearer token (OPERATOR+)

**Request body:** Alert rule fields (same shape as GET response, without `id`/`createdAt`/`updatedAt`).

**Response 201:** Created rule object.

---

#### GET /api/v1/alerts/rules/:id

Get a single alert rule.

**Response 200:** Alert rule object.

---

#### PUT /api/v1/alerts/rules/:id

Update an alert rule.

**Auth:** Bearer token (OPERATOR+)

**Response 200:** Updated rule object.

---

#### DELETE /api/v1/alerts/rules/:id

Delete an alert rule (also deletes associated alert events).

**Auth:** Bearer token (OPERATOR+)

**Response 200:** `{ "ok": true }`

---

#### GET /api/v1/alerts/events

Query alert event history.

**Auth:** Bearer token (DEVELOPER+)

**Query parameters:**

- `ruleId` — filter by rule (optional)
- `instanceId` — filter by instance (optional)
- `state` — `INACTIVE` | `PENDING` | `FIRING` | `RESOLVED` (optional)
- `from` — ISO8601 start (optional)
- `to` — ISO8601 end (optional)
- `limit` — default 50
- `cursor` — event ID for pagination (optional)

**Response 200:**
```json
{
  "events": [
    {
      "id": "alert_01",
      "ruleId": "rule_01",
      "instanceId": "inst_01",
      "state": "FIRING",
      "severity": "warning",
      "triggerValue": 87.5,
      "triggerMetric": "cpu_percent",
      "message": "cpu_percent is 87.5 (threshold: 80)",
      "firedAt": "2026-02-17T10:00:00Z",
      "resolvedAt": null,
      "notificationsSent": 1
    }
  ],
  "hasMore": false,
  "nextCursor": null
}
```

---

## Phase 4: Administration & Security API

### Users (ADMIN only)

#### GET /api/v1/users

List all users. Requires `ADMIN` role.

**Query params:** `?role=DEVELOPER&page=1&per_page=25`

**Response 200:**
```json
{
  "users": [
    { "id": "user_01", "email": "dev@example.com", "role": "DEVELOPER", "created_at": "2026-01-01T00:00:00Z" }
  ],
  "total": 1,
  "page": 1,
  "per_page": 25
}
```

#### PATCH /api/v1/users/:id

Update a user's role. Requires `ADMIN` role. Generates a `PERMISSION_CHANGE` audit entry.

**Request body:** `{ "role": "OPERATOR" }`

**Response 200:** Updated user object.

---

### Teams

#### GET /api/v1/teams

List all teams. Returns all teams for `ADMIN`, team-scoped list for others.

#### POST /api/v1/teams

Create a team. Requires `ADMIN` role.

**Request body:**
```json
{ "name": "Platform Engineering", "slug": "platform-engineering", "description": "Core infra team" }
```

#### GET /api/v1/teams/:id/members

List team members. Requires team membership or `ADMIN`.

**Response 200:**
```json
{
  "members": [
    { "user_id": "user_01", "email": "dev@example.com", "role": "DEVELOPER", "joined_at": "2026-01-01T00:00:00Z" }
  ]
}
```

#### POST /api/v1/teams/:id/members

Add a user to a team. Requires team `ADMIN` or system `ADMIN`.

**Request body:** `{ "user_id": "user_02", "role": "DEVELOPER" }`

#### DELETE /api/v1/teams/:id/members/:userId

Remove a member from a team. Requires team `ADMIN` or system `ADMIN`.

---

### Audit Log

#### GET /api/v1/audit

Query the audit log. Requires `ADMIN` role.

**Query params:** `?action=PERMISSION_CHANGE&userId=user_01&from=2026-01-01&to=2026-02-01&limit=50`

**Response 200:**
```json
{
  "entries": [
    {
      "id": "audit_01",
      "user_id": "user_01",
      "action": "PERMISSION_CHANGE",
      "resource_type": "user",
      "resource_id": "user_02",
      "metadata": { "old_role": "DEVELOPER", "new_role": "OPERATOR" },
      "ip_address": "10.0.0.1",
      "timestamp": "2026-02-17T10:00:00Z"
    }
  ],
  "total": 1
}
```

---

### Extensions

#### GET /api/v1/extensions

List extensions from the registry.

**Query params:** `?status=APPROVED&tag=runtime&provider=fly&q=node&page=1&per_page=20`

**Response 200:**
```json
{
  "extensions": [
    {
      "id": "ext_01",
      "name": "Node.js LTS",
      "slug": "node-lts",
      "version": "20.11.0",
      "description": "Node.js LTS runtime",
      "status": "APPROVED",
      "is_official": true,
      "install_count": 1423,
      "tags": ["runtime", "javascript"]
    }
  ],
  "total": 1
}
```

#### POST /api/v1/extensions

Upload a custom extension. Requires `DEVELOPER` or higher role. Starts in `PENDING` status.

**Request body (multipart/form-data):**
- `name`, `slug`, `version`, `description`, `license`, `visibility`
- `artifact` (file upload)

#### POST /api/v1/extensions/:id/approve

Approve a pending extension. Requires `ADMIN` role.

#### POST /api/v1/extensions/:id/reject

Reject a pending extension. Requires `ADMIN` role.

**Request body:** `{ "reason": "Does not meet security requirements" }`

#### POST /api/v1/instances/:id/extensions

Install an extension on an instance. Requires `OPERATOR` or higher.

**Request body:** `{ "extension_id": "ext_01", "version": "20.11.0", "config": {} }`

---

### Configuration Drift

#### GET /api/v1/drift

Fleet drift summary.

**Response 200:**
```json
{
  "summary": {
    "total_instances": 25,
    "drifting_instances": 4,
    "health_percent": 84,
    "by_severity": { "CRITICAL": 1, "HIGH": 2, "MEDIUM": 1, "LOW": 0 }
  },
  "reports": [...]
}
```

#### GET /api/v1/drift/:instanceId

Drift report for a specific instance.

**Response 200:**
```json
{
  "id": "dr_01",
  "instance_id": "inst_01",
  "severity": "HIGH",
  "status": "DETECTED",
  "detected_at": "2026-02-17T10:00:00Z",
  "items": [
    {
      "drift_type": "EXTENSION_MISMATCH",
      "severity": "HIGH",
      "field": "extensions",
      "expected_value": "node-lts@20.11.0",
      "actual_value": "node-lts@20.9.0",
      "description": "Extension node-lts version mismatch: expected 20.11.0, found 20.9.0"
    }
  ]
}
```

#### POST /api/v1/drift/:id/remediate

Trigger remediation for a drift report.

**Request body:** `{ "mode": "MANUAL" }`

---

### Cost Tracking

#### GET /api/v1/costs

Fleet cost summary with optional time range.

**Query params:** `?from=2026-02-01&to=2026-02-17&period=MONTHLY`

**Response 200:**
```json
{
  "total_usd": 1245.50,
  "by_category": { "COMPUTE": 980.00, "STORAGE": 200.00, "NETWORK": 65.50 },
  "by_instance": [
    { "instance_id": "inst_01", "name": "prod-api", "total_usd": 450.00 }
  ]
}
```

#### GET /api/v1/budgets

List all budgets.

#### POST /api/v1/budgets

Create a budget.

**Request body:**
```json
{
  "name": "Production Budget",
  "limit_usd": 1000.00,
  "period": "MONTHLY",
  "alert_thresholds": [50, 80, 100],
  "team_id": "team_01"
}
```

#### GET /api/v1/costs/recommendations

List optimization recommendations ordered by potential savings.

**Response 200:**
```json
{
  "recommendations": [
    {
      "id": "rec_01",
      "instance_id": "inst_01",
      "action": "SUSPEND_IDLE",
      "potential_savings_usd": 45.00,
      "description": "Instance has been idle for 48h.",
      "confidence": 92
    }
  ],
  "total_potential_savings_usd": 185.00
}
```

---

### Security Dashboard

#### GET /api/v1/security

Fleet security summary.

**Response 200:**
```json
{
  "fleet_score": 76,
  "total_open_cves": 12,
  "critical_cves": 2,
  "secrets_detected": 3,
  "instances": [
    { "instance_id": "inst_01", "score": 40, "grade": "F", "open_cves": 8, "critical_cves": 2 }
  ]
}
```

#### GET /api/v1/security/instances/:id/sbom

Get the SBOM for an instance.

**Query params:** `?format=CycloneDX`

**Response 200:**
```json
{
  "id": "sbom_01",
  "format": "CycloneDX",
  "spec_version": "1.4",
  "generated_at": "2026-02-17T00:00:00Z",
  "components": [
    { "name": "lodash", "version": "4.17.21", "package_url": "pkg:npm/lodash@4.17.21", "license": "MIT" }
  ]
}
```

#### GET /api/v1/security/cves

List CVEs. Filterable by severity and status.

**Query params:** `?severity=CRITICAL&status=OPEN&instanceId=inst_01`

#### PATCH /api/v1/security/cves/:id

Update CVE status.

**Request body:** `{ "status": "ACCEPTED_RISK", "note": "Risk accepted by security team" }`

#### GET /api/v1/security/secrets

List secret findings.

**Query params:** `?status=DETECTED&type=API_KEY&instanceId=inst_01`

#### PATCH /api/v1/security/secrets/:id

Update secret finding status.

**Request body:** `{ "status": "ROTATED" }`
