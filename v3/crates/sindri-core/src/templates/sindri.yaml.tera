# =============================================================================
# Sindri Configuration
# =============================================================================
# Documentation: https://sindri.dev/docs
# Schema: https://sindri.dev/schemas/sindri.schema.json
#
# Quick commands:
#   sindri config validate  - Validate this configuration
#   sindri deploy           - Deploy environment
#   sindri connect          - Connect to running environment
#   sindri status           - Show deployment status
# =============================================================================

version: "3.0"
name: {{ name }}

# =============================================================================
# DEPLOYMENT
# =============================================================================
deployment:
  provider: {{ provider }}

  # ═══════════════════════════════════════════════════════════════════════════
  # IMAGE DEPLOYMENT OPTIONS
  # ═══════════════════════════════════════════════════════════════════════════
  #
  # Choose ONE of the following image configuration methods:
  #
  # ───────────────────────────────────────────────────────────────────────────
  # Option 1: Pre-built image (legacy - simple)
  # ───────────────────────────────────────────────────────────────────────────
  # image: ghcr.io/myorg/app:v1.0.0
  #
  # ───────────────────────────────────────────────────────────────────────────
  # Option 2: Semantic versioning with verification (recommended)
  # ───────────────────────────────────────────────────────────────────────────
  # image_config:
  #   registry: ghcr.io/myorg/app
  #   version: "^1.0.0"           # Resolves to latest 1.x.x
  #   verify_signature: true      # Verify with cosign
  #   verify_provenance: true     # Verify SLSA provenance
  #   pull_policy: IfNotPresent   # Always | IfNotPresent | Never
  #
  # ───────────────────────────────────────────────────────────────────────────
  # Option 3: Explicit tag override
  # ───────────────────────────────────────────────────────────────────────────
  # image_config:
  #   registry: ghcr.io/myorg/app
  #   tag_override: v1.0.0-beta.1
  #
  # ───────────────────────────────────────────────────────────────────────────
  # Option 4: Immutable digest (production)
  # ───────────────────────────────────────────────────────────────────────────
  # image_config:
  #   registry: ghcr.io/myorg/app
  #   digest: sha256:abc123...
  #
  # ───────────────────────────────────────────────────────────────────────────
  # Option 5: Build from local Dockerfile
  # ───────────────────────────────────────────────────────────────────────────
  # (Leave image/image_config commented out)
  # Sindri will build from ./Dockerfile if no image specified
  # Supported providers: docker, fly, devpod, e2b
  #
  # ═══════════════════════════════════════════════════════════════════════════
  # IMAGE RESOLUTION PRIORITY ORDER
  # ═══════════════════════════════════════════════════════════════════════════
  # 1. image_config.digest      (immutable - highest priority)
  # 2. image_config.tag_override (explicit tag)
  # 3. image_config.version     (semver constraint resolution)
  # 4. image                    (legacy full reference)
  # 5. Local Dockerfile         (provider-dependent build)
  # 6. Default: ghcr.io/pacphi/sindri:latest
  # ═══════════════════════════════════════════════════════════════════════════
{% if provider == "kubernetes" %}
  # Kubernetes does NOT support building from Dockerfile.
  # You MUST specify a pre-built image for this provider.
  image: ghcr.io/pacphi/sindri:latest
{% elif provider == "fly" %}
  # Fly.io: Pre-built image (~30s deploy) or Dockerfile build (2-5 min)
  image: ghcr.io/pacphi/sindri:latest
{% elif provider == "e2b" %}
  # E2B requires Dockerfile build (pre-built images not supported)
  # Leave image commented out - E2B builds template from Dockerfile
{% else %}
  image: ghcr.io/pacphi/sindri:latest
{% endif %}

  resources:
    memory: 4GB     # 1GB, 2GB, 4GB, 8GB, 16GB
    cpus: 2         # 1-8
{% if provider_supports_gpu %}

    # GPU support (optional - uncomment to enable)
    # gpu:
    #   enabled: true
    #   type: nvidia          # nvidia | amd
    #   count: 1              # Number of GPUs (1-8)
    #   tier: gpu-medium      # gpu-small, gpu-medium, gpu-large, gpu-xlarge
    #   memory: 16GB          # Minimum GPU memory required
{% if provider == "fly" %}
    #
    # GPU machines available in limited regions:
    #   - ord (Chicago, US Central)
    #   - sjc (San Jose, US West)
    # Other regions may not have GPU capacity.
{% elif provider == "devpod" %}
    #
    # GPU tier to cloud instance mappings:
    #   AWS:
    #     gpu-small:  g4dn.xlarge (T4, 16GB)
    #     gpu-medium: g5.2xlarge (A10G, 24GB)
    #     gpu-large:  g5.4xlarge (A10G, 24GB)
    #     gpu-xlarge: p4d.24xlarge (A100 x8, 640GB)
    #   GCP:
    #     gpu-small:  n1-standard-4 + nvidia-tesla-t4
    #     gpu-medium: n1-standard-8 + nvidia-tesla-a10g
    #     gpu-large:  g2-standard-16 + nvidia-l4
    #     gpu-xlarge: a2-megagpu-16g + nvidia-a100-80gb x8
    #   Azure:
    #     gpu-small:  Standard_NC4as_T4_v3
    #     gpu-medium: Standard_NC8as_T4_v3
    #     gpu-large:  Standard_NC24ads_A100_v4
    #     gpu-xlarge: Standard_ND96amsr_A100_v4
{% endif %}
{% endif %}

  volumes:
    workspace:
      path: /alt/home/developer/workspace
      size: 10GB

# =============================================================================
# EXTENSIONS
# =============================================================================
extensions:
  profile: {{ profile }}

  # Available profiles:
{% for p in profiles %}
  #   {{ p.name }} - {{ p.description }}
{% endfor %}

  # Or use explicit extension list (mutually exclusive with profile):
  # active:
  #   - nodejs
  #   - python
  #   - docker

  # Add extensions on top of a profile:
  # additional:
  #   - ollama
  #   - monitoring

  autoInstall: true    # Auto-install on startup (set false for CI/testing)

# =============================================================================
# SECRETS
# =============================================================================
# Secrets are injected as environment variables into the container.
# Source types: env (from host), file (mount as file), vault (HashiCorp Vault)
secrets:
  # SSH public key for VS Code Remote/SSH access
  - name: AUTHORIZED_KEYS
    source: env
    fromFile: ~/.ssh/id_ed25519.pub

  # API keys from environment variables
  - name: ANTHROPIC_API_KEY
    source: env

  - name: GITHUB_TOKEN
    source: env

  # Example: required secret (deployment fails if missing)
  # - name: DATABASE_URL
  #   source: env
  #   required: true

  # Example: mount a file into the container
  # - name: SSL_CERT
  #   source: file
  #   path: ./certs/server.crt
  #   mountPath: /etc/ssl/certs/server.crt
  #   permissions: "0644"

  # Example: HashiCorp Vault integration
  # - name: DB_PASSWORD
  #   source: vault
  #   vaultPath: secret/data/myapp/database
  #   vaultKey: password
  #   vaultMount: secret
{% if provider == "fly" %}

# ---------------------------------------------------------------------------
# Fly.io Secrets Reference
# ---------------------------------------------------------------------------
# Set secrets via: flyctl secrets set KEY=value -a {{ name }}
#
# Core secrets:
#   AUTHORIZED_KEYS      - SSH public key for key-based auth (recommended)
#                          flyctl secrets set "AUTHORIZED_KEYS=$(cat ~/.ssh/id_ed25519.pub)" -a {{ name }}
#   ANTHROPIC_API_KEY    - Claude API authentication
#   GITHUB_TOKEN         - GitHub authentication for git operations
#   GIT_USER_NAME        - Git config user.name
#   GIT_USER_EMAIL       - Git config user.email
#   GITHUB_USER          - GitHub username for gh CLI
#
# AI tools (optional):
#   OPENROUTER_API_KEY   - Multi-provider AI gateway (cost-optimized models)
#   GOOGLE_GEMINI_API_KEY - Google Gemini API (free-tier access)
#   PERPLEXITY_API_KEY   - Perplexity API (research assistant)
#   XAI_API_KEY          - xAI Grok SDK authentication
#
# Package registries (recommended):
#   NPM_TOKEN            - npm auth (bypasses rate limits, required for reliable installs)
#   PYPI_TOKEN           - PyPI package publishing
{% endif %}

# =============================================================================
# PROVIDER CONFIGURATION
# =============================================================================
providers:
{% if provider == "fly" %}
  # ---------------------------------------------------------------------------
  # Fly.io Configuration
  # ---------------------------------------------------------------------------
  fly:
    region: {{ default_region }}              # sjc, ord, iad, ams, nrt, fra, syd
    autoStopMachines: true     # Suspend when idle (cost savings)
    autoStartMachines: true    # Resume on connection
    cpuKind: shared            # shared | performance (dedicated)
    sshPort: 10022             # External SSH port

    # organization: my-org     # Fly.io organization (optional)
    # highAvailability: false  # Enable multiple machines

  # ---------------------------------------------------------------------------
  # VS Code Remote SSH Setup
  # ---------------------------------------------------------------------------
  # 1. Ensure AUTHORIZED_KEYS secret is set above
  # 2. Deploy: sindri deploy
  # 3. Add to ~/.ssh/config:
  #
  #    Host sindri-{{ name }}
  #        HostName {{ name }}.fly.dev
  #        Port 10022
  #        User developer
  #        StrictHostKeyChecking no
  #
  # 4. Connect in VS Code: Cmd+Shift+P -> "Remote-SSH: Connect to Host"
  # 5. Or via terminal: ssh sindri-{{ name }}

  # ---------------------------------------------------------------------------
  # Fly.io Development Workflow
  # ---------------------------------------------------------------------------
  # 1. Deploy: sindri deploy
  # 2. Set secrets:
  #    flyctl secrets set "AUTHORIZED_KEYS=$(cat ~/.ssh/id_ed25519.pub)" -a {{ name }}
  #    flyctl secrets set ANTHROPIC_API_KEY=sk-ant-... -a {{ name }}
  #    flyctl secrets set GITHUB_TOKEN=ghp_... -a {{ name }}
  # 3. Connect: ssh developer@{{ name }}.fly.dev -p 10022
  #    Alternative: flyctl ssh console -a {{ name }}
  # 4. Work: All files in $HOME (/alt/home/developer) are persistent
  #    Projects go in $WORKSPACE (/alt/home/developer/workspace)
  # 5. Idle: VM automatically suspends after inactivity
  # 6. Resume: VM starts automatically on next connection
{% elif provider == "docker" %}
  # ---------------------------------------------------------------------------
  # Docker Compose Configuration
  # ---------------------------------------------------------------------------
  docker:
    network: bridge            # bridge | host | none
    restart: unless-stopped    # no | always | on-failure | unless-stopped
    # runtime: auto            # auto | runc | sysbox-runc
    # privileged: false        # Only for legacy DinD (security risk)

    # Additional port mappings
    # ports:
    #   - "3000:3000"          # Web app
    #   - "5432:5432"          # PostgreSQL

    # Extra hosts (useful for local development)
    # extraHosts:
    #   - "host.docker.internal:host-gateway"
{% if provider_supports_dind %}

    # ---------------------------------------------------------------------------
    # Docker-in-Docker (DinD) Configuration
    # ---------------------------------------------------------------------------
    # Enable running Docker commands inside Sindri containers.
    # Required for running containers, building images, or docker-compose inside Sindri.
    #
    # dind:
    #   enabled: true
    #   mode: auto             # Detection order: sysbox > privileged > socket
    #   storageDriver: auto    # auto | overlay2 | fuse-overlayfs | vfs
    #   storageSize: 20GB      # Size limit for Docker storage (vfs mode)
    #
    # DinD Mode Details:
    #
    #   sysbox (Recommended)
    #     - Secure isolation using Sysbox runtime
    #     - Requires host setup: ./scripts/setup-sysbox-host.sh
    #     - Best security, uses overlay2 storage driver
    #     - Full Docker functionality without security compromise
    #
    #   privileged (Legacy)
    #     - Works everywhere but less secure
    #     - Uses vfs storage driver (slower, more disk space)
    #     - Container has elevated privileges on host
    #     - Only use when sysbox is unavailable
    #
    #   socket (Simple)
    #     - Shares host Docker daemon via socket mount
    #     - Simple setup, no additional privileges
    #     - Inner containers run on host Docker (not isolated)
    #     - Good for CI/CD pipelines that just need docker commands
    #
    #   auto (Default)
    #     - Auto-detect: sysbox if available, else check privileged flag
    #     - Falls back to socket if neither available
{% endif %}
{% elif provider == "kubernetes" %}
  # ---------------------------------------------------------------------------
  # Kubernetes Configuration
  # ---------------------------------------------------------------------------
  kubernetes:
    namespace: {{ default_region }}
    # storageClass: standard   # Storage class for PVCs

    # Ingress configuration (optional)
    # ingress:
    #   enabled: true
    #   hostname: sindri.example.com

  # ---------------------------------------------------------------------------
  # Local Kubernetes Clusters (kind/k3d)
  # ---------------------------------------------------------------------------
  # For local development, use kind or k3d to create a K8s cluster:
  #
  # kind (Kubernetes IN Docker) - Full K8s
  #   Context: kind-<cluster-name>
  #   Install: brew install kind (macOS) or direct download
  #   Create: sindri k8s create --provider kind --name my-cluster
  #   Image loading: kind load docker-image <image> --name <cluster>
  #
  # k3d (K3s in Docker) - Lightweight K8s
  #   Context: k3d-<cluster-name>
  #   Install: brew install k3d (macOS) or curl install script
  #   Create: sindri k8s create --provider k3d --name my-cluster
  #   Image loading: k3d image import <image> --cluster <cluster>
  #   Built-in registry: k3d cluster create --registry-create
  #
  # Commands:
  #   sindri k8s create --provider kind --name my-cluster
  #   sindri k8s create --provider k3d --name my-cluster
  #   sindri k8s list    # Show all kind and k3d clusters
  #   sindri k8s destroy --name my-cluster
  #
  # k8s:
  #   provider: kind              # kind | k3d
  #   clusterName: {{ name }}
  #   version: v1.31.0           # Kubernetes version
  #   nodes: 1                   # 1 = single node, >1 = multi-node
  #
  #   # k3d-specific: local registry
  #   # k3d:
  #   #   registry:
  #   #     enabled: true
  #   #     name: k3d-registry
  #   #     port: 5000
  #   #
  #   # Usage:
  #   #   docker tag myimage localhost:5000/myimage
  #   #   docker push localhost:5000/myimage
  #   #   # Images available in cluster at k3d-registry:5000/myimage
{% elif provider == "devpod" %}
  # ---------------------------------------------------------------------------
  # DevPod Configuration
  # ---------------------------------------------------------------------------
  # DevPod supports multiple backend providers. Specify your target.
  devpod:
    type: docker               # aws | gcp | azure | digitalocean | kubernetes | ssh | docker

    # For cloud providers, specify a build repository for image push:
    # buildRepository: ghcr.io/myorg/sindri

    # AWS EC2 options (when type: aws)
    # aws:
    #   region: {{ default_region }}
    #   instanceType: c5.xlarge
    #   diskSize: 40            # GB
    #   useSpot: false          # Use spot instances for cost savings
    #   # subnetId: subnet-xxx
    #   # securityGroupId: sg-xxx

    # GCP Compute Engine options (when type: gcp)
    # gcp:
    #   project: my-gcp-project
    #   zone: us-central1-a
    #   machineType: e2-standard-4
    #   diskSize: 40
    #   diskType: pd-balanced   # pd-standard | pd-balanced | pd-ssd

    # Azure VM options (when type: azure)
    # azure:
    #   subscription: xxx-xxx-xxx
    #   resourceGroup: devpod-resources
    #   location: eastus
    #   vmSize: Standard_D4s_v3
    #   diskSize: 40

    # DigitalOcean Droplet options (when type: digitalocean)
    # digitalocean:
    #   region: nyc3
    #   size: s-4vcpu-8gb

    # Kubernetes pod options (when type: kubernetes)
    # kubernetes:
    #   namespace: devpod
    #   # storageClass: standard
    #   # context: my-cluster
    #   #
    #   # Local K8s cluster detection:
    #   #   - kind: context pattern "kind-<cluster-name>"
    #   #   - k3d: context pattern "k3d-<cluster-name>"
    #   #
    #   # Benefits of local cluster:
    #   #   - No registry push needed (image loaded directly)
    #   #   - Faster iteration cycle
    #   #   - No registry auth required

    # SSH to existing machine (when type: ssh)
    # ssh:
    #   host: 192.168.1.100
    #   user: developer
    #   port: 22
    #   keyPath: ~/.ssh/id_rsa

  # ---------------------------------------------------------------------------
  # Docker Registry Authentication
  # ---------------------------------------------------------------------------
  # For cloud deployments (AWS, GCP, Azure), you need registry auth:
  #
  # ghcr.io (GitHub):
  #   Set GITHUB_TOKEN environment variable
  #   Or: echo $GITHUB_TOKEN | docker login ghcr.io -u <username> --password-stdin
  #
  # AWS ECR:
  #   aws ecr get-login-password --region <region> | docker login ...
  #
  # GCP GCR/Artifact Registry:
  #   Set GOOGLE_APPLICATION_CREDENTIALS
  #   Or: gcloud auth configure-docker
  #
  # Generic:
  #   Set DOCKER_USERNAME and DOCKER_PASSWORD
  #   Or add to .env/.env.local
{% elif provider == "e2b" %}
  # ---------------------------------------------------------------------------
  # E2B Cloud Sandbox Configuration
  # ---------------------------------------------------------------------------
  # E2B provides instant cloud sandboxes optimized for AI agents.
  # Required: E2B_API_KEY from https://e2b.dev/dashboard
  e2b:
    timeout: 300               # Sandbox timeout in seconds (default: 5 min)
    autoPause: true            # Pause instead of kill on timeout
    autoResume: true           # Auto-resume paused sandbox on connect
    internetAccess: true       # Enable outbound internet

    # Template configuration
    # templateAlias: my-template
    # reuseTemplate: true
    # buildOnDeploy: false     # Force rebuild on every deploy

    # Network restrictions
    # allowedDomains: []       # Whitelist (empty = all allowed)
    # blockedDomains: []       # Blacklist

    # publicAccess: false      # Allow public URL access to services
    # team: my-team            # E2B team for billing

    # Custom metadata
    # metadata:
    #   project: my-project
    #   environment: development

  # ---------------------------------------------------------------------------
  # E2B Limitations
  # ---------------------------------------------------------------------------
  # - No GPU support (use fly/devpod/docker for GPU workloads)
  # - No SSH access (uses WebSocket PTY terminal instead)
  # - Max 24hr active session, 30-day pause retention
  # - ~150ms startup time (after template is built)
  #
  # Pause/Resume workflow:
  #   sindri pause    - Preserves memory + filesystem state
  #   sindri connect  - Auto-resumes if autoResume: true

  # ---------------------------------------------------------------------------
  # E2B Cost Optimization Tips
  # ---------------------------------------------------------------------------
  # - Use short timeouts (300s) for interactive development
  # - Enable autoPause to avoid paying for idle time
  # - Consider timeout: 60 for automated testing
  # - Set buildOnDeploy: false to reuse templates (faster startup)
  # - Paused sandboxes: no compute cost (only snapshot storage)
  # - Data expires 30 days from initial sandbox creation
{% endif %}
