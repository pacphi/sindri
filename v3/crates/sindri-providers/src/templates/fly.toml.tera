# fly.toml configuration for Sindri
# Generated by sindri CLI - do not edit manually

app = "{{ name }}"
primary_region = "{{ env_vars.fly_region }}"

# Build configuration
# Context must be repo root because Dockerfile COPY commands use v3/docker/* paths
# Note: dockerfile path is relative to working directory, not context
[build]
  dockerfile = "{{ env_vars.dockerfile_path }}"
{% if env_vars.repo_dir %}
  # Build from source inside Docker (Linux environment)
  [build.args]
    BUILD_FROM_SOURCE = "true"
    SINDRI_VERSION = "{{ env_vars.sindri_version }}"
    SINDRI_SOURCE_REF = "{{ env_vars.sindri_version }}"
{% endif %}

[env]
  DEV_USER = "developer"
  SSH_PORT = "2222"
  TZ = "UTC"
  INSTALL_PROFILE = "{{ profile }}"
{% if custom_extensions %}
  CUSTOM_EXTENSIONS = "{{ custom_extensions }}"
{% endif %}
{% if additional_extensions %}
  ADDITIONAL_EXTENSIONS = "{{ additional_extensions }}"
{% endif %}
  INIT_WORKSPACE = "true"
  SKIP_AUTO_INSTALL = "{{ skip_auto_install }}"
{% if ci_mode %}
  CI_MODE = "true"
{% endif %}
{% for key, value in env_vars %}
  {{ key }} = "{{ value }}"
{% endfor %}

[[mounts]]
  source = "home_data"
  destination = "/alt/home/developer"
  initial_size = "{{ env_vars.fly_volume_size }}gb"
  snapshot_retention = 7
  auto_extend_size_threshold = 80
  auto_extend_size_increment = "5GB"
  auto_extend_size_limit = "250GB"

{% if ci_mode %}
# CI Mode: No services exposed (use flyctl ssh console for access)
services = []

{% else %}
# SSH service configuration
[[services]]
  protocol = "tcp"
  internal_port = 2222
  auto_stop_machines = "{{ env_vars.fly_auto_stop_mode }}"
  auto_start_machines = {{ env_vars.fly_auto_start }}
  min_machines_running = 0

  [[services.ports]]
    port = {{ env_vars.fly_ssh_port }}

  [[services.tcp_checks]]
    interval = "30s"
    timeout = "10s"
    grace_period = "30s"

{% endif %}
{% if gpu_enabled %}
# GPU-enabled VM configuration
[vm]
  guest_type = "{{ env_vars.fly_gpu_guest_type }}"
  cpus = {{ env_vars.fly_gpu_cpus }}
  memory = "{{ env_vars.fly_gpu_memory }}mb"

{% else %}
# VM sizing configuration
[vm]
  cpu_kind = "{{ env_vars.fly_cpu_kind }}"
  cpus = {{ cpus }}
  memory = "{{ env_vars.fly_memory_mb }}mb"
  swap_size_mb = {{ env_vars.fly_swap_mb }}

{% endif %}
[deploy]
  strategy = "rolling"

{% if not ci_mode %}
# Health checks
[checks]
  [checks.ssh]
    type = "tcp"
    port = 2222
    interval = "30s"
    timeout = "10s"
    grace_period = "30s"
{% endif %}
