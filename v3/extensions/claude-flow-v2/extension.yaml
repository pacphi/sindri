---
metadata:
  name: claude-flow-v2
  version: 2.7.47
  description: AI-powered multi-agent orchestration system for Claude Code workflows (v2 stable)
  category: ai
  author: ruvnet
  license: MIT
  homepage: https://github.com/ruvnet/claude-flow
  dependencies:
    - nodejs

requirements:
  domains:
    - registry.npmjs.org
    - github.com
  diskSpace: 100
  memory: 128
  installTime: 60

install:
  method: mise
  mise:
    configFile: mise.toml

configure:
  templates:
    - source: claude-flow.aliases
      destination: ~/.bashrc
      mode: append
    - source: commands/ms.md
      destination: ~/.claude/commands/ms.md
      mode: overwrite
      description: MetaSaver intelligent command router for complexity-based task routing
  environment:
    - key: PATH
      value: "$HOME/.local/bin:$PATH"
      scope: bashrc

validate:
  commands:
    - name: claude-flow
      expectedPattern: "claude-flow v\\d+\\.\\d+\\.\\d+(-[a-z]+(\\. \\d+)?)?"

remove:
  mise:
    removeConfig: true
    tools:
      - "npm:claude-flow"
  paths:
    - ~/.claude/commands/ms.md
  confirmation: true

upgrade:
  strategy: reinstall

capabilities:
  # Project initialization capability
  project-init:
    enabled: true
    priority: 20
    commands:
      - command: "claude-flow init --force"
        description: "Initialize Claude Code flow with memory and context"
        requiresAuth: anthropic
      - command: "bash scripts/init-agentdb.sh"
        description: "Initialize AgentDB backend for enhanced memory"
        conditional: true

    state-markers:
      - path: ".claude"
        type: directory
        description: "Claude Code configuration directory"
      - path: "CLAUDE.md"
        type: file
        description: "Claude Code project context file"

    validation:
      command: "claude-flow --version"
      expectedPattern: "claude-flow v\\d+\\.\\d+\\.\\d+(-[a-z]+(\\. \\d+)?)?"

  # Authentication requirements
  auth:
    provider: anthropic
    required: false
    methods:
      - api-key
      - cli-auth
    envVars:
      - ANTHROPIC_API_KEY
    validator:
      command: "claude --version"
      expectedExitCode: 0
    features:
      - name: agent-spawn
        requiresApiKey: false
        description: "CLI-based agent spawning"
      - name: api-integration
        requiresApiKey: true
        description: "Direct API features"

  # Lifecycle hooks
  hooks:
    pre-install:
      command: "echo 'Preparing claude-flow installation...'"
      description: "Pre-installation checks"
    post-install:
      command: "claude-flow --version"
      description: "Verify claude-flow installation"
    pre-project-init:
      command: "echo 'Initializing claude-flow project context...'"
      description: "Pre-initialization setup"
    post-project-init:
      command: "true"
      description: "Post-initialization cleanup"

  # MCP server registration
  mcp:
    enabled: true
    server:
      command: "npx"
      args:
        - "-y"
        - "@claude-flow/cli@alpha"
        - "mcp"
        - "start"
      env:
        CLAUDE_FLOW_MCP_MODE: "1"
    tools:
      - name: "claude-flow-agent-spawn"
        description: "Spawn specialized AI agents"
      - name: "claude-flow-memory-store"
        description: "Store patterns in unified memory"
      - name: "claude-flow-swarm-coordinate"
        description: "Coordinate multi-agent swarms"

  # Collision handling for cloned projects
  collision-handling:
    enabled: true

    conflict-rules:
      - path: "CLAUDE.md"
        type: file
        on-conflict:
          action: append
          separator: "\n\n---\n\n"

      # Critical JSON files - must merge
      - path: ".claude/mcp.json"
        type: file
        on-conflict:
          action: merge-json

      - path: ".claude/settings.json"
        type: file
        on-conflict:
          action: merge-json

      # Directories - merge strategy
      - path: ".claude"
        type: directory
        on-conflict:
          action: merge
          backup: false # No backup needed, merge is safe

      - path: ".claude-flow"
        type: directory
        on-conflict:
          action: merge
          backup: false

    version-markers:
      # V2 marker: memory.db file
      - path: ".claude/memory.db"
        type: file
        version: "v2"
        detection:
          method: file-exists

      # V2 marker: memory subdirectory
      - path: ".claude/memory"
        type: directory
        version: "v2"
        detection:
          method: directory-exists

      # V3 marker (for cross-version detection)
      - path: ".claude/config.json"
        type: file
        version: "v3"
        detection:
          method: content-match
          patterns:
            - '"swarm"'
            - '"sona"'
          match-any: true

      # Unknown marker
      - path: ".claude"
        type: directory
        version: "unknown"
        detection:
          method: directory-exists
          exclude-if:
            - ".claude/memory.db"
            - ".claude/memory"
            - ".claude/config.json"

    scenarios:
      # Scenario 1: Same version already installed
      - name: "same-version-v2"
        detected-version: "v2"
        installing-version: "2.7.47"
        action: skip
        message: |
          ✓ Claude Flow V2 is already initialized

          To force a fresh V2 installation, run:
            claude-flow init --force

      # Scenario 2: V3 detected when installing V2 (downgrade)
      - name: "v3-to-v2-downgrade"
        detected-version: "v3"
        installing-version: "2.7.47"
        action: stop
        message: |
          ⚠️  Claude Flow V3 installation detected

          Your project has Claude Flow V3 installed.
          Downgrading to V2 is not recommended and may cause data loss.

          If you really want V2:
            1. Backup .claude directory
            2. Remove claude-flow-v3: extension-manager remove claude-flow-v3
            3. Install claude-flow-v2: extension-manager install claude-flow-v2
            4. Run: claude-flow init --force

          Skipping automatic initialization to prevent conflicts.

      # Scenario 3: Unknown .claude directory
      - name: "unknown-origin"
        detected-version: "unknown"
        installing-version: "2.7.47"
        action: stop
        message: |
          ⚠️  Existing .claude directory detected (unknown origin)

          Your project has a .claude directory that doesn't match
          known Claude Flow V2 or V3 structure.

          Options:
            1. Backup and reinitialize: mv .claude .claude.backup && claude-flow init --force
            2. Skip initialization: (do nothing)

          Skipping automatic initialization for safety.

bom:
  tools:
    - name: claude-flow
      version: dynamic
      source: npm
      type: cli-tool
      license: MIT
      homepage: https://github.com/ruvnet/claude-flow
      purl: pkg:npm/claude-flow
