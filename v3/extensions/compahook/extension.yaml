metadata:
  name: compahook
  version: 1.0.0
  description: Persistent memory layer for Claude Code's /compact command
  category: claude
  tags:
    - claude-code
    - hooks
    - compaction
    - memory
    - context
  dependencies:
    - nodejs
  profiles:
    - anthropic-dev

install:
  method: mise
  mise:
    configFile: mise.toml
    reshimAfterInstall: true

configure:
  environment:
    - key: COMPAHOOK_DEBUG
      value: "0"
      scope: bashrc
      description: "Enable debug logging (set to 1 for debug output)"

validate:
  commands:
    - name: compahook
      versionFlag: stats
      expectedPattern: "compahook"
      description: "Verify compahook installation"

capabilities:
  hooks:
    post-install:
      command: "compahook install"
      description: "Register compahook hooks in ~/.claude/settings.json"

requirements:
  domains:
    - registry.npmjs.org
  diskSpace: 50
  memory: 128
  installTime: 60
  installTimeout: 300
  validationTimeout: 15

bom:
  tools:
    - name: node
      version: dynamic
      source: mise
      type: runtime
      license: MIT
    - name: compahook
      version: "1.1.2"
      source: npm
      type: cli-tool
      license: MIT
      homepage: https://www.npmjs.com/package/compahook

docs:
  title: "compahook"
  overview: |
    Persistent memory layer for Claude Code's /compact command. Improves post-compact context quality by extracting, scoring, and re-injecting high-signal information that would otherwise be lost during conversation compaction.
  last-updated: "2026-02-09"
  features:
    - "Collector (PostToolUse) - Logs file edits and commands to working-state.jsonl"
    - "Extractor (PreCompact) - Reads transcript, scores items, writes compact-context.json"
    - "Restorer (SessionStart) - Reads compact-context.json, injects structured markdown via additionalContext"
    - "Zero Dependencies - Uses only Node.js built-in modules"
    - "Security hardened - Path traversal protection, symlink attack prevention, stdin DoS protection"
  usage:
    - section: "View Project Metrics"
      examples:
        - code: |
            # Current project metrics
            compahook stats

            # Live monitoring (refreshes every 2s)
            compahook watch

            # Custom refresh interval (5 seconds)
            compahook watch 5000
    - section: "Global Metrics"
      examples:
        - description: "Monitor compahook performance across all projects"
          code: |
            # Global metrics
            compahook stats --global

            # Live global monitoring
            compahook watch --global
    - section: "Reset Metrics"
      examples:
        - code: |
            # Clear metrics for current project
            compahook reset-metrics
    - section: "Debug Mode"
      examples:
        - code: |
            export COMPAHOOK_DEBUG=1
  notes: |
    The post-install hook automatically runs `compahook install` to register three hooks
    in ~/.claude/settings.json: compahook-collect (PostToolUse), compahook-extract (PreCompact),
    and compahook-restore (SessionStart). No manual configuration is required.

    Per-project memory is stored in <project>/.claude/memory/. Add .claude/memory/ to your .gitignore.

    Configuration can be customized via <project>/.claude/memory/config.json for settings like
    maxContextSize, maxItems, scoring weights, and decay parameters.
